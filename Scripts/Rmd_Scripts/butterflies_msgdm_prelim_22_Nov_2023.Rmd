---
title: "R Notebook"
output: html_notebook
---




## setup
```{r}
#The here package enables easy file referencing by using the top-level directory of a file project to easily build file paths."
#about here package: https://here.r-lib.org/articles/here.html
#https://github.com/jennybc/here_here
#by running this before loading the package, we can get a message to check the correct root is being used
here::i_am("Scripts/Rmd_Scripts/butterflies_msgdm_prelim_22_Nov_2023.Rmd")

library(tidyverse)
library(zetadiv)
library(bipartite)
library(mgcv)
library(caret)
library(dismo)

library(here)

library(conflicted)


#library(foreach)
#library(doParallel)
#library(doSNOW)


#(cl = makeCluster(parallel::detectCores()-2, type = "SOCK")) # Initialize all cores except for two
#registerDoSNOW(cl)


conflicts_prefer(dplyr::select)
```


# load data
```{r}
data.5.year <- readRDS(here("./Data/Processed_Data/butterfly.msgdm.data.5.years.rds"))

str(data.5.year, max.level = 1)

sites <- data.5.year$sites

species <-  data.5.year$species


site.by.species <- data.5.year$site.by.species
  
site.by.env <- data.5.year$site.by.env

site.by.xy <- data.5.year$site.by.xy
  
#just to check commit and push work
```
```{r}
table(sites$country)
```




#site by species matrices for wider countryside and habitat specialists separately

```{r}

#modify species.no to use to select sites in site by species matrix
species$species.no <- paste("species", species$species.no, sep = "_")


# obtain vectors of species.no for habitat specialists and wider countryside species
habitat.specialists <- species[species$strategy == "Habitat specialist",]$species.no
wider.countryside.spp <- species[species$strategy == "Wider countryside sp",]$species.no

#subset site by species by species for habitat specialists and wider countrysides
site.by.species.hs <- select(site.by.species, habitat.specialists)
site.by.species.wc <- select(site.by.species, wider.countryside.spp)

#check if this results in some sites with no species in each case

#are there any sites with no habitat specialists or wider countryside species?

print("number of sites with no habitat specialists")
nrow(site.by.species.hs[rowSums(site.by.species.hs)==0, ])

print("number of sites with no wider countryside species")
nrow(site.by.species.wc[rowSums(site.by.species.wc)==0, ])


```


## Examine zeta decline Simpson whole dataset orders 1 to 60
```{r}

# Start the clock!
ptm <- proc.time()
set.seed(1) 
zeta.dec0 <- Zeta.decline.mc(site.by.species, orders = 1:60, sam = 10000, normalize = "Simpson")
# Stop the clock
proc.time() - ptm

#zeta.dec0 <- readRDS(here("./Output/zeta_dec_10000_Simpson_all_data_orders_60.rds"))

#zeta.dec
#Plot.zeta.decline(zeta.dec0 )
summary(zeta.dec0$zeta.pl)
summary(zeta.dec0$zeta.exp)
zeta.dec0$aic

write_rds(zeta.dec0, file = here("./Output/zeta_dec_10000_Simpson_all_data_orders_60.rds"))
```
## Examine zeta decline Simpson whole dataset orders 1 to 10
```{r}

# Start the clock!
ptm <- proc.time()
set.seed(1) 
zeta.dec1 <- Zeta.decline.mc(site.by.species, orders = 1:10, sam = 10000, normalize = "Simpson")
# Stop the clock
proc.time() - ptm



#zeta.dec1
summary(zeta.dec1$zeta.pl)
summary(zeta.dec1$zeta.exp)
zeta.dec1$aic

write_rds(zeta.dec1, file = here("./Output/zeta_dec_10000_Simpson_all_data_orders_12.rds"))
```



## Examine zeta decline Sorensen whole dataset orders 1 to 60
```{r}

# Start the clock!
ptm <- proc.time()
set.seed(1) 
zeta.dec0 <- Zeta.decline.mc(site.by.species, orders = 1:60, sam = 10000, normalize = "Sorensen")
# Stop the clock
proc.time() - ptm


summary(zeta.dec0$zeta.pl)
summary(zeta.dec0$zeta.exp)
zeta.dec0$aic

write_rds(zeta.dec0, file = here("./Output/zeta_dec_10000_Sorensen_all_data_orders_60.rds"))
```

## Examine zeta decline Sorensen whole dataset orders 1 to 10
```{r}

# Start the clock!
ptm <- proc.time()
set.seed(1) 
zeta.dec0 <- Zeta.decline.mc(site.by.species, orders = 1:10, sam = 10000, normalize = "Sorensen")
# Stop the clock
proc.time() - ptm


summary(zeta.dec0$zeta.pl)
summary(zeta.dec0$zeta.exp)
zeta.dec0$aic

write_rds(zeta.dec0, file = here("./Output/zeta_dec_10000_Sorensen_all_data_orders_10.rds"))
```


## Examine zeta decline whole dataset orders 1-200
```{r}
zeta.dec1 <- Zeta.decline.ex(site.by.species, orders = 1:200)
#zeta.dec1
summary(zeta.dec1$zeta.pl)
summary(zeta.dec1$zeta.exp)
zeta.dec1$aic

write_rds(zeta.dec1, file = here("./Output/zeta_dec_ex_raw_orders_200.rds"))




```



## Examine zeta decline whole dataset ordrs 1-10 and 1-60
```{r}
zeta.dec1 <- Zeta.decline.ex(site.by.species, orders = 1:10)
#zeta.dec1
summary(zeta.dec1$zeta.pl)
summary(zeta.dec1$zeta.exp)
zeta.dec1$aic

write_rds(zeta.dec1, file = here("./Output/zeta_dec_ex_raw_orders_10.rds"))


zeta.dec1 <- Zeta.decline.ex(site.by.species, orders = 1:60)

summary(zeta.dec1$zeta.pl)
summary(zeta.dec1$zeta.exp)
zeta.dec1$aic
write_rds(zeta.dec1, file = here("./Output/zeta_dec_ex_raw_orders_60.rds"))
```


## Examine zeta decline Simpson WC orders 1 to 60
```{r}

# Start the clock!
ptm <- proc.time()
set.seed(1) 
zeta.dec0 <- Zeta.decline.mc(site.by.species.wc, orders = 1:60, sam = 10000, normalize = "Simpson")
# Stop the clock
proc.time() - ptm


summary(zeta.dec0$zeta.pl)
summary(zeta.dec0$zeta.exp)
zeta.dec0$aic

write_rds(zeta.dec0, file = here("./Output/zeta_dec_10000_Simpson_WC_orders_60.rds"))
```

## Examine zeta decline Simpson WC orders 1 to 10
```{r}

# Start the clock!
ptm <- proc.time()
set.seed(1) 
zeta.dec0 <- Zeta.decline.mc(site.by.species.wc, orders = 1:10, sam = 10000, normalize = "Simpson")
# Stop the clock
proc.time() - ptm


summary(zeta.dec0$zeta.pl)
summary(zeta.dec0$zeta.exp)
zeta.dec0$aic

write_rds(zeta.dec0, file = here("./Output/zeta_dec_10000_Simpson_WC_orders_10.rds"))
```
## Examine zeta decline Sorensen WC orders 1 to 60
```{r}

# Start the clock!
ptm <- proc.time()
set.seed(1) 
zeta.dec0 <- Zeta.decline.mc(site.by.species.wc, orders = 1:60, sam = 10000, normalize = "Sorensen")
# Stop the clock
proc.time() - ptm


summary(zeta.dec0$zeta.pl)
summary(zeta.dec0$zeta.exp)
zeta.dec0$aic

write_rds(zeta.dec0, file = here("./Output/zeta_dec_10000_Sorensen_WC_orders_60.rds"))
```


## Examine zeta decline WC
```{r}
zeta.dec1 <- Zeta.decline.ex(site.by.species.wc, orders = 1:200)
#zeta.dec1
summary(zeta.dec1$zeta.pl)
summary(zeta.dec1$zeta.exp)
zeta.dec1$aic

write_rds(zeta.dec1, file = here("./Output/zeta_dec_WC_ex_raw_orders_200.rds"))
```


## Examine zeta decline WC 1:60
```{r}
zeta.dec1 <- Zeta.decline.ex(site.by.species.wc, orders = 1:60)
#zeta.dec1
summary(zeta.dec1$zeta.pl)
summary(zeta.dec1$zeta.exp)
zeta.dec1$aic

write_rds(zeta.dec1, file = here("./Output/zeta_dec_WC_ex_raw_orders_60.rds"))
```

## Examine zeta decline WC 1:10
```{r}
zeta.dec1 <- Zeta.decline.ex(site.by.species.wc, orders = 1:10)
#zeta.dec1
summary(zeta.dec1$zeta.pl)
summary(zeta.dec1$zeta.exp)
zeta.dec1$aic

write_rds(zeta.dec1, file = here("./Output/zeta_dec_WC_ex_raw_orders_10.rds"))
```






## Examine zeta decline Simpson HS orders 1 to 10 (computational issues at higher orders)
```{r}

# Start the clock!
ptm <- proc.time()
set.seed(1) 
zeta.dec0 <- Zeta.decline.mc(site.by.species.hs, orders = 1:10, sam = 10000, normalize = "Simpson")
# Stop the clock
proc.time() - ptm


summary(zeta.dec0$zeta.pl)
summary(zeta.dec0$zeta.exp)
zeta.dec0$aic

write_rds(zeta.dec0, file = here("./Output/zeta_dec_10000_Simpson_HS_orders_10.rds"))
```

## Examine zeta decline HS
```{r}
zeta.dec1 <- Zeta.decline.ex(site.by.species.hs, orders = 1:200)
#zeta.dec1
summary(zeta.dec1$zeta.pl)
summary(zeta.dec1$zeta.exp)
zeta.dec1$aic

write_rds(zeta.dec1, file = here("./Output/zeta_dec_HS_ex_raw_orders_200.rds"))
```
## Examine zeta decline HS
```{r}
zeta.dec1 <- Zeta.decline.ex(site.by.species.hs, orders = 1:10)
#zeta.dec1
summary(zeta.dec1$zeta.pl)
summary(zeta.dec1$zeta.exp)
zeta.dec1$aic

write_rds(zeta.dec1, file = here("./Output/zeta_dec_WC_ex_raw_orders_10.rds"))
```




## Examine decay in zeta diversity with distance all data
```{r warning = FALSE}
set.seed(1) 
zeta.ddecays <- Zeta.ddecays(xy = site.by.xy, site.by.species, sam = 10000 , orders = 2:100,
plot = TRUE, confint.level = 0.95)


write_rds(zeta.ddecays, file = here("./Output/zeta_decay_orders_100_san_10000.rds"))
```





```{r warning = FALSE}
set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 2,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 2, 
                                    reg.type="gam") # a generalised additive model is used 418 insteadn of the default linear model

set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 3,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 3, 
                                    reg.type="gam") # a generalised additive model is used 418 instead of the default linear model

set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 4,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 4, 
                                    reg.type="gam") # a generalised additive model is used 418 instead of the default linear model

set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 5,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 5, 
                                    reg.type="gam") # a generalised additive model is used 418 instead of the default linear model

set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 8,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 8, 
                                    reg.type="gam") # a generalised additive model is used 418 instead of the default linear model
```

```{r warning = FALSE}
set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 15,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 15, 
                                    reg.type="gam") # a generalised additive model is used 418 insteadn of the default linear model

set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 20,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 20, 
                                    reg.type="gam") # a generalised additive model is used 418 instead of the default linear model

set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 40,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 40, 
                                    reg.type="gam") # a generalised additive model is used 418 instead of the default linear model

set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 60,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 60, 
                                    reg.type="gam") # a generalised additive model is used 418 instead of the default linear model

set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 100,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 100, 
                                    reg.type="gam") # a generalised additive model is used 418 instead of the default linear model
```

## Examine decay in zeta diversity with distance WC
```{r warning = FALSE}

zeta.ddecays <- Zeta.ddecays(xy = site.by.xy, site.by.species.wc, sam = 10000 , orders = 2:100,
plot = TRUE, confint.level = 0.95)


write_rds(zeta.ddecays, file = here("./Output/zeta_decay_WC_orders_100_san_10000.rds"))
```


## Examine decay in zeta diversity with distance HS
```{r warning = FALSE}

zeta.ddecays <- Zeta.ddecays(xy = site.by.xy, site.by.species.hs, sam = 10000 , orders = 2:10,
plot = TRUE, confint.level = 0.95)


write_rds(zeta.ddecays, file = here("./Output/zeta_decay_HS_orders_100_san_10000.rds"))
```



```{r}
cor(site.by.env)

t1 <- cor(site.by.env)

write.csv(t1, file = here("./Output/env_var_pearson_cor.csv"))

```



```{r}
cor(site.by.env, method = "spearman")

t1 <- cor(site.by.env, method = "spearman")

write.csv(t1, file = here("./Output/env_var_spearman_cor.csv"))
```







## GAM 

```{r warning = FALSE}



site.by.env.and.richness <- cbind(site.by.env, rowSums(site.by.species))


site.by.env.and.richness <- site.by.env.and.richness %>%
rename(species.richness = 'rowSums(site.by.species)')

gam1 <- gam(species.richness ~ s(mean.ann.temp, k = 10) + s(mean.ann.rain, k = 10) + s(topgraphic.wetness, k = 10) + s(ph, k = 10) + s(total.n, k = 10) + s(tree.density, k = 10) + s(log10.pesticide.risk, k = 10) + s(log10.humans, k = 10),  data = site.by.env.and.richness, method= "REML")

summary(gam1)

par(mfrow = c(2,4))
plot.gam(gam1)
dev.off()  


pdf(here("./Output/gam.pdf"))
par(mfrow = c(2,4))
plot.gam(gam1)
dev.off()

#gam from zetadiv, Code from Latombe et al. 2018

#including log observations 



zeta.gam <- Zeta.msgdm(site.by.species, site.by.env,xy=NULL,order=1,sam=50000,normalize = FALSE,reg.type = "gam",family=gaussian(),control=glm.control(maxit = 500),empty.row = "remove",kn=10)



summary(zeta.gam$model)

```




## GAM wider countryside

```{r warning = FALSE}



site.by.env.and.richness.wc <- cbind(site.by.env, rowSums(site.by.species.wc))


site.by.env.and.richness.wc <- site.by.env.and.richness.wc %>%
rename(species.richness = 'rowSums(site.by.species.wc)')

gam1 <- gam(species.richness ~ s(mean.ann.temp, k = 10) + s(mean.ann.rain, k = 10) + s(topgraphic.wetness, k = 10) + s(ph, k = 10) + s(total.n, k = 10) + s(tree.density, k = 10) + s(log10.pesticide.risk, k = 10) + s(log10.humans, k = 10),  data = site.by.env.and.richness.wc, method= "REML")

summary(gam1)

par(mfrow = c(2,4))
plot.gam(gam1)
dev.off()  


pdf(here("./Output/gam.wc.pdf"))
par(mfrow = c(2,4))
plot.gam(gam1)
dev.off()

#gam from zetadiv, Code from Latombe et al. 2018

#including log observations 

# 
# 
# zeta.gam <- Zeta.msgdm(site.by.species, site.by.env,xy=NULL,order=1,sam=50000,normalize = FALSE,reg.type = "gam",family=gaussian(),control=glm.control(maxit = 500),empty.row = "remove",kn=10)
# 
# 
# 
# summary(zeta.gam$model)

```
## GAM habitat specialists

```{r warning = FALSE}



site.by.env.and.richness.hs <- cbind(site.by.env, rowSums(site.by.species.hs))


site.by.env.and.richness.hs <- site.by.env.and.richness.hs %>%
rename(species.richness = 'rowSums(site.by.species.hs)')

gam1 <- gam(species.richness ~ s(mean.ann.temp, k = 10) + s(mean.ann.rain, k = 10) + s(topgraphic.wetness, k = 10) + s(ph, k = 10) + s(total.n, k = 10) + s(tree.density, k = 10) + s(log10.pesticide.risk, k = 10) + s(log10.humans, k = 10),  data = site.by.env.and.richness.hs, method= "REML")

summary(gam1)

par(mfrow = c(2,4))
plot.gam(gam1)
dev.off()  


pdf(here("./Output/gam.hs.pdf"))
par(mfrow = c(2,4))
plot.gam(gam1)
dev.off()

#gam from zetadiv, Code from Latombe et al. 2018

#including log observations 

# 
# 
# zeta.gam <- Zeta.msgdm(site.by.species, site.by.env,xy=NULL,order=1,sam=50000,normalize = FALSE,reg.type = "gam",family=gaussian(),control=glm.control(maxit = 500),empty.row = "remove",kn=10)
# 
# 
# 
# summary(zeta.gam$model)

```




#try k-fold cross validation
```{r}

site.by.species.a <- site.by.species[1:100,]
site.by.env.a <- site.by.env[1:100,]
site.by.xy.a <- site.by.xy[1:100,]
```

```{r}
flds <- createFolds(site.by.species.test, k = 10, list = TRUE, returnTrain = FALSE)
names(flds)[1] <- "train"
```

```{r}
folds <- cut(seq(1,nrow(site.by.species.test)),breaks=10,labels=FALSE)
```

# work in progress: will adapt from example below

```{r}
#https://stats.stackexchange.com/questions/61090/how-to-split-a-data-set-to-do-10-fold-cross-validation


folds2 <-folds[sample(nrow(site.by.species.test))]

#Perform 10 fold cross validation
for(i in 1:10){
    #Segement your data by fold using the which() function 
    testIndexes <- which(folds2==i,arr.ind=TRUE)
    
    test.site.by.species <- site.by.species.a[testIndexes, ]
    train.site.by.species <- site.by.species.a[-testIndexes, ]
    
    test.site.by.env <- site.by.env.a[testIndexes, ]
    train.site.by.env <- site.by.env.a[-testIndexes, ]
    
    test.site.by.xy <- site.by.xy.a[testIndexes, ]
    train.site.by.xy <- site.by.xy.a[-testIndexes, ]
    #Use the test and train data partitions however you desire...

   msgdm_i <-  Zeta.msgdm(xy = train.site.by.xy, data.spec = train.site.by.species,     data.env = data.env = train.site.by.env,  order=2, sam=500,
  reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE) 
    

}




```

# example from Predict.msgdm
```{r}
utils::data(bird.spec.fine)
xy.bird <- bird.spec.fine[1:500,1:2]
data.spec.bird <- bird.spec.fine[1:500,3:192]
utils::data(bird.env.fine)
data.env.bird1 <- bird.env.fine[1:500,3:9] ##training data
data.env.bird2 <- bird.env.fine[501:604,3:9] ##data to predict on

zeta.ispline <- Zeta.msgdm(data.spec.bird, data.env.bird1, sam = 100, order = 3,
                           reg.type = "ispline", normalize = "Jaccard")

# apply ispline transformation to env data
data.env.bird.splines <- Ispline(data.env.bird2)
newdata <- data.frame(matrix(NA,100,ncol(data.env.bird.splines$splines)))
names(newdata) <- names(data.env.bird.splines$splines)




for(z in 1:100){
  # resample sets of n sites 100 times
  samp <- sample(1:104, 4, replace = FALSE)
  # first (inside) apply() gets  pairwise distance between all pairs of sites for each ispline
  # second (outside) apply gets means
  newdata[z,] <- apply(apply(data.env.bird.splines$splines[samp,], 2, stats::dist),
                       2, mean) 
}


##rescale the data like during MS-GDM
newdata <- newdata/matrix(rep(zeta.ispline$rescale.factor,100),
                          100,length(zeta.ispline$rescale.factor),byrow=TRUE)
new.zeta.ispline <- Predict.msgdm(model.msgdm = zeta.ispline$model, reg.type = "ispline",
                                  newdata = newdata)

check <- data.env.bird.splines$splines[samp,]

```





## Predict zeta values for test data

```{r}
Predict.msgdm(model.msgdm, reg.type, newdata, type = "response")
```





```{r}


msgdm.2 <-  Zeta.msgdm(xy = site.by.xy[ flds[[2]], ], data.spec = site.by.species[ flds[[2]], ], data.env = site.by.env[ flds[[2]], ],  order=2, sam=500,
  reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE) 



```


## Main MSGDMs
```{r warning = FALSE}

Sys.time()
set.seed(1)
msgdm.2 <-  Zeta.msgdm(xy = site.by.xy, data.spec = site.by.species, data.env = site.by.env,  order=2, sam=50000,
  reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE) 
Sys.time()

set.seed(1)
msgdm.3 <-  Zeta.msgdm(xy = site.by.xy, data.spec = site.by.species, data.env = site.by.env,  order=3, sam=50000,
  reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE) 

set.seed(1)
msgdm.6 <-  Zeta.msgdm(xy = site.by.xy, data.spec = site.by.species, data.env = site.by.env,  order=6, sam=50000,
  reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE) 

set.seed(1)
msgdm.10 <-  Zeta.msgdm(xy = site.by.xy, data.spec = site.by.species, data.env = site.by.env,  order=10, sam=50000,
 reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE)

set.seed(1)
msgdm.15 <-  Zeta.msgdm(xy = site.by.xy, data.spec = site.by.species, data.env = site.by.env,  order=15, sam=50000,
 reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE) 

set.seed(1)
msgdm.20 <-  Zeta.msgdm(xy = site.by.xy, data.spec = site.by.species, data.env = site.by.env,  order=20, sam=50000,
 reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE) 


output0<- list(msgdm.2, msgdm.3, msgdm.6, msgdm.10, msgdm.15, msgdm.20)


write_rds(output0, file = here("./Output/butterfly_ispline_simpson_50000.rds"))
```

```{r}

main.msgdms <- readRDS(here("./Output/butterfly_ispline_simpson_50000.rds"))

names(main.msgdms)

str(main.msgdms, max.level = 1)


msgdm.2<- main.msgdms[[1]]

msgdm.3<- main.msgdms[[2]]

msgdm.6<- main.msgdms[[3]]

msgdm.10<- main.msgdms[[4]]

msgdm.15<- main.msgdms[[5]]

msgdm.20 <- main.msgdms[[6]]




```


```{r}

print("ZETA 2")
summary(msgdm.2$model)


print("ZETA 3")
summary(msgdm.3$model)




print("ZETA 6")
summary(msgdm.6$model)



print("ZETA 10")
summary(msgdm.10$model)


print("ZETA 15")
summary(msgdm.10$model)



print("ZETA 20")
summary(msgdm.20$model)


```


```{r}


print("variance explained zeta 2")
with(summary(msgdm.2$model), 1 - deviance/null.deviance)

print("variance explained zeta 3")
with(summary(msgdm.3$model), 1 - deviance/null.deviance)


print("variance explained zeta 6")
with(summary(msgdm.6$model), 1 - deviance/null.deviance)


print("variance explained zeta 10")
with(summary(msgdm.10$model), 1 - deviance/null.deviance)


print("variance explained zeta 15")
with(summary(msgdm.15$model), 1 - deviance/null.deviance)

print("variance explained zeta 20")
with(summary(msgdm.20$model), 1 - deviance/null.deviance)
```




```{r  warning = FALSE}
Plot.ispline(msgdm = msgdm.2, data.env = site.by.env, distance = TRUE,  legend = TRUE)
Plot.ispline(msgdm = msgdm.3, data.env = site.by.env, distance = TRUE,  legend = TRUE)
Plot.ispline(msgdm = msgdm.6, data.env = site.by.env, distance = TRUE,  legend = TRUE)
Plot.ispline(msgdm = msgdm.10, data.env = site.by.env, distance = TRUE,  legend = TRUE)
Plot.ispline(msgdm = msgdm.15, data.env = site.by.env, distance = TRUE,  legend = TRUE)
Plot.ispline(msgdm = msgdm.20, data.env = site.by.env, distance = TRUE,  legend = TRUE)

# pdf(here("./Output/msgdm.10.pdf")) 
# Plot.ispline(msgdm = msgdm.10, data.env = site.by.env, distance = TRUE,  legend = TRUE)
# dev.off() 
#The default value for mar is c(5.1, 4.1, 4.1, 2.1).



    
    
```
```{r}
# 
# pdf(here("./Output/msgdm.all.pdf"))
# 
# par(mfrow = c(2, 3))
# 
# Plot.ispline(msgdm = msgdm.2, data.env = site.by.env, distance = TRUE,  legend = FALSE)
# Plot.ispline(msgdm = msgdm.3, data.env = site.by.env, distance = TRUE,  legend = FALSE)
# Plot.ispline(msgdm = msgdm.4, data.env = site.by.env, distance = TRUE,  legend = FALSE)
# Plot.ispline(msgdm = msgdm.6, data.env = site.by.env, distance = TRUE,  legend = FALSE)
# Plot.ispline(msgdm = msgdm.8, data.env = site.by.env, distance = TRUE,  legend = FALSE)
# Plot.ispline(msgdm = msgdm.10, data.env = site.by.env, distance = TRUE,  legend = FALSE)
# 
# dev.off()
```



```{r  warning = FALSE}



set.seed(1) 
zeta.varpart.2 <- Zeta.varpart(msgdm.mod = msgdm.2, method.glm = "glm.fit2", cons.inter = -1) 

set.seed(1) 
zeta.varpart.3 <- Zeta.varpart(msgdm.mod = msgdm.3, method.glm = "glm.fit2", cons.inter = -1) 

set.seed(1) 
zeta.varpart.6 <- Zeta.varpart(msgdm.mod = msgdm.6, method.glm = "glm.fit2", cons.inter = -1) 


set.seed(1) 
zeta.varpart.10 <- Zeta.varpart(msgdm.mod = msgdm.10, method.glm = "glm.fit2", cons.inter = -1) 


set.seed(1) 
zeta.varpart.15 <- Zeta.varpart(msgdm.mod = msgdm.15, method.glm = "glm.fit2", cons.inter = -1) 


set.seed(1) 
zeta.varpart.20 <- Zeta.varpart(msgdm.mod = msgdm.20, method.glm = "glm.fit2", cons.inter = -1) 




```





```{r  warning = FALSE}


pie.neg(zeta.varpart.2[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9, main = "Zeta = 2")



pie.neg(zeta.varpart.3[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9, main = "Zeta = 3")



pie.neg(zeta.varpart.6[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9, main = "Zeta = 6")



pie.neg(zeta.varpart.10[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9, main = "Zeta = 10")

pie.neg(zeta.varpart.15[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9, main = "Zeta = 15")

pie.neg(zeta.varpart.20[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9, main = "Zeta = 20")
```


```{r}
site.by.species.hs<- dplyr::filter(site.by.species.hs, rowSums(site.by.species.hs) > 0)
site.by.xy.hs <- dplyr::filter(site.by.xy, rownames(site.by.xy) %in% rownames(site.by.species.hs))
site.by.env.hs <- dplyr::filter(site.by.env, rownames(site.by.env) %in% rownames(site.by.species.hs))

```



## HS MSGDMs
```{r warning = FALSE}

Sys.time()
set.seed(1)
msgdm.hs.2 <-  Zeta.msgdm(xy = site.by.xy.hs, data.spec = site.by.species.hs, data.env = site.by.env.hs,  order=2, sam=50000,
  reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE) 
Sys.time()

set.seed(1)
msgdm.hs.3 <-  Zeta.msgdm(xy = site.by.xy.hs, data.spec = site.by.species.hs, data.env = site.by.env.hs,  order=3, sam=50000,
  reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE) 

set.seed(1)
msgdm.hs.4 <-  Zeta.msgdm(xy = site.by.xy.hs, data.spec = site.by.species.hs, data.env = site.by.env.hs,  order=4, sam=50000,
  reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE) 


set.seed(1)
msgdm.hs.5 <-  Zeta.msgdm(xy = site.by.xy.hs, data.spec = site.by.species.hs, data.env = site.by.env.hs,  order=5, sam=50000,
  reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE) 


set.seed(1)
msgdm.hs.6 <-  Zeta.msgdm(xy = site.by.xy.hs, data.spec = site.by.species.hs, data.env = site.by.env.hs,  order=6, sam=50000,
  reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE) 


output1<- list(msgdm.hs.2, msgdm.hs.3, msgdm.hs.4, msgdm.hs.5, msgdm.hs.6)


write_rds(output1, file = here("./Output/butterfly_HS_ispline_simpson_50000.rds"))



```

```{r}
hs.msgdms <- readRDS(file = here("./Output/butterfly_HS_ispline_simpson_50000.rds"))


msgdm.hs.2<- hs.msgdms[[1]]

msgdm.hs.3<- hs.msgdms[[2]]

msgdm.hs.4<- hs.msgdms[[3]]

msgdm.hs.5<- hs.msgdms[[4]]

msgdm.hs.6<- hs.msgdms[[5]]

```





```{r}


print("variance explained zeta 2")
with(summary(msgdm.hs.2$model), 1 - deviance/null.deviance)

print("variance explained zeta 3")
with(summary(msgdm.hs.3$model), 1 - deviance/null.deviance)


print("variance explained zeta 4")
with(summary(msgdm.hs.4$model), 1 - deviance/null.deviance)


print("variance explained zeta 5")
with(summary(msgdm.hs.5$model), 1 - deviance/null.deviance)


print("variance explained zeta 6")
with(summary(msgdm.hs.6$model), 1 - deviance/null.deviance)
6
```

```{r}

print("ZETA 2")
summary(msgdm.hs.2$model)


print("ZETA 3")
summary(msgdm.hs.3$model)




print("ZETA 4")
summary(msgdm.hs.4$model)



print("ZETA 5")
summary(msgdm.hs.5$model)


print("ZETA 6")
summary(msgdm.hs.6$model)



```




```{r  warning = FALSE}
Plot.ispline(msgdm = msgdm.hs.2, data.env = site.by.env, distance = TRUE,  legend = TRUE)
Plot.ispline(msgdm = msgdm.hs.3, data.env = site.by.env, distance = TRUE,  legend = TRUE)
Plot.ispline(msgdm = msgdm.hs.4, data.env = site.by.env, distance = TRUE,  legend = TRUE)
Plot.ispline(msgdm = msgdm.hs.5, data.env = site.by.env, distance = TRUE,  legend = TRUE)
Plot.ispline(msgdm = msgdm.hs.6, data.env = site.by.env, distance = TRUE,  legend = TRUE)




```


```{r}
# 
# pdf(here("./Output/msgdm.all.pdf"))
# 
# par(mfrow = c(2, 3))
# 
# Plot.ispline(msgdm = msgdm.2, data.env = site.by.env, distance = TRUE,  legend = FALSE)
# Plot.ispline(msgdm = msgdm.3, data.env = site.by.env, distance = TRUE,  legend = FALSE)
# Plot.ispline(msgdm = msgdm.4, data.env = site.by.env, distance = TRUE,  legend = FALSE)
# Plot.ispline(msgdm = msgdm.6, data.env = site.by.env, distance = TRUE,  legend = FALSE)
# Plot.ispline(msgdm = msgdm.8, data.env = site.by.env, distance = TRUE,  legend = FALSE)
# Plot.ispline(msgdm = msgdm.10, data.env = site.by.env, distance = TRUE,  legend = FALSE)
# 
# dev.off()
```



```{r  warning = FALSE}



set.seed(1) 
zeta.varpart.2 <- Zeta.varpart(msgdm.mod = msgdm.hs.2, method.glm = "glm.fit2", cons.inter = -1) 

set.seed(1) 
zeta.varpart.3 <- Zeta.varpart(msgdm.mod = msgdm.hs.3, method.glm = "glm.fit2", cons.inter = -1) 

set.seed(1) 
zeta.varpart.4 <- Zeta.varpart(msgdm.mod = msgdm.hs.4, method.glm = "glm.fit2", cons.inter = -1) 


set.seed(1) 
zeta.varpart.5 <- Zeta.varpart(msgdm.mod = msgdm.hs.5, method.glm = "glm.fit2", cons.inter = -1) 


set.seed(1) 
zeta.varpart.6 <- Zeta.varpart(msgdm.mod = msgdm.hs.6, method.glm = "glm.fit2", cons.inter = -1) 




```





```{r  warning = FALSE}


pie.neg(zeta.varpart.2[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9, main = "Zeta = 2")



pie.neg(zeta.varpart.3[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9, main = "Zeta = 3")



pie.neg(zeta.varpart.4[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9, main = "Zeta = 4")



pie.neg(zeta.varpart.5[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9, main = "Zeta = 5")

pie.neg(zeta.varpart.6[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9, main = "Zeta = 6")

```



## WC MSGDMs

```{r}
site.by.species.wc<- dplyr::filter(site.by.species.wc, rowSums(site.by.species.wc) > 0)
site.by.xy.wc <- dplyr::filter(site.by.xy, rownames(site.by.xy) %in% rownames(site.by.species.wc))
site.by.env.wc <- dplyr::filter(site.by.env, rownames(site.by.env) %in% rownames(site.by.species.wc))

```




```{r warning = FALSE}

Sys.time()
set.seed(1)
msgdm.wc.2 <-  Zeta.msgdm(xy = site.by.xy.wc, data.spec = site.by.species.wc, data.env = site.by.env.wc,  order=2, sam=50000,
  reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE) 
Sys.time()

set.seed(1)
msgdm.wc.3 <-  Zeta.msgdm(xy = site.by.xy.wc, data.spec = site.by.species.wc, data.env = site.by.env.wc,  order=3, sam=50000,
  reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE) 

set.seed(1)
msgdm.wc.6 <-  Zeta.msgdm(xy = site.by.xy.wc, data.spec = site.by.species.wc, data.env = site.by.env.wc,  order=6, sam=50000,
  reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE) 

set.seed(1)
msgdm.wc.10 <-  Zeta.msgdm(xy = site.by.xy.wc, data.spec = site.by.species.wc, data.env = site.by.env.wc,  order=10, sam=50000,
 reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE)

set.seed(1)
msgdm.wc.15 <-  Zeta.msgdm(xy = site.by.xy.wc, data.spec = site.by.species.wc, data.env = site.by.env.wc,  order=15, sam=50000,
 reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE) 

set.seed(1)
msgdm.wc.20 <-  Zeta.msgdm(xy = site.by.xy.wc, data.spec = site.by.species.wc, data.env = site.by.env.wc,  order=20, sam=50000,
 reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE) 


output.wc<- list(msgdm.wc.2, msgdm.wc.3, msgdm.wc.6, msgdm.wc.10, msgdm.wc.15, msgdm.wc.20)


write_rds(output.wc, file = here("./Output/butterfly_ispline_simpson_WC_50000.rds"))
```
```{r}
wc.msgdms <- readRDS(here("./Output/butterfly_ispline_simpson_WC_50000.rds"))

names(wc.msgdms)

str(wc.msgdms, max.level = 1)


msgdm.wc.2<- wc.msgdms[[1]]

msgdm.wc.3<- wc.msgdms[[2]]

msgdm.wc.6<- wc.msgdms[[3]]

msgdm.wc.10<- wc.msgdms[[4]]

msgdm.wc.15<- wc.msgdms[[5]]

msgdm.wc.20 <- wc.msgdms[[6]]
```



```{r}

print("ZETA 2")
summary(msgdm.wc.2$model)


print("ZETA 3")
summary(msgdm.wc.3$model)




print("ZETA 6")
summary(msgdm.wc.6$model)



print("ZETA 10")
summary(msgdm.wc.10$model)


print("ZETA 15")
summary(msgdm.wc.15$model)



print("ZETA 20")
summary(msgdm.wc.20$model)


```
#sun,humidity, arable, coastal,   = 1 for all
#freshwater >=0.8 for all


```{r}


print("variance explained zeta 2")
with(summary(msgdm.wc.2$model), 1 - deviance/null.deviance)

print("variance explained zeta 3")
with(summary(msgdm.wc.3$model), 1 - deviance/null.deviance)


print("variance explained zeta 6")
with(summary(msgdm.wc.6$model), 1 - deviance/null.deviance)


print("variance explained zeta 10")
with(summary(msgdm.wc.10$model), 1 - deviance/null.deviance)


print("variance explained zeta 15")
with(summary(msgdm.wc.15$model), 1 - deviance/null.deviance)

print("variance explained zeta 20")
with(summary(msgdm.wc.20$model), 1 - deviance/null.deviance)
```




```{r  warning = FALSE}
Plot.ispline(msgdm = msgdm.wc.2, data.env = site.by.env, distance = TRUE,  legend = TRUE)
Plot.ispline(msgdm = msgdm.wc.3, data.env = site.by.env, distance = TRUE,  legend = TRUE)
Plot.ispline(msgdm = msgdm.wc.6, data.env = site.by.env, distance = TRUE,  legend = TRUE)
Plot.ispline(msgdm = msgdm.wc.10, data.env = site.by.env, distance = TRUE,  legend = TRUE)
Plot.ispline(msgdm = msgdm.wc.15, data.env = site.by.env, distance = TRUE,  legend = TRUE)
Plot.ispline(msgdm = msgdm.wc.20, data.env = site.by.env, distance = TRUE,  legend = TRUE)
# pdf(here("./Output/msgdm.wc.2.pdf")) 


```




```{r  warning = FALSE}



set.seed(1) 
zeta.varpart.2 <- Zeta.varpart(msgdm.mod = msgdm.wc.2, method.glm = "glm.fit2", cons.inter = -1) 

set.seed(1) 
zeta.varpart.3 <- Zeta.varpart(msgdm.mod = msgdm.wc.3, method.glm = "glm.fit2", cons.inter = -1) 

set.seed(1) 
zeta.varpart.6 <- Zeta.varpart(msgdm.mod = msgdm.wc.6, method.glm = "glm.fit2", cons.inter = -1) 


set.seed(1) 
zeta.varpart.10 <- Zeta.varpart(msgdm.mod = msgdm.wc.10, method.glm = "glm.fit2", cons.inter = -1) 


set.seed(1) 
zeta.varpart.15 <- Zeta.varpart(msgdm.mod = msgdm.wc.15, method.glm = "glm.fit2", cons.inter = -1) 


set.seed(1) 
zeta.varpart.20 <- Zeta.varpart(msgdm.mod = msgdm.wc.20, method.glm = "glm.fit2", cons.inter = -1) 




```





```{r  warning = FALSE}


pie.neg(zeta.varpart.2[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9, main = "Zeta = 2")



pie.neg(zeta.varpart.3[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9, main = "Zeta = 3")



pie.neg(zeta.varpart.6[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9, main = "Zeta = 6")



pie.neg(zeta.varpart.10[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9, main = "Zeta = 10")

pie.neg(zeta.varpart.15[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9, main = "Zeta = 15")

pie.neg(zeta.varpart.20[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9, main = "Zeta = 20")



```


























## check nestedness (Cang's code)


```{r}

jac <- vector()
sor <- vector()
sim <- vector()

for(i in 1:1000){
a <- sample(1:nrow(site.by.species),2)  
unio <- sum(ifelse((site.by.species[a[1],] == 1)|(site.by.species[a[2],]==1),1,0))
inter <- sum(site.by.species[a[1],]*site.by.species[a[2],])
minn <- min(sum(site.by.species[a[1],]),sum(site.by.species[a[2],]))
avg <- (sum(site.by.species[a[1],])+sum(site.by.species[a[2],]))/2
jac[i] <- inter/unio
sor[i] <- inter/avg
sim[i] <- inter/minn
}

boxplot(jac,sor,sim)
text("Jaccard","Sorensen","Simpson")

group <- c(rep("Jaccard", 1000), rep("Sorensen", 1000), rep("Simpson", 1000))
values <- as.numeric(c(jac, sor, sim))

boxdata <-data.frame(cbind(group, values))

boxdata$values <- as.numeric(boxdata$values)


boxplot( values ~ group, boxdata,                                # Color of boxplots
        col = "red")

m1 <- lm(values ~ group, boxdata[1001:3000,])

summary(m1)


```


# to do here: change so I can see wider countryside and habitat specialists with different colours/symbols

#contribution to variance of zeta 
```{r}
occ.df<- data.frame( cbind(colSums(site.by.species), colSums(site.by.species)/nrow(site.by.species)))

names(occ.df) <- c("occ", "p.occ")


# here I am trying to work out relative influence of different species on zeta diversity in relation to their occupancy
#commented out
#probability that species is shared between n sites in one sample but not shared between n sites in a second sample
occ.df <- occ.df %>% 
  mutate(rare.cat = case_when(p.occ < 0.2 ~ "1.rare",
                              p.occ >=0.2 & p.occ < 0.4 ~ "2.med.rare",
                              p.occ >=0.4 & p.occ < 0.6 ~ "3.med", 
                              p.occ >= 0.6 & p.occ < 0.8 ~ "4.med.common",
                              p.occ >= 0.8 ~ "5.common")#,
   # share2 = (p.occ1^2)*(1-p.occ1^2),
   #      share3 = (p.occ1^3)*(1-p.occ1^3),
    #     share4 = (p.occ1^4)*(1-p.occ1^4),
     #    share5 = (p.occ1^5)*(1-p.occ1^5),
  #       share10 = (p.occ1^10)*(1-p.occ1^10),
   #      share15 = (p.occ1^15)*(1-p.occ1^15),
  #       share20 = (p.occ1^20)*(1-p.occ1^20),
  #       share30 = (p.occ1^30)*(1-p.occ1^30),
  #       share50 = (p.occ1^50)*(1-p.occ1^50),
  #       share100 = (p.occ1^100)*(1-p.occ1^100),
  #       share200 = (p.occ1^200)*(1-p.occ1^200)
    )

hist(occ.df$p.occ, breaks = 20)


#share2 is the probability that species is shared between 2 sites in one sample but not shared between 2 sites in a second sample









```

```{r}
#I have tweaked the Zeta.order.ex function to include the varmat in the output

Zeta.order.ex.2 <- function (data.spec, order = 1, sd.correct = TRUE, rescale = FALSE, 
    empty.row = "empty") 
{
    if (empty.row == "remove") {
        data.spec <- data.spec[-which(rowSums(data.spec) == 0), 
            ]
    }
    if (order > dim(data.spec)[1]) {
        stop("Error: wrong value for \"order\": it must be equal or lower than the number of sites.")
    }
    data.spec <- as.matrix(data.spec)
    intercept_mat <- t(data.spec) %*% data.spec
    occupancy <- colSums(data.spec)
    p <- exp(lchoose(occupancy, order) - lchoose(nrow(data.spec), 
        order))
    zeta.val <- sum(p)
    varmat <- exp(lchoose(intercept_mat, order) - lchoose(nrow(data.spec), 
        order))
    for (j in 1:length(occupancy)) {
        for (k in 1:length(occupancy)) {
            varmat[j, k] <- varmat[j, k] - p[j] * p[k]
        }
    }
    if (sd.correct == TRUE) {
        zeta.val.sd <- sqrt(sum(varmat) * choose(nrow(data.spec), 
            order)/(choose(nrow(data.spec), order) - 1))
    }
    else {
        zeta.val.sd <- sqrt(sum(varmat))
    }
    zeta.order <- list()
    zeta.order$zeta.order <- order
    zeta.order$combinations <- choose(x <- dim(data.spec)[1], 
        order)
    zeta.order$zeta.val <- zeta.val
    zeta.order$zeta.val.sd <- zeta.val.sd
    zeta.order$varmat <- varmat
        return(zeta.order)
}


# a function to get the rowsums for each species in the varmat normalised by variance (sumo of whole matrix)and add to a dataframe which should already have the occupancy and possibly rowsums for other orders of zeta.
#normalised rowsums of the varmat are supposed to represent contribution of each species to variation in zeta diversity so that occupancy can be plotted against contribution to zeta for differnt orders of zeta

# arguments are: site by species matrix, zeta order, name for new variable of normalised rowsums of varmat for each species, data frame to merge the new variable into

get.var.share <- function(data.spec, ord, new.var.name, data.occ){
  
  z <-  Zeta.order.ex.2(data.spec, order = ord)


df1 <- data.frame(z$varmat)

df2<- data.frame(rowSums(df1)/sum(df1))

names(df2)<- new.var.name

out.df <- merge(data.occ, df2, by = "row.names")

out.df<- column_to_rownames(out.df, "Row.names")


return(out.df)

}

#occ.df1<- column_to_rownames(occ.df1, "Row.names")

```


```{r}
occ.df <- get.var.share(site.by.species, 2, "share.2", occ.df)


occ.df <- get.var.share(site.by.species, 3, "share.3", occ.df)
occ.df <- get.var.share(site.by.species, 4, "share.4", occ.df)
occ.df <- get.var.share(site.by.species, 5, "share.5", occ.df)
occ.df <- get.var.share(site.by.species, 6, "share.6", occ.df)
occ.df <- get.var.share(site.by.species, 7, "share.7", occ.df)
occ.df <- get.var.share(site.by.species, 8, "share.8", occ.df)
occ.df <- get.var.share(site.by.species, 9, "share.9", occ.df)
occ.df <- get.var.share(site.by.species, 10, "share.10", occ.df)
occ.df <- get.var.share(site.by.species, 15, "share.15", occ.df)
occ.df <- get.var.share(site.by.species, 20, "share.20", occ.df)
occ.df <- get.var.share(site.by.species, 30, "share.30", occ.df)
occ.df <- get.var.share(site.by.species, 40, "share.40", occ.df)
occ.df <- get.var.share(site.by.species, 50, "share.50", occ.df)
```



```{r}
plot(share.2~p.occ, data = occ.df)
plot(share.3~p.occ, data = occ.df)
plot(share.4~p.occ, data = occ.df)
plot(share.5~p.occ, data = occ.df)
plot(share.6~p.occ, data = occ.df)
plot(share.7~p.occ, data = occ.df)
plot(share.8~p.occ, data = occ.df)
plot(share.9~p.occ, data = occ.df)
plot(share.10~p.occ, data = occ.df)
plot(share.15~p.occ, data = occ.df)
plot(share.20~p.occ, data = occ.df)
plot(share.30~p.occ, data = occ.df)
plot(share.40~p.occ, data = occ.df)
plot(share.50~p.occ, data = occ.df)
```



#what I am trying to do here is obtain a measure of the influence of species in different rareness/commonness categories
```{r}
sum.influence <- occ.df %>%
  group_by(rare.cat) %>%
  summarise(category.influence.2 = sum(share.2),
            category.influence.3 = sum(share.3),
            category.influence.4 = sum(share.4),
            category.influence.5 = sum(share.5),
            category.influence.6 = sum(share.6),
            category.influence.7 = sum(share.7),
            category.influence.8 = sum(share.8),
            category.influence.9 = sum(share.9),
            category.influence.10 = sum(share.10),
            category.influence.15 = sum(share.15),
            category.influence.20 = sum(share.20),
            category.influence.30 = sum(share.30),
            category.influence.50 = sum(share.50)
           )


#the below is to normalise when columns do not already sum to one

#https://stackoverflow.com/questions/32276887/use-of-lapply-sd-in-data-table-r

#library(data.table)
#sum.influence2 <- data.table(sum.influence)

#make a vector of column names
#numeric_cols <- names(sum.influence)[sapply(sum.influence, is.numeric)]

#sum.influence2[, lapply(.SD, function(x) x/sum(x)), .SDcols = numeric_cols]

# if you want to update by reference
#sum.influence2[, (numeric_cols) := lapply(.SD, function(x) x/sum(x)), .SDcols = numeric_cols]

```


```{r}
plot(category.influence.2 ~ factor(rare.cat), data = data.frame(sum.influence), ylim = c(0, 1))


plot(category.influence.3 ~ factor(rare.cat), data = data.frame(sum.influence), ylim = c(0, 1))
plot(category.influence.4 ~ factor(rare.cat), data = data.frame(sum.influence), ylim = c(0, 1))
plot(category.influence.5 ~ factor(rare.cat), data = data.frame(sum.influence), ylim = c(0, 1))
plot(category.influence.6 ~ factor(rare.cat), data = data.frame(sum.influence), ylim = c(0, 1))
plot(category.influence.7 ~ factor(rare.cat), data = data.frame(sum.influence), ylim = c(0, 1))
plot(category.influence.8 ~ factor(rare.cat), data = data.frame(sum.influence), ylim = c(0, 1))
plot(category.influence.9 ~ factor(rare.cat), data = data.frame(sum.influence), ylim = c(0, 1))

plot(category.influence.10 ~ factor(rare.cat), data = data.frame(sum.influence), ylim = c(0, 1))
plot(category.influence.20 ~ factor(rare.cat), data = data.frame(sum.influence), ylim = c(0, 1))
plot(category.influence.30 ~ factor(rare.cat), data = data.frame(sum.influence), ylim = c(0, 1))
plot(category.influence.50 ~ factor(rare.cat), data = data.frame(sum.influence), ylim = c(0, 1))



```


```{r}

library(ggplot2)
# Set color by cond

sum.influence3 <- sum.influence %>%
  pivot_longer(!rare.cat, names_to = "zeta.order", values_to = "influence")


ggplot(sum.influence3, aes(x=rare.cat, y=influence)) + 
         geom_point(aes(color = factor(zeta.order), size = 2.5)) 

```



```{r}
Zeta.order.mc
```


## try to set up k-fold cross validation

## first an msgdm for training data
```{r}
set.seed(1)
sites$fold <- kfold(sites, k=5, by = sites$country)

#this shows that the "by"argument works as I understand. It stratifies the sampling
sum <- sites %>%
  group_by(fold, country) %>%
  summarise(n= n())

#subset to first fold
S.SP <- site.by.species[sites$fold != 1 ,]

S.XY <- site.by.xy[sites$fold != 1 ,]

S.E <- site.by.env[sites$fold != 1 ,]  



set.seed(1)
msgdm.train <-  Zeta.msgdm(S.XY, data.spec = S.SP, data.env = S.E,  order=2, sam=5000,
  reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE) 


```
## here i do an entire msgdm for the holdout data because I can't see another way to get the transformed values for distance

```{r}

S.SP1 <- site.by.species[sites$fold == 1 ,]

S.XY1 <- site.by.xy[sites$fold == 1 ,]

S.E1 <- site.by.env[sites$fold == 1 ,]  

z.test2 <- Zeta.msgdm(S.XY1, data.spec = S.SP1, data.env = S.E1,  order=2, sam=5000,
  reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE)

test.predictors<- z.test2$predictors



pred.zeta <- Predict.msgdm(model.msgdm = msgdm.test$model, reg.type = "ispline", newdata =  test.predictors)

m1 <- lm (z.test2$val ~ pred.zeta)

summary(m1)
anova(m1)
```
```{r}
Plot.ispline(msgdm = msgdm.train, data.env = S.E, distance = TRUE,  legend = TRUE)

Plot.ispline(msgdm = z.test2, data.env = S.E1, distance = TRUE,  legend = TRUE)

```
```{r}
#Zeta.varpart

print("ZETA 2")
summary(msgdm.train$model)
summary(z.test2$model)


```

```{r}

summary(msgdm.train$model)
summary(z.test2$model)
print("variance explained zeta 2")
with(summary(msgdm.train$model), 1 - deviance/null.deviance)
with(summary(z.test2$model), 1 - deviance/null.deviance)
```








```{r}
z2 <- Zeta.order.mc(data.spec = S.SP, xy = S.XY, sam = 2000, order = 2, normalize = "Simpson")
str(z2)
```

## we need to get the Isplines, which ar


## use ispline to transfrom data for input to predict



```{r}

```



