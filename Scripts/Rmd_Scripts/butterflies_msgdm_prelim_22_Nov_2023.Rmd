---
title: "R Notebook"
output: html_notebook
---




## setup
```{r}
#The here package enables easy file referencing by using the top-level directory of a file project to easily build file paths."
#about here package: https://here.r-lib.org/articles/here.html
#https://github.com/jennybc/here_here
#by running this before loading the package, we can get a message to check the correct root is being used
here::i_am("Scripts/Rmd_Scripts/butterflies_msgdm_prelim_22_Nov_2023.Rmd")

library(tidyverse)
library(zetadiv)
library(bipartite)
library(mgcv)
#library(caret)
library(dismo)

library(here)

library(conflicted)


#library(foreach)
#library(doParallel)
#library(doSNOW)


#(cl = makeCluster(parallel::detectCores()-2, type = "SOCK")) # Initialize all cores except for two
#registerDoSNOW(cl)



```


# load data
```{r}
data.5.year <- readRDS(here("./Data/Processed_Data/butterfly.msgdm.data.5.years.rds"))

str(data.5.year, max.level = 1)

sites <- data.5.year$sites

species <-  data.5.year$species


site.by.species <- data.5.year$site.by.species
  
site.by.env <- data.5.year$site.by.env

site.by.xy <- data.5.year$site.by.xy
  

```
#ite by species matrices for wider countryside and habitat specialists separately

```{r}

#modify species.no to use to select sites in site by species matrix
species$species.no <- paste("species", species$species.no, sep = "_")


# obtain vectors of species.no for habitat specialists and wider countryside species
habitat.specialists <- species[species$strategy == "Habitat specialist",]$species.no
wider.countryside.spp <- species[species$strategy == "Wider countryside sp",]$species.no

#subset site by species by species for habitat specialists and wider countrysides
site.by.species.hs <- select(site.by.species, habitat.specialists)
site.by.species.wc <- select(site.by.species, wider.countryside.spp)

#check if this results in some sites with no species in each case

#are there any sites with no habitat specialists or wider countryside species?

print("number of sites with no habitat specialists")
nrow(site.by.species.hs[rowSums(site.by.species.hs)==0, ])

print("number of sites with no wider countryside species")
nrow(site.by.species.wc[rowSums(site.by.species.wc)==0, ])


```



## Examine zeta decline whole datasets
```{r}
zeta.dec1 <- Zeta.decline.ex(site.by.species, orders = 1:200)
zeta.dec1
summary(zeta.dec1$zeta.pl)
summary(zeta.dec1$zeta.exp)
zeta.dec1$aic
```
## Examine zeta decline whole dataset just for lower orders
```{r}
zeta.dec1 <- Zeta.decline.ex(site.by.species, orders = 1:10)
zeta.dec1
summary(zeta.dec1$zeta.pl)
summary(zeta.dec1$zeta.exp)
zeta.dec1$aic
```
## Examine zeta decline WC
```{r}
zeta.dec1 <- Zeta.decline.ex(site.by.species.wc, orders = 1:200)
#zeta.dec1
summary(zeta.dec1$zeta.pl)
summary(zeta.dec1$zeta.exp)
zeta.dec1$aic
```


## Examine zeta decline HS
```{r}
zeta.dec1 <- Zeta.decline.ex(site.by.species.hs, orders = 1:200)
#zeta.dec1
summary(zeta.dec1$zeta.pl)
summary(zeta.dec1$zeta.exp)
zeta.dec1$aic
```
## Examine zeta decline HS
```{r}
zeta.dec1 <- Zeta.decline.ex(site.by.species.hs, orders = 1:10)
#zeta.dec1
summary(zeta.dec1$zeta.pl)
summary(zeta.dec1$zeta.exp)
zeta.dec1$aic
```




## Examine decay in zeta diversity with distance all data
```{r warning = FALSE}

zeta.ddecays <- Zeta.ddecays(xy = site.by.xy, site.by.species, sam = 500 , orders = 2:100,
plot = TRUE, confint.level = 0.95)

```





```{r warning = FALSE}
set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 2,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 2, 
                                    reg.type="gam") # a generalised additive model is used 418 insteadn of the default linear model

set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 3,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 3, 
                                    reg.type="gam") # a generalised additive model is used 418 instead of the default linear model

set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 4,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 4, 
                                    reg.type="gam") # a generalised additive model is used 418 instead of the default linear model

set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 5,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 5, 
                                    reg.type="gam") # a generalised additive model is used 418 instead of the default linear model

set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 8,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 8, 
                                    reg.type="gam") # a generalised additive model is used 418 instead of the default linear model
```

```{r warning = FALSE}
set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 15,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 15, 
                                    reg.type="gam") # a generalised additive model is used 418 insteadn of the default linear model

set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 20,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 20, 
                                    reg.type="gam") # a generalised additive model is used 418 instead of the default linear model

set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 40,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 40, 
                                    reg.type="gam") # a generalised additive model is used 418 instead of the default linear model

set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 60,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 60, 
                                    reg.type="gam") # a generalised additive model is used 418 instead of the default linear model

set.seed(1) 
zeta.ddecay.lm. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 100,  
                                   confint.level = 0.95) # the default regression is a linear model 
set.seed(1) 
zeta.ddecay.gam. <- Zeta.ddecay(xy = site.by.xy, data.spec = site.by.species, order = 100, 
                                    reg.type="gam") # a generalised additive model is used 418 instead of the default linear model
```

## Examine decay in zeta diversity with distance WC
```{r warning = FALSE}

zeta.ddecays <- Zeta.ddecays(xy = site.by.xy, site.by.species.wc, sam = 500 , orders = 2:100,
plot = TRUE, confint.level = 0.95)

```


## Examine decay in zeta diversity with distance HS
```{r warning = FALSE}

zeta.ddecays <- Zeta.ddecays(xy = site.by.xy, site.by.species.hs, sam = 500 , orders = 2:10,
plot = TRUE, confint.level = 0.95)

```



```{r}
cor(site.by.env)

```



```{r}
cor(site.by.env, method = "spearman")
```







## GAM 

```{r warning = FALSE}



site.by.env.and.richness <- cbind(site.by.env, rowSums(site.by.species))


site.by.env.and.richness <- site.by.env.and.richness %>%
rename(species.richness = 'rowSums(site.by.species)')

gam1 <- gam(species.richness ~ s(mean.ann.temp, k = 10) + s(mean.ann.rain, k = 10) + s(topgraphic.wetness, k = 10) + s(ph, k = 10) + s(total.n, k = 10) + s(tree.density, k = 10) + s(log10.pesticide.risk, k = 10) + s(log10.humans, k = 10),  data = site.by.env.and.richness, method= "REML")

summary(gam1)
plot.gam(gam1)

pdf(here("./Output/gam.pdf"))
plot.gam(gam1)
dev.off()

#gam from zetadiv, Code from Latombe et al. 2018

#including log observations 

print(Sys.time())
zeta.gam <- Zeta.msgdm(site.by.species, site.by.env,xy=NULL,order=1,sam=500,normalize = FALSE,reg.type = "gam",family=gaussian(),control=glm.control(maxit = 500),empty.row = "remove",kn=2)



summary(zeta.gam$model)

```

## try to set up k-fold cross validation

## first an msgdm for training data
```{r}
set.seed(1)
sites$fold <- kfold(sites, k=5, by = sites$country)

#this shows that the "by"argument works as I understand. It stratifies the sampling
sum <- sites %>%
  group_by(fold, country) %>%
  summarise(n= n())

#subset to first fold
S.SP <- site.by.species[sites$fold != 1 ,]

S.XY <- site.by.xy[sites$fold != 1 ,]

S.E <- site.by.env[sites$fold != 1 ,]  



set.seed(1)
msgdm.train <-  Zeta.msgdm(S.XY, data.spec = S.SP, data.env = S.E,  order=2, sam=5000,
  reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE) 


```
## here i do an entire msgdm for the holdout data because I can't see another way to get the transformed values for distance

```{r}

S.SP1 <- site.by.species[sites$fold == 1 ,]

S.XY1 <- site.by.xy[sites$fold == 1 ,]

S.E1 <- site.by.env[sites$fold == 1 ,]  

z.test2 <- Zeta.msgdm(S.XY1, data.spec = S.SP1, data.env = S.E1,  order=2, sam=5000,
  reg.type="ispline", normalize="Simpson", family=binomial(link="log"),cons.inter = -1, glm.init = TRUE)

test.predictors<- z.test2$predictors



pred.zeta <- Predict.msgdm(model.msgdm = msgdm.test$model, reg.type = "ispline", newdata =  test.predictors)

m1 <- lm (z.test2$val ~ pred.zeta)

summary(m1)
anova(m1)
```
```{r}
Plot.ispline(msgdm = msgdm.train, data.env = S.E, distance = TRUE,  legend = TRUE)

Plot.ispline(msgdm = z.test2, data.env = S.E1, distance = TRUE,  legend = TRUE)

```
```{r}
#Zeta.varpart

print("ZETA 2")
summary(msgdm.train$model)
summary(z.test2$model)


```

```{r}

summary(msgdm.train$model)
summary(z.test2$model)
print("variance explained zeta 2")
with(summary(msgdm.train$model), 1 - deviance/null.deviance)
with(summary(z.test2$model), 1 - deviance/null.deviance)
```








```{r}
z2 <- Zeta.order.mc(data.spec = S.SP, xy = S.XY, sam = 2000, order = 2, normalize = "Simpson")
str(z2)
```

## we need to get the Isplines, which ar


## use ispline to transfrom data for input to predict



```{r}

```


## Predict zeta values for test data

```{r}
Predict.msgdm(model.msgdm, reg.type, newdata, type = "response")
```


```{r warning = FALSE}




Sys.time()
set.seed(1)
msgdm.2 <-  Zeta.msgdm(xy = site.by.xy, data.spec = site.by.species, data.env = site.by.env,  order=2, sam=50000,
  reg.type="ispline", normalize="Sorensen", family=binomial(link="log"),cons.inter = -1) 
set.seed(1)
Sys.time()

msgdm.3 <-  Zeta.msgdm(xy = site.by.xy, data.spec = site.by.species, data.env = site.by.env,  order=3, sam=10000,
  reg.type="ispline", normalize="Sorensen", family=binomial(link="log"),cons.inter = -1) 
set.seed(1)
msgdm.4 <-  Zeta.msgdm(xy = site.by.xy, data.spec = site.by.species, data.env = site.by.env,  order=4, sam=10000,
  reg.type="ispline", normalize="Sorensen", family=binomial(link="log"),cons.inter = -1) 
set.seed(1)
msgdm.6 <-  Zeta.msgdm(xy = site.by.xy, data.spec = site.by.species, data.env = site.by.env,  order=6, sam=10000,
  reg.type="ispline", normalize="Sorensen", family=binomial(link="log"),cons.inter = -1) 
set.seed(1)
msgdm.8 <-  Zeta.msgdm(xy = site.by.xy, data.spec = site.by.species, data.env = site.by.env,  order=8, sam=10000,
 reg.type="ispline", normalize="Sorensen", family=binomial(link="log"),cons.inter = -1)
set.seed(1)
msgdm.10 <-  Zeta.msgdm(xy = site.by.xy, data.spec = site.by.species, data.env = site.by.env,  order=10, sam=10000,
 reg.type="ispline", normalize="Sorensen", family=binomial(link="log"),cons.inter = -1) 



```



```{r}

print("ZETA 2")
summary(msgdm.2$model)


print("ZETA 3")
summary(msgdm.3$model)



print("ZETA 4")
summary(msgdm.4$model)



print("ZETA 6")
summary(msgdm.6$model)



print("ZETA 8")
summary(msgdm.8$model)



print("ZETA 10")
summary(msgdm.10$model)

```
#sun,humidity, arable, coastal,   = 1 for all
#freshwater >=0.8 for all

```{r}

#output0<- list(msgdm.2, msgdm.3, msgdm.4, msgdm.6, msgdm.8, msgdm.10)


#write_rds(output0, file = here("./Output/butterfly_ispline_maximal.rds"))
```




```{r}


print("variance explained zeta 2")
with(summary(msgdm.2$model), 1 - deviance/null.deviance)



print("variance explained zeta 3")
with(summary(msgdm.3$model), 1 - deviance/null.deviance)



print("variance explained zeta 4")
with(summary(msgdm.4$model), 1 - deviance/null.deviance)



print("variance explained zeta 6")
with(summary(msgdm.6$model), 1 - deviance/null.deviance)


print("variance explained zeta 8")
with(summary(msgdm.8$model), 1 - deviance/null.deviance)


print("variance explained zeta 10")
with(summary(msgdm.10$model), 1 - deviance/null.deviance)

```




```{r  warning = FALSE}
Plot.ispline(msgdm = msgdm.2, data.env = site.by.env, distance = TRUE,  legend = TRUE)
Plot.ispline(msgdm = msgdm.3, data.env = site.by.env, distance = TRUE,  legend = TRUE)
Plot.ispline(msgdm = msgdm.4, data.env = site.by.env, distance = TRUE,  legend = TRUE)
Plot.ispline(msgdm = msgdm.6, data.env = site.by.env, distance = TRUE,  legend = TRUE)
Plot.ispline(msgdm = msgdm.8, data.env = site.by.env, distance = TRUE,  legend = TRUE)
Plot.ispline(msgdm = msgdm.10, data.env = site.by.env, distance = TRUE,  legend = TRUE)

# pdf(here("./Output/msgdm.2.pdf")) 
# Plot.ispline(msgdm = msgdm.2, data.env = site.by.env, distance = TRUE,  legend = TRUE)
# dev.off() 
# 
# 
# pdf(here("./Output/msgdm.3.pdf")) 
# Plot.ispline(msgdm = msgdm.3, data.env = site.by.env, distance = TRUE,  legend = TRUE)
# dev.off() 
# 
# 
# pdf(here("./Output/msgdm.4.pdf")) 
# Plot.ispline(msgdm = msgdm.4, data.env = site.by.env, distance = TRUE,  legend = TRUE)
# dev.off() 
# 
# 
# pdf(here("./Output/msgdm.6.pdf")) 
# Plot.ispline(msgdm = msgdm.6, data.env = site.by.env, distance = TRUE,  legend = TRUE)
# dev.off() 
# 
# 
# pdf(here("./Output/msgdm.8.pdf")) 
# Plot.ispline(msgdm = msgdm.8, data.env = site.by.env, distance = TRUE,  legend = TRUE)
# dev.off() 
# 
# 
# pdf(here("./Output/msgdm.10.pdf")) 
# Plot.ispline(msgdm = msgdm.10, data.env = site.by.env, distance = TRUE,  legend = TRUE)
# dev.off() 


```
```{r}
# 
# pdf(here("./Output/msgdm.all.pdf"))
# 
# par(mfrow = c(2, 3))
# 
# Plot.ispline(msgdm = msgdm.2, data.env = site.by.env, distance = TRUE,  legend = FALSE)
# Plot.ispline(msgdm = msgdm.3, data.env = site.by.env, distance = TRUE,  legend = FALSE)
# Plot.ispline(msgdm = msgdm.4, data.env = site.by.env, distance = TRUE,  legend = FALSE)
# Plot.ispline(msgdm = msgdm.6, data.env = site.by.env, distance = TRUE,  legend = FALSE)
# Plot.ispline(msgdm = msgdm.8, data.env = site.by.env, distance = TRUE,  legend = FALSE)
# Plot.ispline(msgdm = msgdm.10, data.env = site.by.env, distance = TRUE,  legend = FALSE)
# 
# dev.off()
```



```{r  warning = FALSE}



set.seed(1) 
zeta.varpart.2 <- Zeta.varpart(msgdm.mod = msgdm.2, method.glm = "glm.fit2") 

set.seed(1) 
zeta.varpart.3 <- Zeta.varpart(msgdm.mod = msgdm.2, method.glm = "glm.fit2") 

set.seed(1) 
zeta.varpart.4 <- Zeta.varpart(msgdm.mod = msgdm.2, method.glm = "glm.fit2") 

set.seed(1) 
zeta.varpart.6 <- Zeta.varpart(msgdm.mod = msgdm.6, method.glm = "glm.fit2") 



set.seed(1) 
zeta.varpart.8 <- Zeta.varpart(msgdm.mod = msgdm.8, method.glm = "glm.fit2") 


set.seed(1) 
zeta.varpart.10 <- Zeta.varpart(msgdm.mod = msgdm.10, method.glm = "glm.fit2") 

```





```{r  warning = FALSE}


pie.neg(zeta.varpart.2[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9)



pie.neg(zeta.varpart.3[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9)



pie.neg(zeta.varpart.4[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9)



pie.neg(zeta.varpart.6[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9)



pie.neg(zeta.varpart.8[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9)



pie.neg(zeta.varpart.10[4:7,1], density = c(4, 0, 8, -1),  angle = c(90, 0, 0, 0), labels =  c("distance","undistinguishable","environment","unexplained"), radius = 0.9)
```










## check nestedness (Cang's code)


```{r}

jac <- vector()
sor <- vector()
sim <- vector()

for(i in 1:1000){
a <- sample(1:nrow(site.by.species),2)  
unio <- sum(ifelse((site.by.species[a[1],] == 1)|(site.by.species[a[2],]==1),1,0))
inter <- sum(site.by.species[a[1],]*site.by.species[a[2],])
minn <- min(sum(site.by.species[a[1],]),sum(site.by.species[a[2],]))
avg <- (sum(site.by.species[a[1],])+sum(site.by.species[a[2],]))/2
jac[i] <- inter/unio
sor[i] <- inter/avg
sim[i] <- inter/minn
}

boxplot(jac,sor,sim)
text("Jaccard","Sorensen","Simpson")

group <- c(rep("Jaccard", 1000), rep("Sorensen", 1000), rep("Simpson", 1000))
values <- as.numeric(c(jac, sor, sim))

boxdata <-data.frame(cbind(group, values))

boxdata$values <- as.numeric(boxdata$values)


boxplot( values ~ group, boxdata,                                # Color of boxplots
        col = "red")

m1 <- lm(values ~ group, boxdata[1001:3000,])

summary(m1)


```




#contribution to variance of zeta 
```{r}
occ.df<- data.frame( cbind(colSums(site.by.species), colSums(site.by.species)/nrow(site.by.species)))

names(occ.df) <- c("occ", "p.occ")


# here I am trying to work out relative influence of different species on zeta diversity in relation to their occupancy
#commented out
#probability that species is shared between n sites in one sample but not shared between n sites in a second sample
occ.df <- occ.df %>% 
  mutate(rare.cat = case_when(p.occ < 0.2 ~ "1.rare",
                              p.occ >=0.2 & p.occ < 0.4 ~ "2.med.rare",
                              p.occ >=0.4 & p.occ < 0.6 ~ "3.med", 
                              p.occ >= 0.6 & p.occ < 0.8 ~ "4.med.common",
                              p.occ >= 0.8 ~ "5.common")#,
   # share2 = (p.occ1^2)*(1-p.occ1^2),
   #      share3 = (p.occ1^3)*(1-p.occ1^3),
    #     share4 = (p.occ1^4)*(1-p.occ1^4),
     #    share5 = (p.occ1^5)*(1-p.occ1^5),
  #       share10 = (p.occ1^10)*(1-p.occ1^10),
   #      share15 = (p.occ1^15)*(1-p.occ1^15),
  #       share20 = (p.occ1^20)*(1-p.occ1^20),
  #       share30 = (p.occ1^30)*(1-p.occ1^30),
  #       share50 = (p.occ1^50)*(1-p.occ1^50),
  #       share100 = (p.occ1^100)*(1-p.occ1^100),
  #       share200 = (p.occ1^200)*(1-p.occ1^200)
    )

hist(occ.df$p.occ, breaks = 20)


#share2 is the probability that species is shared between 2 sites in one sample but not shared between 2 sites in a second sample









```

```{r}

Zeta.order.ex.2 <- function (data.spec, order = 1, sd.correct = TRUE, rescale = FALSE, 
    empty.row = "empty") 
{
    if (empty.row == "remove") {
        data.spec <- data.spec[-which(rowSums(data.spec) == 0), 
            ]
    }
    if (order > dim(data.spec)[1]) {
        stop("Error: wrong value for \"order\": it must be equal or lower than the number of sites.")
    }
    data.spec <- as.matrix(data.spec)
    intercept_mat <- t(data.spec) %*% data.spec
    occupancy <- colSums(data.spec)
    p <- exp(lchoose(occupancy, order) - lchoose(nrow(data.spec), 
        order))
    zeta.val <- sum(p)
    varmat <- exp(lchoose(intercept_mat, order) - lchoose(nrow(data.spec), 
        order))
    for (j in 1:length(occupancy)) {
        for (k in 1:length(occupancy)) {
            varmat[j, k] <- varmat[j, k] - p[j] * p[k]
        }
    }
    if (sd.correct == TRUE) {
        zeta.val.sd <- sqrt(sum(varmat) * choose(nrow(data.spec), 
            order)/(choose(nrow(data.spec), order) - 1))
    }
    else {
        zeta.val.sd <- sqrt(sum(varmat))
    }
    zeta.order <- list()
    zeta.order$zeta.order <- order
    zeta.order$combinations <- choose(x <- dim(data.spec)[1], 
        order)
    zeta.order$zeta.val <- zeta.val
    zeta.order$zeta.val.sd <- zeta.val.sd
    zeta.order$varmat <- varmat
        return(zeta.order)
}


z2 <- Zeta.order.ex.2(site.by.species, order = 2)

check <- data.frame(z2$varmat)

check1<- data.frame(rowSums(check)/sum(check))

names(check1)<- "share2"



occ.df <- merge(occ.df, check1, by = "row.names")
```

```{r}
plot(share2~p.occ, data = occ.df)
```



#what I am trying to do here is obtain a measure of the influence of species in different rareness/commonness categories
```{r}
sum.influence <- occ.df %>%
  group_by(rare.cat) %>%
  summarise(category.influence2 = sum(share2)#,
           # category.influence3 = sum(share3),
           # category.influence4 = sum(share4),
           # category.influence5 = sum(share5),
           # category.influence10 = sum(share10),
           # category.influence15 = sum(share15),
           # category.influence20 = sum(share20),
           # category.influence30 = sum(share30),
           # category.influence50 = sum(share50),
           # category.influence100 = sum(share100),
            #category.influence200 = sum(share200)
           )


library(data.table)
sum.influence2 <- data.table(sum.influence)

numeric_cols <- names(sum.influence)[sapply(sum.influence, is.numeric)]

sum.influence2[, lapply(.SD, function(x) x/sum(x)), .SDcols = numeric_cols]

# if you want to update by reference
sum.influence2[, (numeric_cols) := lapply(.SD, function(x) x/sum(x)), .SDcols = numeric_cols]

```


```{r}
plot(category.influence2 ~ factor(rare.cat), data = data.frame(sum.influence2), ylim = c(0, 1))


plot(category.influence3 ~ factor(rare.cat), data = data.frame(sum.influence2), ylim = c(0, 1))
plot(category.influence4 ~ factor(rare.cat), data = data.frame(sum.influence2), ylim = c(0, 1))
plot(category.influence5 ~ factor(rare.cat), data = data.frame(sum.influence2), ylim = c(0, 1))
plot(category.influence10 ~ factor(rare.cat), data = data.frame(sum.influence2), ylim = c(0, 1))
plot(category.influence20 ~ factor(rare.cat), data = data.frame(sum.influence2), ylim = c(0, 1))
plot(category.influence30 ~ factor(rare.cat), data = data.frame(sum.influence2), ylim = c(0, 1))
plot(category.influence50 ~ factor(rare.cat), data = data.frame(sum.influence2), ylim = c(0, 1))
plot(category.influence100 ~ factor(rare.cat), data = data.frame(sum.influence2), ylim = c(0, 1))
plot(category.influence200 ~ factor(rare.cat), data = data.frame(sum.influence2), ylim = c(0, 1))


```


```{r}

library(ggplot2)
# Set color by cond

sum.influence3 <- sum.influence2 %>%
  pivot_longer(!rare.cat, names_to = "zeta.order", values_to = "influence")


ggplot(sum.influence3, aes(x=rare.cat, y=influence)) + 
         geom_point(aes(color = factor(zeta.order), size = 2.5)) 

```



```{r}
relig_income
relig_income %>%
  pivot_longer(!religion, names_to = "income", values_to = "count")
```





