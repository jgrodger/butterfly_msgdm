---
title: "GAM species richness"
output: html_document
---


The plan is:
1. Check all GAM control paremters are reasonable
2. Check sampling effort for outliers? revisit filtering for sampling effort
3. Check transects centred on same grid cell
4. Get best GAM model
5. Note which effects are robust to outliers
6. Check pattern of spatial autocorrelation from a variogram #https://github.com/seananderson/glmm-course/blob/master/09-spatial-autocorrelation.Rmd
7. run GAMM

see
https://slowkow.com/notes/ggplot2-color-by-density/


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Packages
```{r}
here::i_am("Scripts/Rmd_Scripts/run_zeta_msgdm.Rmd")

library(tmap)
library(tidyverse)
library(mgcv)
library(mgcViz)
library(magrittr)
library(sp)
library(sf)
library(gstat)
library(terra)
library(knitr)
library(knitrProgressBar)
library(tictoc)
library(here)
library(conflicted)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::select)
conflicts_prefer(knitrProgressBar::progress_estimated)

# there is a same-named function in dplyr, check it out
```


```{r}

#https://fukamilab.github.io/BIO202/08-B-spatial-regression.html


```


#### Functions
```{r}
# From https://stackoverflow.com/questions/71252509/is-there-a-way-to-get-progress-information-whan-a-chunk-is-running-in-rmarkdown

slow_function <- function(i, .pb=NULL) {  
  update_progress(.pb)  
  Sys.sleep(0.5)  
  i  
}

# create an R6 progress object for
# the number of loops/iterations in the target chunk
```

#### File Paths
```{r}
data_path <- paste0("./Data/Processed_Data/Spatial/all_species.rds/")

out_path <-  paste0(here("Output/Spatial/GAM/"))

if(!dir.exists(out_path)) dir.create(out_path)
```

#### Data
```{r}
data <- readRDS(here(data_path))

site.by.species <- data$site.by.species
  
site.by.env <- data$site.by.env

site.by.xy <- data$site.by.xy

# gb polygon

gb <- readRDS(here("./Data/Input_Environmental_Data/gb_multipolygon.rds"))

str(gb, max.level = 1)

crs(gb)
```


#### Simplify the basemap (transfer later to another script)
```{r}
gb1 <- st_simplify(gb, preserveTopology = FALSE, dTolerance = 100)

ggplot(gb1) + geom_sf()
plot(gb1, 
     zoom_to = c(13.359, 54.413), 
      zoom_level = 8)


lundy_box <- c(xmin = 80000, xmax = 240000,
              ymin = 130000, ymax = 180000)

lundy_cropped <- st_crop(gb1, lundy_box )

scilly_box <- c(xmin = 80000, xmax = 110000,
                ymin = 6000, ymax = 101000)


#ac_box <- c(xmin = 180000, xmax = 210000,
 #               ymin = 600000, ymax = 615000)

ac_box <- c(xmin = 180000, xmax = 210000,
                ymin = 590000, ymax = 610000)
ac_cropped <- st_crop(gb1, ac_box )

ggplot(gb1) + geom_sf()
ggplot(ac_cropped) + geom_sf()

  
scilly_cropped <- st_crop(gb1, scilly_box )

ggplot(gb1) + geom_sf()
ggplot(lundy_cropped) + geom_sf()
ggplot(scilly_cropped) + geom_sf()

gb1 <- st_difference(gb1, st_set_crs(st_as_sf(as(raster::extent(80000, 240000, 130000, 180000), "SpatialPolygons")), st_crs(gb1)))
gb1 <- st_difference(gb1, st_set_crs(st_as_sf(as(raster::extent(80000, 111000, 6000, 101000), "SpatialPolygons")), st_crs(gb1)))
gb1 <- st_difference(gb1, st_set_crs(st_as_sf(as(raster::extent(180000, 210000, 590000, 610000), "SpatialPolygons")), st_crs(gb1)))

ggplot(gb1) + geom_sf()



```




#### Environmental variable Pearson and Spearman correlations
```{r}
t1 <- cor(site.by.env)
t2 <- cor(site.by.env, method = "spearman")

print("Pearson correlation")
t1
print("Spearman correlation")
t2


write.csv(t1, file = paste0(here(out_path), "/",  "env_var_pearson_cor.csv"))
write.csv(t2, file = paste0(here(out_path), "/",  "env_var_spearman_cor.csv"))

```

```{r}


site.by.env.and.richness <- cbind(site.by.env, rowSums(site.by.species)) %>%
  cbind(site.by.xy) %>%
rename(species.richness = 'rowSums(site.by.species)')


hist(site.by.env.and.richness$species.richness)
```

```{r}
pairs(site.by.env.and.richness[,c(1, 2, 3, 9)])
pairs(site.by.env.and.richness[, c(4, 5, 6, 9)])
pairs(site.by.env.and.richness[,6:9])

pairs(site.by.env.and.richness[c(10, 11, 9)])
```
## GAM analyses

#### Check if selecting smoothing makes a difference

```{r}

# Note, k = -1 is the same as k = 10 in these analyses with both bs = "cr" and default bs = "tp"

# Set k manually k = 10
gam1 <- gam(species.richness ~ s(x, y, k = 120) + s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(tree.density) + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.and.richness, method= "REML", family = "poisson", link = "log")

# choose smoothing automatically 
gam2 <- gam(species.richness ~ s(x, y, k = 120) + s(mean.ann.temp, sp = -1) + s(log10.mean.ann.rain, sp = -1) + s(topographic.wetness, sp = -1) + s(ph, sp = -1) + s(total.n, sp = -1) + s(tree.density, sp = -1) + s(log10.pesticide.risk, sp = -1) + s(log10.humans, sp = -1),  data = site.by.env.and.richness, method= "REML", family = "poisson", link = "log")

```

```{r}
summary(gam1)
par(mfrow = c(2, 2))
gam.check(gam1)
```
```{r}
summary(gam2)
par(mfrow = c(2, 2))
gam.check(gam2)
```



##### no advantage to choosing smoothing
```{r}
AIC(gam1, gam2)

```

# Check family argument
```{r}
# quasipoisson
gam3 <- gam(species.richness ~ s(x, y) + s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(tree.density) + s(log10.pesticide.risk) + s(log10.humans), data = site.by.env.and.richness, method= "REML", family = "quasipoisson", link = "log")

# Tweedie, p = 1
gam4 <- gam(species.richness ~ s(x, y) + s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(tree.density) + s(log10.pesticide.risk) + s(log10.humans), data = site.by.env.and.richness, method= "REML", family = Tweedie(p = 1.1, link = "log"))

# Tweedie, p = 2
gam5 <- gam(species.richness ~ s(x, y) + s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(tree.density) + s(log10.pesticide.risk) + s(log10.humans), data = site.by.env.and.richness, method= "REML", family = Tweedie(p = 2, link = "log"))

# gaussian
gam6 <- gam(species.richness ~ s(x, y) + s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(tree.density) + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.and.richness, method= "REML")
```



# Family = gaussian (the default) is preferred
```{r}
AIC(gam1, gam3, gam4, gam5, gam6)
```

##### No advantage to Quasipoisson
```{r}
summary(gam3)
par(mfrow = c(2, 2))
gam.check(gam3)
```

##### No advantage to Tweedie
```{r}
summary(gam4)
par(mfrow = c(2, 2))
gam.check(gam4)
```
# Family = gaussian (the default) is preferred by aic


```{r}
# change k
gam7 <- gam(species.richness ~ s(x, y, k = 60) + s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness, k = 20) + s(ph, k = 20) + s(total.n, k = 20) + s(tree.density) + s(log10.pesticide.risk, k = 20) + s(log10.humans),  data = site.by.env.and.richness, method= "REML")

# change k
gam8 <- gam(species.richness ~ s(x, y, k = 120) + s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness, k = 40) + s(ph, k = 40) + s(total.n, k = 40) + s(tree.density) + s(log10.pesticide.risk, k = 40) + s(log10.humans),  data = site.by.env.and.richness, method= "REML")

# change k
gam9 <- gam(species.richness ~ s(x, y, k = 120) + s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(tree.density) + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.and.richness, method= "REML")

```



```{r}
summary(gam7)
par(mfrow = c(2, 2))
gam.check(gam7)
```
```{r}
summary(gam8)
par(mfrow = c(2, 2))
gam.check(gam8)
```

```{r}
summary(gam9)
par(mfrow = c(2, 2))
gam.check(gam9)
```

```{r}
AIC(gam6, gam7, gam8, gam9)
```

```{r}
plot(gam9, residuals = TRUE, seWithMean = TRUE, shade = TRUE, shift = coef(gam9)[1])
vis.gam(gam9, view = c("ph", "total.n"),theta= -135)
vis.gam(gam9, view = c("ph", "mean.ann.temp"),theta= -45)
vis.gam(gam9, view = c("ph", "log10.pesticide.risk"),theta= -45)
```
#### Concurvity tells us about relationships between smoothed terms

full = TRUE gives overall estimates of relationship of each smoothed term with all others, 
full = FALSE gives pairwise relationship according to three different methods.

```{r}
concurvity(gam9, full = TRUE)
print("worst")
round(concurvity(gam9, full = FALSE)$worst, 2)
print("observed")
round(concurvity(gam9, full = FALSE)$observed, 2)
print("estimate")
round(concurvity(gam9, full = FALSE)$estimate, 2)
```




```{r warning = FALSE}
# see answer here for k https://stats.stackexchange.com/questions/359568/choosing-k-in-mgcvs-gam

# 
# pdf(here("./Output/gam.pdf"))
# par(mfrow = c(2,4))
# plot.gam(gam1)
# dev.off()

#gam from zetadiv, Code from Latombe et al. 2018

#including log observations 

#zeta.gam <- Zeta.msgdm(site.by.species, site.by.env,xy=NULL,order=1,sam=50000,normalize = FALSE,reg.type = "gam",family=gaussian(),control=glm.control(maxit = 500),empty.row = "remove",kn=10)


```


# Add residuals to env variables to check patterns
```{r}
env.and.res <- cbind( site.by.env.and.richness, resid(gam9)) %>%
rename(residuals = 'resid(gam9)')
```


```{r}
pairs(env.and.res[,c(1, 2, 12)])
pairs(env.and.res[, c(3, 4, 5, 12)])
pairs(env.and.res[, c(6, 7, 8, 12)])
pairs(env.and.res[, c(10, 11, 12)])
```
##### Residual plots show a group of observations with low observed species richness but high predicted species richness

```{r}
plot(residuals ~ mean.ann.temp, data = env.and.res)
plot(residuals ~ mean.ann.temp, data = env.and.res, xlim = c(14, 16.1), ylim = c(-22, -10))

plot(residuals ~ species.richness, data = env.and.res, xlim = c(1, 35), ylim = c(-23, 10))


check.res <-filter(env.and.res, residuals < -10, mean.ann.temp > 14)

plot(residuals ~ species.richness, data = check.res, xlim = c(1, 35), ylim = c(-23, 10))
```
#### Look at geographic pattern in residuals
```{r}

#env.and.res <- st_as_sf(env.and.res, coords=c("x","y"), remove = FALSE, crs = 27700)

coordinates(env.and.res) <- c("x","y") 

crs.geo <- CRS("+init=epsg:27700")  # looks up BNG crs
proj4string(env.and.res) <- crs.geo  # define projection system of our data

bubble(env.and.res, "residuals", col = c("black","grey"),
       main = "Residuals", xlab = "X-coordinates", ylab = "Y-coordinates")

coordinates(check.res) <- c("x","y")
proj4string(check.res) <- crs.geo  # define projection system of our data
bubble(check.res, "residuals", col = c("black","grey"),
       main = "Residuals", xlab = "X-coordinates", ylab = "Y-coordinates")
```


## Plot Sites
```{r r eval = FALSE}

basemap <-tm_shape(gb1) +
  tm_borders()

pointsmap <- basemap +
tm_shape(env.and.res) +
  tm_symbols(size = 0.25, col = "residuals", midpoint = NA)

print(pointsmap)

checkmap <- basemap +
tm_shape(check.res) +
  tm_symbols(size = 0.25, col = "residuals", midpoint = NA)

print(checkmap)
```



```{r}
data.reduced <- as.data.frame(env.and.res)
data.reduced <- data.reduced[ !(data.reduced$residuals < -10 & data.reduced$mean.ann.temp > 14), ]

# gaussian
gam10 <- gam(species.richness ~ s(x, y, k = 120) + s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(tree.density) + s(log10.pesticide.risk) + s(log10.humans),  data = data.reduced, method= "REML")


```

```{r}
summary(gam10)
plot(gam10, seWithMean = TRUE, shade = TRUE, shift = coef(gam6)[1], pages = 2)
gam.check(gam10)

```

#### check other bs options
```{r}
# cr
gam11 <- gam(species.richness ~ s(x, y, k = 120) + s(mean.ann.temp, bs="cr") + s(log10.mean.ann.rain, bs="cr") + s(topographic.wetness, bs="cr") + s(ph, bs="cr") + s(total.n, bs="cr") + s(tree.density, bs="cr") + s(log10.pesticide.risk, bs="cr") + s(log10.humans, bs="cr"),  data = site.by.env.and.richness, method= "REML")

# cs
gam12 <- gam(species.richness ~ s(x, y, k = 120) + s(mean.ann.temp, bs="cs") + s(log10.mean.ann.rain, bs="cs") + s(topographic.wetness, bs="cs") + s(ph, bs="cs") + s(total.n, bs="cs") + s(tree.density, bs="cs") + s(log10.pesticide.risk, bs="cs") + s(log10.humans, bs="cs"),  data = site.by.env.and.richness, method= "REML")

# cs
gam13 <- gam(species.richness ~ s(x, y, k = 120) + s(mean.ann.temp, bs="ts") + s(log10.mean.ann.rain, bs="ts") + s(topographic.wetness, bs="ts") + s(ph, bs="ts") + s(total.n, bs="ts") + s(tree.density, bs="ts") + s(log10.pesticide.risk, bs="ts") + s(log10.humans, bs="ts"),  data = site.by.env.and.richness, method= "REML")
```

```{r}
AIC(gam9, gam11, gam12, gam13)
```



```{r}
summary(gam9)
plot(gam9, seWithMean = TRUE, shade = TRUE, shift = coef(gam9)[1], pages = 2)
par(mfrow = c(2, 2))
gam.check(gam9)
```

```{r}
summary(gam11)
plot(gam11, seWithMean = TRUE, shade = TRUE, shift = coef(gam11)[1], pages = 2)
par(mfrow = c(2, 2))
gam.check(gam11)
```

```{r}
summary(gam12)
plot(gam12, seWithMean = TRUE, shade = TRUE, shift = coef(gam12)[1], pages = 2)
par(mfrow = c(2, 2))
gam.check(gam12)

summary(gam12)$s.pv
```

```{r}
summary(gam13)
plot(gam13, seWithMean = TRUE, shade = TRUE, shift = coef(gam13)[1], pages = 2)
par(mfrow = c(2, 2))
gam.check(gam13)

summary(gam13)$s.pv
```
# select = TRUE
```{r}
gam14 <- gam(species.richness ~ s(x, y, k = 120) + s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(tree.density) + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.and.richness, method= "REML", select = TRUE)

#method = ML
gam15 <- gam(species.richness ~ s(x, y, k = 120) + s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(tree.density) + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.and.richness, method= "ML", select = TRUE)

#As for gam9 but with ML
gam16 <- gam(species.richness ~ s(x, y, k = 120) + s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(tree.density) + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.and.richness, method= "ML")


```

```{r}
summary(gam16)
plot(gam16, seWithMean = TRUE, shade = TRUE, shift = coef(gam12)[1], pages = 2)
par(mfrow = c(2, 2))
gam.check(gam16)
```


```{r}

#check if appropriate to compare reml and ml
AIC(gam6, gam11, gam12, gam13, gam14, gam15, gam16)

```

# leave out tree density first
```{r}
gam17 <- gam(species.richness ~ s(x, y, k = 120) + s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n)  + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.and.richness, method= "ML")

anova(gam16, gam17, test = "F")

AIC(gam16, gam17)

summary(gam17)
plot(gam17, seWithMean = TRUE, shade = TRUE, shift = coef(gam17)[1], pages = 2)
par(mfrow = c(2, 2))
gam.check(gam17)
```

```{r}
concurvity(gam17, full = TRUE)
print("worst")
round(concurvity(gam17, full = FALSE)$worst, 2)
print("observed")
round(concurvity(gam17, full = FALSE)$observed, 2)
print("estimate")
round(concurvity(gam17, full = FALSE)$estimate, 2)
```


# check what happens when terms are dropped (note, here we use ML)
```{r}



# -temp
gam18 <- gam(species.richness ~ s(x, y, k = 120) +  s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n)  + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.and.richness, method= "ML")

# - rain
gam19 <- gam(species.richness ~ s(x, y, k = 120) + s(mean.ann.temp) + s(topographic.wetness) + s(ph) + s(total.n)  + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.and.richness, method= "ML")

# - wetness
gam20 <- gam(species.richness ~ s(x, y, k = 120) + s(mean.ann.temp) + s(log10.mean.ann.rain)  + s(ph) + s(total.n)  + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.and.richness, method= "ML")

# - ph
gam21 <- gam(species.richness ~ s(x, y, k = 120) + s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(total.n)  + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.and.richness, method= "ML")

#- n
gam22 <- gam(species.richness ~ s(x, y, k = 120) + s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph)   + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.and.richness, method= "ML")

# - pesticide
gam23 <- gam(species.richness ~ s(x, y, k = 120) + s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n)  + s(log10.humans),  data = site.by.env.and.richness, method= "ML")

# - humans
gam24 <- gam(species.richness ~ s(x, y, k = 120) + s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n)  + s(log10.pesticide.risk),  data = site.by.env.and.richness, method= "ML")

```

```{r}

# -temp
anova(gam17, gam18, test = "F")

# -rain
anova(gam17, gam19, test = "F")

# -wetness
anova(gam17, gam20, test = "F")

# -ph
anova(gam17, gam21, test = "F")

#-n
anova(gam17, gam22, test = "F")

# -pesticide
anova(gam17, gam23, test = "F")

# -humans
anova(gam17, gam24, test = "F")


AIC(gam17, gam18, gam19, gam20, gam21, gam22, gam23, gam24)
```


##### reduce concurvity by leaving out one of pairs of variables with high concurvity (here we go back to REML)
```{r}
# leave out rainfall (concurv with temp), pesticide risk(concurve with N) and humans (concurv with temp)
gam25 <- gam(species.richness ~ s(x, y, k = 120) + s(mean.ann.temp) + s(topographic.wetness) + s(ph) + s(total.n)   ,  data = site.by.env.and.richness, method= "REML")

#leave out temp, pesticide risk, and humans

gam26 <- gam(species.richness ~ s(x, y, k = 120) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n),  data = site.by.env.and.richness, method= "REML")

# leave out rainfall, temp and ph
gam27 <- gam(species.richness ~ s(x, y, k = 120) +  s(topographic.wetness)  + s(total.n) + s(tree.density) + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.and.richness, method= "REML")
```

```{r}

summary(gam25)
plot(gam25, seWithMean = TRUE, shade = TRUE, shift = coef(gam25)[1], pages = 2)
par(mfrow = c(2, 2))
gam.check(gam25)
```

```{r}
summary(gam26)
plot(gam26, seWithMean = TRUE, shade = TRUE, shift = coef(gam26)[1], pages = 2)
par(mfrow = c(2, 2))
gam.check(gam26)
```

##### If temp, rainfall and ph are left out, opposite relationships are produced for humans and pesticide risk
```{r}
summary(gam27)
plot(gam27, seWithMean = TRUE, shade = TRUE, shift = coef(gam27)[1], pages = 3)
par(mfrow = c(2, 2))
gam.check(gam27)
```

```{r}
summary(gam6)
plot(gam6, seWithMean = TRUE, shade = TRUE, shift = coef(gam6)[1], pages = 4)
```


# Play with mgcVis
```{r}
vis9 <- getViz(gam9)

#adapted from https://cran.r-project.org/web/packages/mgcViz/vignettes/mgcviz.html
#We added the fitted smooth effect, rugs on the x and y axes, confidence lines at 95%, partial residual points and we changed the plotting theme to ggplot2::theme_classic. Functions such as l_fitLine or l_rug are effect-specific layers. To see all the layers available for each effect plot we do:

#mul = 2 means interval +- 2 SE shown, narrower than 95% CI of course (default here)
p1 <- plot(sm(vis9, 1))
p1 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
    l_ciLine(colour = "blue", linetype = 2) + 
    l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()

p2 <- plot(sm(vis9, 2))
p2 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
    l_ciLine(colour = "blue", linetype = 2) + 
    l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()

p3 <- plot(sm(vis9, 3))
p3 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
    l_ciLine(colour = "blue", linetype = 2) + 
    l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()

p4 <- plot(sm(vis9, 4))
p4 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
    l_ciLine(colour = "blue", linetype = 2) + 
    l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()

p5 <- plot(sm(vis9, 5))
p5 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
    l_ciLine(colour = "blue", linetype = 2) + 
    l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()

p6 <- plot(sm(vis9, 6))
p6 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
    l_ciLine(colour = "blue", linetype = 2) + 
    l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()

p7 <- plot(sm(vis9, 7))
p7 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
    l_ciLine(colour = "blue", linetype = 2) + 
    l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()

p8 <- plot(sm(vis9, 8))
p8 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
    l_ciLine(colour = "blue", linetype = 2) + 
    l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()

p9 <- plot(sm(vis9, 9))
p9 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
    l_ciLine(colour = "blue", linetype = 2) + 
    l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()



```


```{r}

xy.res<- cbind(site.by.xy, resid(gam9))%>%
rename(residuals = 'resid(gam9)')

v1 <-   variogram(residuals ~ 1, loc= ~ x+y, data = xy.res)
fit1 <- fit.variogram(v1, vgm(c("Sph", "Exp"))); 
plot(v1, fit1)

# extract the nugget and range from the variogram model to create the correlation structure 
# to include in the magic formula
fit1
```

# Possibly outdated advice
```{r}
cs1Exp <- corSpher(c(129567.2, 11.686935), form = ~ x + y, nugget=TRUE)
cs1Exp <- Initialize(cs1Exp, xy.res)
# follow instructions from mgcv 'magic' function
V <- corMatrix(cs1Exp)
Cv <- chol(V) 
# ## gam ignoring correlation
# b <- gam(dam ~ s(lat, long) + 
# +            s(f_edge),
# +          family = binomial,
# +          data=data,
# +          method = "ML",
# +          select = TRUE,
# +          na.action = "na.fail")
# ## Fit smooth, taking account of *known* correlation...
# w <- solve(t(Cv)) # V^{-1} = w'w
# ## Use `gam' to set up model for fitting...
# G <- gam(dam10_15 ~ s(lat, long) +
# +            s(f_edge),
# +          family = binomial,
# +          data=dataPOD1x1s,
# +          method = "ML",
# +          select = TRUE,
# +          na.action = "na.fail",
# +          fit=FALSE)
# ## fit using magic, with weight *matrix*
# mgfit <- magic(G$y,G$X,G$sp,G$S,G$off,rank=G$rank,C=G$C,w=w)
# mg.stuff <- magic.post.proc(G$X,mgfit,w)
# b$edf <- mg.stuff$edf;b$Vp <- mg.stuff$Vb
# b$coefficients <- mgfit$b 
# summary(gam1x1)
```


# GAMM add spatial autocorrelation (nugget allows non-zero autocorrelation at 0 distance)
```{r}


#note, 104 sites with same x and y coordinates, check how this arises

#site.by.env.xy.richness <- as.data.frame(env.and.res)

site.by.env.xy.richness <- cbind(site.by.env.and.richness, site.by.xy)

site.by.env.xy.richness.distinct <- distinct(site.by.env.xy.richness, x, y, .keep_all = TRUE)


# time consuming
gammGaus <- gamm(species.richness ~ s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(tree.density) + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.xy.richness.distinct, method= "REML", correlation=corGaus(form = ~x+y), nugget = TRUE))

gammExp <- gamm(species.richness ~ s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(tree.density) + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.xy.richness.distinct, method= "REML", correlation=corExp(form = ~x+y, nugget = TRUE))

gammLin <- gamm(species.richness ~ s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(tree.density) + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.xy.richness.distinct, method= "REML", correlation=corLin(form = ~x+y, nugget = TRUE))

gammRatio <- gamm(species.richness ~ s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(tree.density) + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.xy.richness.distinct, method= "REML", correlation=corRatio(form = ~x+y, nugget = TRUE))

gammSpher <- gamm(species.richness ~ s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(tree.density) + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.xy.richness.distinct, method= "REML", correlation=corSpher(form = ~x+y, nugget = TRUE))
```

```{r}
gamm_cor_struct_list <- list(gammGaus, gammExp, gammLin, gammRatio, gammSpher)
write_rds(gamm_cor_struct_list, file = paste0(here(out_path), "/",  "gamm_cor_struct_compare.rds"))
```


```{r}
AIC(gammGaus$lme, gammExp$lme, gammLin$lme, gammRatio$lme, gammSpher$lme)
```

```{r}
#get.gamm.output <- function(gamm.list){}
```


#### Concurvity tells us about relationships between smoothed terms

full = TRUE gives overall estimates of relationship of each smoothed term with all others, 
full = FALSE gives pairwise relationship according to three different methods.

```{r}
concurvity(gammExp$gam, full = TRUE)
print("worst")
round(concurvity(gammExp$gam, full = FALSE)$worst, 2)
print("observed")
round(concurvity(gammExp$gam, full = FALSE)$observed, 2)
print("estimate")
round(concurvity(gammExp$gam, full = FALSE)$estimate, 2)
```



```{r}
AIC(gammExp$lme)

summary(gammExp$gam)

par(mfrow = c(2, 2))
plot(gammExp$gam, residuals = TRUE, seWithMean = TRUE, shade = TRUE, shift = coef(gammExp$gam)[1])

par(mfrow = c(2, 2))  
gam.check(gammExp$gam)

#vis.gam(gammExp$gam)

#mgcViz::qqnorm(residuals(gammExp$lme,type="normalized"))

acf(residuals(gammExp$lme,type="normalized"),main="standardized residual ACF")
```


```{r}

vis.gam(gammExp$gam, view = c("ph", "total.n"),theta= -135)
vis.gam(gammExp$gam, view = c("ph", "mean.ann.temp"),theta= -45)
vis.gam(gammExp$gam, view = c("ph", "log10.pesticide.risk"),theta= -45)
```


#remove tree density
```{r}
gammExp1 <- gamm(species.richness ~ s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.xy.richness.distinct, method= "REML", correlation=corExp(form = ~x+y, nugget = TRUE))
```

```{r}
AIC(gammExp1$lme)

summary(gammExp1$gam)
```


```{r}
concurvity(gammExp1$gam, full = TRUE)
print("worst")
round(concurvity(gammExp1$gam, full = FALSE)$worst, 2)
print("observed")
round(concurvity(gammExp1$gam, full = FALSE)$observed, 2)
print("estimate")
round(concurvity(gammExp1$gam, full = FALSE)$estimate, 2)
```

```{r}
# remove temp
gammExp2 <- gamm(species.richness ~ s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.xy.richness.distinct, method= "REML", correlation=corExp(form = ~x+y, nugget = TRUE))

#remove rain
gammExp3 <- gamm(species.richness ~ s(mean.ann.temp) + s(topographic.wetness) + s(ph) + s(total.n) + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.xy.richness.distinct, method= "REML", correlation=corExp(form = ~x+y, nugget = TRUE))

# remove wetness
gammExp4 <- gamm(species.richness ~ s(mean.ann.temp) + s(log10.mean.ann.rain) + s(ph) + s(total.n) + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.xy.richness.distinct, method= "REML", correlation=corExp(form = ~x+y, nugget = TRUE))

#remove ph
gammExp5 <- gamm(species.richness ~ s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(total.n) + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.xy.richness.distinct, method= "REML", correlation=corExp(form = ~x+y, nugget = TRUE))

# remove n
gammExp6 <- gamm(species.richness ~ s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.xy.richness.distinct, method= "REML", correlation=corExp(form = ~x+y, nugget = TRUE))

# remove pesticide
gammExp7 <- gamm(species.richness ~ s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(log10.humans),  data = site.by.env.xy.richness.distinct, method= "REML", correlation=corExp(form = ~x+y, nugget = TRUE))

#remove humans
gammExp8 <- gamm(species.richness ~ s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(log10.pesticide.risk) ,  data = site.by.env.xy.richness.distinct, method= "REML", correlation=corExp(form = ~x+y, nugget = TRUE))

# remove temp AND rainfall
gammExp9 <- gamm(species.richness ~ s(topographic.wetness) + s(ph) + s(total.n) + s(log10.pesticide.risk) + s(log10.humans),  data = site.by.env.xy.richness.distinct, method= "REML", correlation=corExp(form = ~x+y, nugget = TRUE))

```

# only tree density removed
```{r}
summary(gammExp1$gam)

par(mfrow = c(2, 2))
plot(gammExp1$gam, residuals = TRUE, seWithMean = TRUE, shade = TRUE, shift = coef(gammExp1$gam)[1])
```

# remove temp

```{r}
summary(gammExp2$gam)

par(mfrow = c(2, 2))
plot(gammExp2$gam, residuals = TRUE, seWithMean = TRUE, shade = TRUE, shift = coef(gammExp2$gam)[1])
```

#remove rain


```{r}
summary(gammExp3$gam)

par(mfrow = c(2, 2))
plot(gammExp3$gam, residuals = TRUE, seWithMean = TRUE, shade = TRUE, shift = coef(gammExp3$gam)[1])
```

# remove wetness

```{r}
summary(gammExp4$gam)

par(mfrow = c(2, 2))
plot(gammExp4$gam, residuals = TRUE, seWithMean = TRUE, shade = TRUE, shift = coef(gammExp4$gam)[1])
```
#remove ph

```{r}
summary(gammExp5$gam)

par(mfrow = c(2, 2))
plot(gammExp5$gam, residuals = TRUE, seWithMean = TRUE, shade = TRUE, shift = coef(gammExp5$gam)[1])
```


# remove n

```{r}
summary(gammExp6$gam)

par(mfrow = c(2, 2))
plot(gammExp6$gam, residuals = TRUE, seWithMean = TRUE, shade = TRUE, shift = coef(gammExp6$gam)[1])
```

# remove pesticide

```{r}
summary(gammExp7$gam)

par(mfrow = c(2, 2))
plot(gammExp7$gam, residuals = TRUE, seWithMean = TRUE, shade = TRUE, shift = coef(gammExp7$gam)[1])
```


#remove humans

```{r}
summary(gammExp8$gam)

par(mfrow = c(2, 2))
plot(gammExp8$gam, residuals = TRUE, seWithMean = TRUE, shade = TRUE, shift = coef(gammExp8$gam)[1])
```

#remove temp AND rain


```{r}
summary(gammExp9$gam)

par(mfrow = c(2, 2))
plot(gammExp9$gam, residuals = TRUE, seWithMean = TRUE, shade = TRUE, shift = coef(gammExp9$gam)[1])
```


```{r}
gamm_model_selection_list <- list(gammExp1, gammExp2, gammExp3, gammExp4, gammExp5, gammExp6, gammExp7, gammExp8, gammExp9)
write_rds(gamm_model_selection_list, file = paste0(here(out_path), "/",  "gamm_model_compare.rds"))
```

