---
title: "R Notebook"
output: html_notebook
---
# Libraries
```{r}
here::i_am("Scripts/Rmd_Scripts/butterfly_maps.Rmd")
library(tidyverse)
library(viridis)

#library(hrbrthemes)
#library(mapdata)
#library(fasterize)

#library(mapchina)
#library(terra)
library(sf)
library(spatstat)
library(ggplot2)
library(gridExtra)
library(here)
```

```{r}
# Basemap without outlying islands
gb <- readRDS(here("./Data./Maps./gb_multipolygon_simplified.rds"))

#All species data
butterfly_data <- readRDS(here("./Data/Processed_Data/Spatial/all_species.rds"))

sites <- butterfly_data$sites %>%
  rename(as.richness = richness)

# Wider countryside
wc_data <- readRDS(here("./Data/Processed_Data/Spatial/wc.rds"))


#Habitat specialists
hs_data <- readRDS(here("./Data/Processed_Data/Spatial/hs.rds"))

# check if sites are in the same order in all datasets
any(rownames(sites) != rownames(wc_data$site.by.species))
any(rownames(sites) != rownames(hs_data$site.by.species))

sites <- sites %>%
  mutate(wc.richness = rowSums(wc_data$site.by.species),
         hs.richness = rowSums(hs_data$site.by.species))

```


### squares and hexagons of point density, adapted from https://r-graph-gallery.com/329-hexbin-map-for-distribution.html
```{r}
#rectangle
rect_dens <- ggplot() + 
    geom_sf(data = gb) +
  geom_bin2d(bins=30, data = sites, aes(x = x, y = y)) +
    scale_fill_viridis(name="Transects", 
      breaks = c(0, 1,2, 5,10,15,20, 25, 30)) + 
  labs(x = "", y = "") + 
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.ticks = element_blank())

#hex
hex_dens <- ggplot() + 
    geom_sf(data = gb) +
  geom_hex(bins=30, data = sites, aes(x = x, y = y)) +
    scale_fill_viridis_b(name="Transects", 
      breaks = c(0,2, 5,10,15,20, 25, 30)) + 
  labs(x = "", y = "") + 
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.ticks = element_blank(), 
  legend.direction = "horizontal", 
  legend.position = "bottom") +
  guides(fill = guide_colorbar(title = "Transects", 
                             theme(legend.title.position = "top",
                                  legend.text.position = "bottom")))


rect_dens
hex_dens



png(filename =  paste0(here("Output/Spatial/Figures/Hex_dens_transects.png/")))
hex_dens
dev.off()
```

```{r}
hist(sites$as.richness)
hist(sites$wc.richness)
hist(sites$hs.richness)
```


```{r}
# modified above plot along lines suggested by answer https://stackoverflow.com/questions/74818772/r-how-to-fill-geom-hex-with-a-numerical-value-and-heat-scale-it


# note, by default interals are left-open and right-closed, ie they do not include lower endpoint but do include right endpoint

as_richness <- ggplot() + 
    geom_sf(data = gb) +
  stat_summary_hex(
    bins=30, 
    data = sites, 
    aes(x = x, y = y, z = as.richness)) + #the mean is taken by default
    scale_fill_viridis_b(name="AS",
    breaks = c(5, 10, 15, 20, 25, 30, 35)) + 
  labs(x = "", y = "") + 
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.ticks = element_blank(), 
  legend.direction = "horizontal", 
  legend.position = "bottom") +
  guides(fill = guide_colorbar(title = "AS", 
                             theme(legend.title.position = "top",
                                  legend.text.position = "bottom")))
as_richness


```
```{r}

wc_richness <- ggplot() + 
    geom_sf(data = gb) +
  stat_summary_hex(
    bins=30,
    data = sites, 
    aes(x = x, y = y, z = wc.richness)) + #the mean is taken by default
    scale_fill_viridis_b(name="WC",
    breaks = c(5, 10, 15, 20, 25, 30, 35)) + 
  labs(x = "", y = "") + 
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.ticks = element_blank(), 
  legend.direction = "horizontal", 
  legend.position = "bottom") +
  guides(fill = guide_colorbar(title = "WC", 
                             theme(legend.title.position = "top",
                                  legend.text.position = "bottom")))

wc_richness
```

```{r}

hs_richness <- ggplot() + 
    geom_sf(data = gb) +
  stat_summary_hex(
    bins=30,
    data = sites, 
    aes(x = x, y = y, z = hs.richness)) + #the mean is taken by default
    scale_fill_viridis_b(name = "HS",
    breaks = c(0, 1 , 2, 4, 6, 8, 10)) + 
  labs(x = "", y = "") + 
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.ticks = element_blank(), 
  legend.direction = "horizontal", 
  legend.position = "bottom") +
  guides(fill = guide_colorbar(title = "HS", 
                             theme(legend.title.position = "top",
                                  legend.text.position = "bottom")))

hs_richness
```
```{r}
all_hex <- grid.arrange(hex_dens, as_richness, wc_richness, hs_richness, ncol = 4, nrow = 1)

plot(all_hex)

ggsave(
  here("Output/Spatial/Figures/Hex_dens_transects_richness.png/"),
  all_hex,
  units = "mm",
  width = 200,
  dpi = 1200
)

png(filename =  here("Output/Spatial/Figures/Hex_dens_transects_richness.png/"))
grid.arrange(hex_dens, as_richness, wc_richness, hs_richness, ncol = 4, nrow = 1)
dev.off()
```