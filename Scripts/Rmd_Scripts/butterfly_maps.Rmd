---
title: "R Notebook"
output: html_notebook
---
# Libraries
```{r}
here::i_am("Scripts/Rmd_Scripts/butterfly_maps.Rmd")
library(tidyverse)
library(viridis)
library(hrbrthemes)
library(mapdata)
library(fasterize)

library(here)
```

```{r}
# Basemap without outlying islands
gb <- readRDS(here("./Data./Maps./gb_multipolygon_simplified.rds"))

butterfly_data <- readRDS(here("./Data/Processed_Data/Spatial/spatial_ukbms_obs_sites_spp.rds"))

sites <- butterfly_data$sites

```


### squares and hexagons of point density, adapted from https://r-graph-gallery.com/329-hexbin-map-for-distribution.html
```{r}
#rectangle
rect_dens <- ggplot() + 
    geom_sf(data = gb) +
  geom_bin2d(bins=30, data = sites, aes(x = x, y = y)) +
    scale_fill_viridis(name="Transects", 
      breaks = c(0, 1,2, 5,10,15,20, 25, 30)) + 
  labs(x = "", y = "") + 
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.ticks = element_blank())

#hex
hex_dens <- ggplot() + 
    geom_sf(data = gb) +
  geom_hex(bins=30, data = sites, aes(x = x, y = y)) +
    scale_fill_viridis_b(name="Transects", 
      breaks = c(0, 1,2, 5,10,15,20, 25, 30)) + 
  labs(x = "", y = "") + 
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.ticks = element_blank())


rect_dens
hex_dens



png(filename =  paste0(here("Output/Spatial/Figures/Hex_dens_transects.png/")))
hex_dens
dev.off()
```


# I tried the approach below, it doesn't add much info to the points, rather for this use approach above, although I have to rasterise the map


https://stackoverflow.com/questions/68643517/smoothed-density-maps-for-points-in-using-sf-within-a-given-boundary-in-r
```{r}
library(mapchina)
library(sf)
library(spatstat)
library(ggplot2)
```



```{r}

transect_centroids <- sites %>%
  select(x, y) %>%
  st_as_sf(coords = c("x", "y"), crs = crs(gb)) #%>%
 # st_transform(32650)
```



```{r}
ppp_points <- as.ppp(transect_centroids)
Window(ppp_points) <- as.owin(gb)


par(mar = rep(0, 4))
plot(ppp_points, main = "")
```


```{r}
density_spatstat <- density(ppp_points, dimyx = 256)

density_stars <- stars::st_as_stars(density_spatstat)

density_sf <- st_as_sf(density_stars) %>%
  st_set_crs(crs(gb))

ggplot() +
  geom_sf(data = density_sf, aes(fill = v), col = NA) +
  scale_fill_viridis_c() +
  geom_sf(data = st_boundary(gb)) +
  geom_sf(data = transect_centroids, size = 0.5, shape = 19, color = "red")

```


