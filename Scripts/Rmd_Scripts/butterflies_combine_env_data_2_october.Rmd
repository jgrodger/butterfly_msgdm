---
title: "R Notebook"
output: html_notebook
---

#this is copied from ladybirds, I have imported butterfly data but filtering and processing to get all the right size matrices is needed

## setup
```{r}

#The here package enables easy file referencing by using the top-level directory of a file project to easily build file paths."
#about here package: https://here.r-lib.org/articles/here.html
#https://github.com/jennybc/here_here
#by running this before loading the package, we can get a message to check the correct root is being used
here::i_am("Scripts/Rmd_Scripts/butterflies_combine_env_data.Rmd")

library(tidyverse)
library(here)



# library(readr)
# 
# library(segmented)
# 
# library(sgo)


```


## Load data
```{r}
#r markdowns and notebooks default to using the directory where they are stored as the working directory


#site by species matrix

# Still need to replace this with occurrence over multiple years
site.by.species <- readRDS(here("./Data/Processed_Data/site_by_species_2018.rds"))



#get site by xy
sites <- readRDS(here("./Data/Processed_Data/processed_sites_with_ngr.rds"))



site.by.humans <- readRDS(here("./Data/Input_Environmental_Data/human_popn.rds"))

site.by.humans <- data.frame(site.by.humans)#ideally should have been saved as a df before writing as rds
 
site.by.ph <- readRDS(here("./Data/Input_Environmental_Data/ph_1km_df.rds"))

site.by.trees <-  readRDS(here("./Data/Input_Environmental_Data/trees_1km_df.rds"))

site.by.conifer.dominance <-  readRDS(here("./Data/Input_Environmental_Data/conifer_dominance_1km_df.rds"))

site.by.nitrogen <- readRDS(here("./Data/Input_Environmental_Data/nitro.rds"))

#site.by.climate <- readRDS(here("./Data/input_climate_Data/annual_climate_1km.rds"))

#site by landcover
#site.by.lc <- readRDS(here("./Data/input_landcover_Data/lc_1km.rds"))



surveys.site.year <- readRDS(here("./Data/Processed_Data/surveys_site_year.rds"))

#sites.with.40 <- readRDS(here("./Data/Processed_Data/sites_with_at_least_40_years.rds"))



# dataframe with number of species and observations per site
#site.by.pollution <- readRDS(here("./Data/Input_Pollution_And_Pesticides_Data/mean_pollution_with_gridrefs.rds"))

# dataframe with number of species and observations per site
#site.by.pesticides <- readRDS(here("./Data/Input_Pollution_And_Pesticides_Data/pesticides_with_gridrefs.rds"))

#site.by.obs <- 
```

# get a daframe of site by observations, then site by log(observartions)
```{r}

surveys.site.year$site <- paste("site", surveys.site.year$site, sep = "_")

site.by.obs <- surveys.site.year %>%
  ungroup() %>%
    filter(year ==2018)  %>%
      select(-year)  %>%
     rename(observations = surveys)  %>%
      column_to_rownames(var = "site")

site.by.log.obs <- site.by.obs %>%
  mutate(log.observations = log(observations), .keep = "none")
```





## Choose landcover classes,






#To do, choose appropriat variables for butterflies






#this is just copied from ladybirds

## Get log % cover for the sites
```{r}

#keep all vars for now
#site.by.lc <- site.by.lc  %>%
  #  dplyr::select(bro.wood.1, con.wood.2, arable.3, imp.grass.4, seminat.grass.5to8, heath.9to10, freshwater.14, coastal.15to19, #urban.20, suburban.21)

#now we need the transformed land cover composition of the grid cells
logplusone <- function(x)
{log(x + 1)}

#site.by.lc.logs <- site.by.lc %>%
#  mutate(across(colnames(site.by.lc), logplusone)) 
```


## get variable names as desired in dataframes

```{r}
#get site as a variable in the sites and site by species data frames

sites <- rownames_to_column(sites, var = "site")

site.by.species <- rownames_to_column(site.by.species, var = "site")

site.by.ph <-rename(site.by.ph, ph = ph_idw)

site.by.humans <- site.by.humans %>%
  rename(human.density = gbr_pd_2017_1km)%>%
  select(-c(x, y))

site.by.trees <- site.by.trees %>%
  rename(tree.density = tree.cover.density)%>%
  select(-c(x, y)) 

site.by.conifer.dominance <-select(site.by.conifer.dominance, -c(x, y))


site.by.nitrogen <-select(site.by.nitrogen, total.n, ngr.1km)
```

#filter site data to selected sites

#sometimes more than one site per gridref!
```{r}


#here we filter out sites with anything missing

#filter sites to the desired set 

sites.2018 <- sites %>%
     filter(sites$site %in% site.by.species$site)

sites.ngr <- select(sites.2018,site,  ngr.1km)



site.by.env <- merge(sites.ngr, site.by.ph, by = "ngr.1km")


site.by.env <- merge(site.by.env, site.by.humans, by = "ngr.1km") 

site.by.env <- merge(site.by.env, site.by.trees, by = "ngr.1km")


site.by.env <- merge(site.by.env, site.by.conifer.dominance, by = "ngr.1km")


site.by.env <- merge(site.by.env, site.by.nitrogen, by = "ngr.1km")

```


#delete no longer relevant below
```{r}



site.by.climate <- rownames_to_column(site.by.climate, var = "ngr.1km")


site.by.lc.logs <- rownames_to_column(site.by.lc.logs, var = "ngr.1km")


site.by.log.obs <- rownames_to_column(site.by.log.obs, var = "site")

#filter climate data to only include sites with topography and climate data
site.by.climate <- site.by.climate %>%  
                       filter(is.na(topography)== FALSE,
                         is.na(tas)== FALSE)



site.by.climate <- site.by.climate %>%  
                       filter(site.by.climate$ngr.1km %in% sites.2018$ngr.1km)



site.by.lc.logs <- site.by.lc.logs %>%  
                       filter(site.by.lc.logs$ngr.1km %in% sites.2018$ngr.1km)


site.by.log.obs <- site.by.log.obs %>%  
                       filter(site.by.log.obs$site %in% sites.2018$site)


site.by.pollution <- site.by.pollution %>%  
                       filter(site.by.pollution$ngr.1km %in% sites.2018$ngr.1km)

site.by.pesticides <- site.by.pesticides %>%  
                       filter(site.by.pesticides$ngr.1km %in% sites.2018$ngr.1km)





site.by.lc.logs <- site.by.lc.logs %>%
  select(-c(x, y))


site.by.env <- merge(site.by.env, site.by.lc.logs, by = "ngr.1km")

site.by.pollution <- site.by.pollution %>%
  select(-c(x, y))


site.by.env <- merge(site.by.env, site.by.pollution, by = "ngr.1km")

site.by.pesticides <- site.by.pesticides %>%
  select(-c(x, y))

site.by.env <- merge(site.by.env, site.by.pesticides, by = "ngr.1km")


site.by.env <- merge(site.by.env, site.by.log.obs, by = "site")



sites.2018 <- sites.2018 %>%
     filter(sites.2018$ngr.1km %in% site.by.env$ngr.1km)


site.by.species <- site.by.species %>%
     filter(site.by.species$site %in% site.by.env$site)

site.by.species <- column_to_rownames(site.by.species, var = "site")

site.by.env <- column_to_rownames(site.by.env, var = "site")

site.by.xy <- select(site.by.env, x, y)
```




## look at the percentage of cells that each species occurs in
```{r}
check <- data.frame(colMeans(site.by.species))
  names(check) <- "occurrence"
check <- check %>%
  mutate(var.occurence = occurrence*(1-occurrence))

check
```













```{r}

data.2018 <- list(sites.2018, site.by.species, site.by.env, site.by.xy, site.by.obs)

names(data.2018) <- c("sites.2018", "site.by.species", "site.by.env", "site.by.xy", "site.by.obs")


write_rds(data.2018, file = here("./Data/Processed_Data/butterfly.msgdm.data.2018.rds"))

```

