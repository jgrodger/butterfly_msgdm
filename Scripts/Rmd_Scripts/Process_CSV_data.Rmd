---
title: "Process_butterflies"
output: html_notebook
---



## Data cleaning, obtaining site by species matrices
```{r}

here::i_am("Scripts//Rmd_Scripts//Process_CSV_data.Rmd")

library(conflicted)
library(tidyverse)
library(here)

#library(foreach)
#library(doParallel)
#library(doSNOW)

library(spaa)

library(sgo)

library(sf)

library(tidyterra)

library(scales)

library(segmented)

library(tmap)

library(Hmisc)


library(iNEXT)

conflicts_prefer(snow::stopCluster)
conflicts_prefer(snow::makeCluster)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::mutate)
conflicts_prefer(dplyr::select)
#filter <- dplyr::filter


```


```{r}
#(cl = makeCluster(parallel::detectCores()-2, type = "SOCK")) # Initialize all cores except for two
#registerDoSNOW(cl)


records <- read_csv(here("./Data/CSV_Data/ukbms_Rogers_10-3-23.csv"))

#In the CSV, I  added in column headings, did a sort and added in extra columns to help correct entries in incorrect columns
#note, some sites have incomplete info, one site remains with latitude and longitude in wrong columns and no other info, such sites are filtered in this file


sites <- read_csv(here("./Data/CSV_Data/ukbms_Rogers_sites_10-3-23_to_correct.csv"))

sites.more.info <- read_csv(here("./Data/CSV_Data/ukbmsSiteLocationData1976-2019.csv"))

species <- read_csv(here("./Data/CSV_Data/ukbms_Rogers_species_10-3-23.csv"))

bounds <- readRDS(here("./Data./Input_Environmental_Data./gb_multipolygon_incl_ork_shet.rds"))

bounds.2 <- readRDS(here("./Data./Input_Environmental_Data./gb_multipolygon.rds"))

```


```{r}
head(records)
print("records")
nrow(records)
summary(records$YEAR)
```
## this shows that column names need attention

## inspecting the dataframe shows some info is in the wrong columns
```{r}
head(sites)
nrow(sites)
```



## rename columns in datasets, clean site data
```{r}
#rename columns in sites
names(sites)
sites <- sites %>%
  rename(site = SITENO,
         site.name =  SITENAME,
         gridref = GRIDREF,
         longitude = LONGITUDE,
         latitude = LATITUDE) %>% 
  #here we move values that are in the wrong columns to the correct columns
  mutate(site.name = case_when(paste2cols == 1 ~ paste(site.name, gridref, sep = "_"),
                             paste3cols == 1 ~ paste(site.name, gridref, longitude, sep = "_"),
                             .default = as.character(site.name)),
         gridref = case_when(paste2cols == 1 ~ as.character(longitude),
                             paste3cols == 1 ~ as.character(latitude),
                             .default = as.character(gridref)),
         longitude = case_when(paste2cols == 1 ~ as.numeric(latitude),
                             paste3cols == 1 ~ as.numeric(extracol1),
                             .default = as.numeric(longitude)), 
         latitude = case_when(paste2cols == 1 ~ as.numeric(extracol1),
                             paste3cols == 1 ~ as.numeric(extracol2),
                             .default = as.numeric(latitude))) %>% 
  dplyr::select(-c(extracol1, extracol2, paste2cols, paste3cols))

sites.more.info <- sites.more.info %>%
  dplyr::select(-c("Site Name", "Gridreference", "Easting", "Northing","No. yrs surveyed", "First year surveyed", "Last year surveyed"))
 
names(sites.more.info) <- c("site", "length", "country", "no.sections",  "survey.type" )




#rename columns in species 

species <- species %>% 
  rename( species.no = SPECIES, 
         common.name = COMMON_NAME,
         sci.name = SCI_NAME,
         strategy = STRATEGY,
         habitat = HABITAT) 
#so we can use it for summarising data etc later
species <- species %>% 
  mutate(species.no = as.character(species.no))

#rename columns in records
records<- records %>%
    rename(site = SITE, 
        species.no = SPECIES,
        year = YEAR,
        month = MONTH, 
        day = DAY, 
        week.no = WEEKNO, 
        day.no = DAYNO, 
        count = COUNT)%>% 
   mutate(species.no = as.character(species.no))



print("rows of records")
nrow(records)


print("rows of sites")
nrow(sites)


print("rows of species")
nrow(species)

```

## filter out zero counts to make things go more quickly

```{r}
records <- filter(records, count !=0)


print("rows of records")
nrow(records)


print("rows of sites")
nrow(sites)


print("rows of species")
nrow(species)
```




## combine records for small and essex skipper, including those where observer recorded it as either of the two 
```{r}

str(species)
#contents for new row
new.row <- c ("1000", "Combined Skippers", "Thymelicus lineola-sylvestris", "Wider countryside sp", "Grassland", 1)

species <- species %>%
  rbind(new.row) %>%
  filter(species.no!= 119,
         species.no!= 120)

# all records for small skipper, essex skipper and small/essex skipper recoded as species 1000
table(records$species.no)
records1 <- records %>% 
 mutate(species.no = case_match(species.no, c("119", "120", "200") ~ "1000", .default = species.no))
table(records1$species.no)
```
```{r}

print("rows of species")
nrow(species)
```
## filter out non-butterflies and "unidentified" from species

```{r}

species <- species %>%
  filter(include ==1)

print("rows of species")
nrow(species)
```


#remove migrant, note two extinct species  considered extinct before records started, and so any records now are eigher migrants or from butterfly farms, can be removed with migrants

#https://butterfly-conservation.org/butterflies/large-tortoiseshell
#https://butterfly-conservation.org/butterflies/black-veined-white
```{r}

table(species$strategy)

species <- species %>% 
  filter (strategy == "Wider countryside sp"| strategy == "Habitat specialist",
          species.no != 66) #Large Copper Lycaena dispar is considered a habitat specialist but only present in a few sites and years following failed reintroduction attempts


records <- records %>%
  filter(species.no %in% species$species.no)

sites <- sites %>% 
  filter(site %in% unique(records$site))


print("records after removing migrants and extinct")
nrow(records)


print("sites after removing non-butterflies and unidentified")
nrow(sites)

print("species after removing non-butterflies and unidentified")
nrow(species)

```

#filter sites to those represented in records

# merge in additional site info
```{r}

# some sites  were not in site data from Rob , they must have been filtered out from the data he used for some reason
print("number of sites before merging operation")
nrow(sites)

sites <- merge(sites, sites.more.info, by = "site", all.x = TRUE)

print("number of sites after merging operation")
nrow(sites)

names(sites)

table(sites$survey.type)

```


```{r}



sites <- sites %>% 
  filter(site %in% unique(records$site))


print("sites after removing sites not represented in records")
nrow(sites)

table(sites$survey.type)
```
## sites with inadequate locality info were nor represented in records, already removed
```{r}

# for inspection only, sites that have no co-ordinates or grid square reference
bad.sites <- filter(sites, is.na(longitude) == T &  is.na(gridref) ==T, 
                    gridref != "Lurgan")



#the sites with inadequate info were not in records data

print("number of sites with inadequate locality info")
nrow(bad.sites)

```




#remove irish sites, which have uneven number of characters in the gridref (they start with a single letter)


```{r}


table(sites$country)

#can be used
sites <- sites%>%
  filter(country != "Channel Isles" & country != "Isle of Man" & country != "Northern Ireland",
               site != 1791 & site != 1837)  
                   


records <- records %>% 
  filter(site %in% sites$site)



species <- species %>% 
  filter (species.no %in% records$species.no) #species after filtering out Ireland,  Channel Islands, Lundy, Scilly, Isle of Man"


print("number of sites after filtering sites in Ireland, Channel Islands, Lundy, Scilly, Isle of Man")
nrow(sites)

print("records after filtering sites in Ireland, Channel Islands, Lundy, Scilly, Isle of Man")
nrow(records)



print("species after filtering sites in Ireland, Channel Islands, Lundy, Scilly, Isle of Man")
nrow(species)



table(sites$country)
```





#add easting and northing
```{r}
#check if all sites have latitude
any(is.na(sites$latitude))

#obtain longitude and latitude using sgo

#get easting and northing for points with latitude and longitude
pts <- sgo_points(sites, coords = c("longitude", "latitude"), epsg=4277)#this epsg for long and lat
bng.pts1 <- sgo_lonlat_bng(pts)

#get national gridref 1 km scale 
points2 <- sgo_bng_ngr(bng.pts1, digits = 4)

#put coords and ngr into a dataframe
pts.df1 <- as.data.frame(bng.pts1)
pts.df1 <- pts.df1 %>%
  mutate(ngr.1km = points2$ngr,
         ngr.1km = str_replace_all(ngr.1km, fixed(" "), ""))#get rid of white spaces

pts.df1 <- pts.df1 %>% 
 
  dplyr::select(x, y, ngr.1km, site)
 

# add this info to sites dataframe

print("number of sites before merging operation")
nrow(sites)
sites<- merge(sites, pts.df1, by = "site")
 print("number of sites after merging operation")
 nrow(sites)
 
 
   

```




## Plot Sites
```{r}
# 
# plot.points <- st_as_sf(sites, coords=c("easting","y"), remove = FALSE, crs = 27700)#I want to keep coords in the dataframe
# 
# #get a set of points for each unique grid cell
# 
# print("sites")
# nrow(plot.points)
# 
# basemap <-tm_shape(bounds) +
#   tm_borders()
# pointsmap <- basemap + 
# tm_shape(plot.points) +
#   tm_symbols(size = 0.05, col = "blue")
# 
# pointsmap2 <- basemap + 
# tm_shape(plot.points) +
#   tm_symbols(size = 0.5, col = "blue")
# 
# 
# print(pointsmap)
# print(pointsmap2)
```

## add columns to records to identify survey events and site-year combinations


```{r}

#create columns to identify survey events and site-year combinations
records<- records %>%
  mutate(survey.info = paste(site, year, month, day, week.no, sep = "_"),
         site.year.month = paste(site, year, month, sep = "_"),
         site.year = paste(site, year, sep = "_"))

```




## create a dataframe with one row for every year-site combination number of months for each site year (only when surveys carried out,no zeros)


```{r}
#find out how many months each site was surveyed each year and plot versus latitude
sum.months <- records %>% 
  distinct(site.year.month, .keep_all = TRUE) %>%
  group_by(site, year)%>%
  summarise(months.surveyed = n())

#add data to make a plot
sum.months <- sum.months %>% 
      merge(
        select(
          sites, site, x, y), by = "site")  %>% 
  mutate(site.year = paste(site, year, sep = "_"))

table(as.character(sum.months$months.surveyed))

#small tendency for more northerly sites to be surveyed in fewer months
plot(months.surveyed~y, data = sum.months)

#this is exploration, should be averaged per site first really
m1 <- lm(months.surveyed~y, data = sum.months)

summary(m1)

```






## Get vectors of sites time periods

```{r}

# a function to get a vector of site names for sites sampled in a r period
#x should be the above site.and.year
#condit is a condition to filter by

#filter_() might stop working, deprecated...
get.sites.in.date.range <- function(x, condit){
  sites.out <- x %>%
  filter_(condit)%>%
   dplyr::select(site)%>%
      distinct

sites.out <- sites.out[['site']]
  return(sites.out)
}

# dataframe of sites and years sampled
site.and.year <- dplyr::select(records, site, year)

sites.5.years <- get.sites.in.date.range(site.and.year, "year >= 2015 & year <=2019")


# sites.1975 <- get.sites.in.date.range(site.and.year, "year == 1975")
# sites.1980 <- get.sites.in.date.range(site.and.year, "year == 1980")
# sites.1985 <- get.sites.in.date.range(site.and.year, "year == 1985")
# sites.1990 <- get.sites.in.date.range(site.and.year, "year == 1990")
# sites.1995 <- get.sites.in.date.range(site.and.year, "year == 1995")
# sites.2000 <- get.sites.in.date.range(site.and.year, "year == 2000")
# sites.2005 <- get.sites.in.date.range(site.and.year, "year == 2005")
# sites.2010 <- get.sites.in.date.range(site.and.year, "year == 2010")
# sites.2015 <- get.sites.in.date.range(site.and.year, "year == 2015")
# sites.2016 <- get.sites.in.date.range(site.and.year, "year == 2016")
# sites.2017 <- get.sites.in.date.range(site.and.year, "year == 2017")
# sites.2018 <- get.sites.in.date.range(site.and.year, "year == 2018")
# sites.2019 <- get.sites.in.date.range(site.and.year, "year == 2019")
# sites.2022 <- get.sites.in.date.range(site.and.year, "year == 2022")
# 
# 
# site.snapshots.to.map <- list(
#   sites.1975,
#   sites.1980, 
#   sites.1985, 
#   sites.1990, 
#   sites.1995, 
#   sites.2000, 
#   sites.2005,
#   sites.2010,
#   sites.2015,
#   sites.2018, 
#   sites.2019, 
#  sites.2022)


```
## check the distribution of surveys over sampling weeks and make a variable for records which denotes which sampling period in the year each survey was done. Summarise to find the number of years for each site (2015-2019) that sampling happened in all 4 sampling periods covering March-September and add the info to records
```{r}
table(records$week.no)

names(records)

check <- distinct(records, week.no, .keep_all = TRUE)

#divide the prescribed sampling period into 4 quarters
#to have same length, i incluce last week of March (week 0) in first period and first week of October in 4th period

records <- mutate(records, 
                  sampling.period = case_match(week.no,
                    -7:-1 ~ "pre-april",
                    0:6 ~ "per1",
                    7: 13 ~ "per2",
                    14:20 ~ "per3",
                    21:27 ~ "per4",
                    28:40 ~ "post-september"))

#get the number of surveys per period in each site in each year
surveys.by.period <- records %>%
  distinct(survey.info, .keep_all = TRUE) %>%
  group_by(site, year, sampling.period) %>%
          summarise(surveys.per.period = n())


#make number of surveys per period into columns by pivot wider
surveys.by.period2 <- surveys.by.period %>%
  pivot_wider(names_from = sampling.period,
              values_from = surveys.per.period,
              values_fill = 0)  %>%
  mutate(site.year = paste(site, year, sep = "_"), 
         all.4 = per1 > 0 & per2 > 0 & per3 > 0 & per4 > 0) %>% #this is the criterion for inclusion, being sampled in all 4 periods
  ungroup()


#get the site-years with sampling in all 4 periods in 2015 to 2019
surveys.by.period3  <- surveys.by.period2 %>% 
  filter(all.4 = TRUE, 
         year %in% 2015:2019) %>% 
  group_by(site) %>%
  summarise(well.sampled.years = n())

#Check how many sites were well sampled in 1, 2 , 3, 4 or 5 years
table(surveys.by.period3$well.sampled.years)

surveys.all.4 <- select(surveys.by.period2, site.year, all.4)


records <- merge(records, surveys.all.4, by = "site.year", all.x = TRUE)

#add this info to records
records <- merge(records, surveys.by.period3, by = "site", all.x = TRUE)

check <- head(records, 100)

  
```



```{r}


print("filter to 2015-2019")
records.keep <- records %>% 
  filter(year %in% 2015:2019)

print("number of records")
nrow(records.keep)


print("number of sites")
length(unique(records.keep$site))

print("number of species")
length(unique(records.keep$species.no))

print("filter to sites with two well sampled years")

records.keep <- records.keep %>% 
  filter(well.sampled.years >= 2)

print("number of records")
nrow(records.keep)


print("number of sites")
length(unique(records.keep$site))

print("number of species")
length(unique(records.keep$species.no))
```


```{r}
#summarise records to get records per site per years

records.site.5.year <-  records.keep %>%
  group_by (site, year, species.no)  %>% 
summarise(annual.records = sum(count))   %>% 
  mutate(site.year = paste(site, year, sep = "_")) 


print("number of sites")
length(unique(records.site.5.year$site))

print("number of species")
length(unique(records.site.5.year$species.no))


```


## Get records per species per year, filtered to only site-year combinations that meet : 
##months with survey records: >= 5, for at least three years

### records.site.year gives the number of records for each species in each site in each year

```{r}

 


# 
# #how many years per site for the years 2015-2019 in the filtered data?
# sum.5.year <- sum.months %>% 
#   dplyr::select(site.year, site, year, months.surveyed) %>%
#   filter(year %in% 2015:2019) %>%
#   group_by(site) %>%
#   summarise(years.15.19 = n())
#   
# print("number of sites in 2015-2019")
# nrow(sum.5.year )
# 



#old criterion, at least 5 months sampled
# sum.5.year <- sum.months %>% 
#   dplyr::select(site.year, site, year, months.surveyed) %>%
#   filter(year %in% 2015:2019,
#         months.surveyed >=5 ) %>%
#   group_by(site) %>%
#   summarise(years.15.19 = n())
#   
# print("number of sites in 2015-2019 with at least 5 months data")
# nrow(sum.5.year )

#how many years per site for the years 2015-2019 with at least 5 months data?

# 
# #This is mostly a copy and paste with 4th line below added
# sum.5.year <- sum.months %>% 
#   dplyr::select(site.year, site, year, months.surveyed) %>%
#   filter(year %in% 2015:2019,
#         well.sampled.years >=2 ) %>%
#   group_by(site) %>%
#   summarise(years.15.19 = n())
#   
# print("number of sites in 2015-2019 with at least 5 months data")
# nrow(sum.5.year )
# 
# 
# table(sum.5.year$years.15.19)
# 
# sites.keep <- filter(sum.5.year,
#                      years.15.19 >= 2)
#   
# #site year combinations to keep (site-years surveyed in at least 5 months, sites with at least two years such data)  
# site.years.keep <- sum.months %>%
#   filter(year %in% 2015:2019,
#          months.surveyed >=5,
#          site %in% sites.keep$site) 
# 
# print("number of sites in 2015-2019 with years surveyed in at least 5 months, sites with at least two  years such data")
# length(unique(site.years.keep$site) )
# 
# 
# #filter records per site per year 2015-2019
# records.site.5.year <-  records.site.year %>%
#   filter(site.year %in% site.years.keep$site.year)
# 
# 
# print("records in 2015-2019 dataset")
# nrow(records.site.5.year)
# 
# #check it is the same number of sites
# print("remaining sites in 2015-2019 dataset")
# length(unique(records.site.5.year$site))
# 
# print("species in 2015-2019 dataset")
# length(unique(records.site.5.year$species.no))
# 
# 
# print("number of sites before merging operation")
# nrow(sites)
# sites <- merge(sites, sum.5.year, by = "site", all.x = TRUE)
# print("number of sites after merging operation")
# nrow(sites)


```




```{r}
head(records.site.5.year)
```


# Get site by species count matrix
```{r}


records.site.5.year$species.no <- paste("species", records.site.5.year$species.no, sep = "_")

aggregated.records <- records.site.5.year %>%
  dplyr::select(-site.year)%>%
  group_by(site, species.no)%>%
    summarise(total.records = sum(annual.records))
  

#get a site by species dataframe with counts of observations
site.by.obs.5.year.counts <- aggregated.records %>%
  pivot_wider(names_from = species.no,
              values_from = total.records,
              values_fill = 0) %>% # for cases when there wasn't a zero count record for a species that wasn't recorded in a survey, should still be zero
  column_to_rownames(var = "site")


```

```{r}




print("sites and species in matrix")
dim(site.by.obs.5.year.counts)
#make a presence absence site by species matrix
site.by.obs.5.year.presabs <- site.by.obs.5.year.counts

site.by.obs.5.year.presabs[site.by.obs.5.year.presabs[, ] > 0] <- 1


print("sites in 2015-2019 dataset")
nrow(site.by.obs.5.year.presabs)
```






#check coverage

#sites filtered down to those with adequate coverage
```{r}

#Transpose sity by counts matrix for use  by iNEXT package functions
check.coverage <- t(site.by.obs.5.year.counts)


#DataInfo() performs the first part of what iNEXT() does in seconds. the whole iNEXT() function would have to be left overnight for the whole dataset
#https://cran.r-project.org/web/packages/iNEXT/vignettes/Introduction.pdf

coverage <- DataInfo(check.coverage,  datatype="abundance")

hist(coverage$SC)

hist(coverage$SC, ylim = c(0, 50))


hist(coverage$SC, xlim = c(0.95, 1), breaks = 1000)

quantile(coverage$SC, seq(from = 0, to = 1, by = 0.01))


#it seems reasonable to include sites with greater than 0.9 coverage and surveyed over at least 5 months in at least three years

cov.merge <- coverage %>%
  dplyr::select(Assemblage, n, S.obs, SC) 
names(cov.merge) <- c("site", "total.butterflies", "richness", "coverage")




```




```{r}

sites.15.19 <- sites %>%
  filter(site %in% cov.merge$site)

sites.15.19 <- merge(
  sites.15.19, cov.merge, by = "site"
)


sum3 <- sites.15.19 %>%
  group_by(survey.type) %>%
  summarise(n = n(),
            mean.richness = mean(richness),
            mean.individuals = mean(total.butterflies),
            mean.coverage = mean(coverage)
      )
sum3

```


#I think we should check sensitivity to different coverage thresholds
```{r}
plot(richness~coverage, data = sites.15.19)

plot(richness~coverage, data = sites.15.19, xlim = c(0.96, 1))

# Step 1: Call the pdf command to start the plot
pdf(file = "rich+cov.pdf",  
    width = 4, # The width of the plot in inches
    height = 4) # The height of the plot in inches

plot(richness~coverage, data = sites.15.19, xlim = c(0.96, 1))


# Step 3: Run dev.off() to create the file!
dev.off()

m2 <- lm(richness~coverage, data = sites.15.19)

summary(m2)

check<- filter(sites.15.19, coverage >= 0.99)
m3 <- lm(richness~coverage, data = check)


check1<- filter(sites.15.19, coverage >= 0.9975)
m4 <- lm(richness~coverage, data = check1)


summary(m4)
```

```{r}
library(segmented)


m5<- segmented(m2, psi = c(0.995))

summary(m5)

plot(m5)

plot(m5, xlim = c(0.95,1), res=TRUE, col=2, conf.level=.95)
```


#filter to sites with sufficient coverage and effort

#filter site by species matrix to selected sites
```{r}

print("number of sites before filtering out adequate coverage ")
nrow(sites.15.19)

sites.spatial <- sites.15.19 %>% 
                filter(coverage >= 0.99)

print("minimum coverage in selected sites")
min(sites.spatial$coverage)

print("number of sites after filtering out adequate coverage and years of sampling")
nrow(sites.spatial)

#this is the one to export!
site.by.obs.5.year.presabs1 <- site.by.obs.5.year.presabs %>%
  filter(rownames(site.by.obs.5.year.presabs) %in% sites.spatial$site)

table(sites$country)
```


## Plot Sites
```{r}
# 
# plot.points <- st_as_sf(sites.spatial, coords=c("x","y"), remove = FALSE, crs = 27700)#I want to keep coords in the dataframe
# # 
# # #get a set of points for each unique grid cell
# # 
# print("sites.15.19")
# nrow(plot.points)
# 
# basemap <-tm_shape(bounds.2) +
#   tm_borders()
# pointsmap <- basemap +
# tm_shape(plot.points) +
#   tm_symbols(size = 0.05, col = "blue")
# 
# pointsmap2 <- basemap +
# tm_shape(plot.points) +
#   tm_symbols(size = 0.5, alpha = 0.5, col = "blue")
# 
# 
# print(pointsmap)
# print(pointsmap2)
# 
# pdf(file = "map_sites.pdf",  
#     width = 4, # The width of the plot in inches
#     height = 4) # The height of the plot in inches
# 
# print(pointsmap2)
# 
# 
# # Step 3: Run dev.off() to create the file!
# dev.off()

```


#filter records to site.years with sampling in all 4 periods
```{r}
records.multiyear <- records %>%
  filter(all.4 == TRUE)
print("all 4 sampling periods")
print("records")
nrow(records.multiyear)
print("sites")
length(unique(records.multiyear$site))


```
```{r}

records.multiyear$species.no <- paste("species", records.multiyear$species.no, sep = "_")

aggregated.records.multiyear <- records.multiyear %>%
  group_by(site, year, species.no)%>%
    summarise(annual.records = sum(count))
  

#get a site.year by species dataframe with counts of observations
multiyear.site.year.counts <- aggregated.records.multiyear %>%
  pivot_wider(names_from = species.no,
              values_from = annual.records,
              values_fill = 0) %>% # for cases when there wasn't a zero count record for a species that wasn't recorded in a survey, should still be zero
  mutate (site.year = paste(site, year, sep = "_")) %>% 
    column_to_rownames(var = "site.year")%>%
      dplyr::select(-c(site, year))


```


#coverage of site years
```{r}
#DataInfo() performs the first part of what iNEXT() does in seconds. the whole iNEXT() function would have to be left overnight for the whole dataset
#https://cran.r-project.org/web/packages/iNEXT/vignettes/Introduction.pdf

coverage.multi <- DataInfo(t(multiyear.site.year.counts),  datatype="abundance")

hist(coverage.multi$SC)

hist(coverage.multi$SC, ylim = c(0, 200))


hist(coverage.multi$SC, xlim = c(0.95, 1), breaks = 1000)

quantile(coverage.multi$SC, seq(from = 0, to = 1, by = 0.01), na.rm = TRUE)


#it seems reasonable to include sites with greater than 0.9 coverage.multi and surveyed over at least 5 months in at least three years

cov.merge.multi <- coverage.multi %>%
  dplyr::select(Assemblage, n, S.obs, SC) 
names(cov.merge.multi) <- c("site.year", "total.butterflies", "richness", "coverage.multi")


records.multiyear <- merge(records.multiyear, cov.merge.multi, by = "site.year")

head(records.multiyear)

```



#filter records to sites.years with over.99% coverage
```{r}
records.multiyear <- records.multiyear %>%
  filter(coverage.multi >= 0.99)
print("99% coverage")
print("records")
nrow(records.multiyear)
print("sites")
length(unique(records.multiyear$site))


```


## For eligible site years, as filtered above
## check distribution of number of surveys per site per year, plot number of sites surveyed per year in dataset, add years of surveys per site to site info
```{r}


#surveys per site per year
surveys.site.year <-   records.multiyear %>% 
  distinct(survey.info, .keep_all = TRUE) %>%
  group_by (site, year)  %>% 
summarise(n = n())

#inspect frequency distribution of surveys per site per year
print("surveys per site per year")
summary(surveys.site.year$n)
hist(surveys.site.year$n, main = "Surveys per site per year")

sum2 <- surveys.site.year %>%
  mutate(n = as.character(n)) %>%
  group_by(n) %>%
      summarise(freq.survey = n())
sum2

#get plot of sites surveyed per year by year
sites.per.year <- surveys.site.year %>% 
  group_by(year)%>% 
summarise(sites = n())
print("sites per year")
summary(sites.per.year$sites)
plot(sites~year, data = sites.per.year)

#years per site summary and histogram
years.per.site <- surveys.site.year %>% 
  group_by(site)%>% 
summarise(years.surveyed = n(),
          first.year = min(year),
          last.year = max(year))


print("years per site")
summary(years.per.site$years.surveyed)
hist(years.per.site$years.surveyed, xlim  = c(0, 50))


print("number of sites before merging operation")
nrow(sites)
sites <- merge(sites, years.per.site)  
print("number of sites after merging operation")
nrow(sites)
```

#filter records to site.years sampled at least more than 10 years apart
```{r}
years.per.site <-years.per.site %>%
  mutate(timespan = last.year-first.year) 

plot(timespan~years.surveyed, data = years.per.site)

years.per.site <-years.per.site %>%
   filter(years.surveyed>=10)


records.multiyear <- records.multiyear %>%
 merge(years.per.site, by = "site", all.y = TRUE)


print("ten or more years of surveys")
print("records")
nrow(records.multiyear)
print("sites")
length(unique(records.multiyear$site))
```



#over-write previous vesins
```{r}

aggregated.records.multiyear <- records.multiyear %>%
  group_by(site, year, species.no)%>%
    summarise(annual.records = sum(count))
  

#get a site.year by species dataframe with counts of observations
multiyear.site.year.counts <- aggregated.records.multiyear %>%
  pivot_wider(names_from = species.no,
              values_from = annual.records,
              values_fill = 0) %>% # for cases when there wasn't a zero count record for a species that wasn't recorded in a survey, should still be zero
  mutate (site.year = paste(site, year, sep = "_")) %>% 
    column_to_rownames(var = "site.year")%>%
      dplyr::select(-c(site, year))



multiyear.site.year.pres.abs <- multiyear.site.year.counts


multiyear.site.year.pres.abs[multiyear.site.year.pres.abs[, ] > 0] <- 1 


```




## surveys
```{r}

# #years per site summary and histogram
# years.per.site <- surveys.site.year %>% 
#   mutate(site.year = paste(site, year, sep = "_")) %>%
#   filter(site.year %in% site.years.keep$site.year)%>%
#   group_by(site)%>% 
# summarise(years.surveyed.well = n(),
#           first.year.well = min(year),
#           last.year.well = max(year)) %>%
#   ungroup() 
# 
# print("number of rows before merging")
# nrow(sites)
# sites.multiyear <- sites %>%
#   merge(years.per.site, by = "site")
# print("number of rows after merging")
# nrow(sites)
# 
# str(years.per.site)
# 
# str(sites.multiyear)

```




## Plot Sites
```{r}

sites.multiyear <- sites %>%
filter(sites$site %in% unique(records.multiyear$site))

plot.points <- st_as_sf(sites.multiyear, coords=c("x","y"), remove = FALSE, crs = 27700)#I want to keep coords in the dataframe

#get a set of points for each unique grid cell

print("sites.15.19")
nrow(plot.points)

 basemap <-tm_shape(bounds.2) +
   tm_borders()
# pointsmap <- basemap +
# tm_shape(plot.points) +
#   tm_symbols(size = 0.05, col = "blue")

pointsmap2 <- basemap +
tm_shape(plot.points) +
  tm_symbols(size = 0.5, col = "blue")


# print(pointsmap)
print(pointsmap2)
```

## Check why multiyear ends up with 56 instead of 55 species???


# save processed data
```{r}

write_rds(site.by.obs.5.year.presabs1, file = here("./Data/Processed_Data/site_by_obs_5_year_pres_abs.rds"))

write_rds(species, file = here("./Data/Processed_Data/species_5_year.rds"))

write_rds(sites.spatial, file = here("./Data/Processed_Data/processed_5_year_sites.rds"))


write_rds(multiyear.site.year.pres.abs, file = here("./Data/Processed_Data/multiyear_site_year_pres_abs.rds"))

#write_rds(records, file = here("./Data/Processed_Data/processed_records.rds"))

#write_rds(sites, file = here("./Data/Processed_Data/processed_sites.rds"))



#write_rds(species, file = here("./Data/Processed_Data/processed_species.rds"))
#write_rds(site.snapshots.to.map, file = here("./Data/Processed_Data/site_snapshots_to_map.rds"))

```




