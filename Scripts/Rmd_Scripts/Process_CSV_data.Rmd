---
title: "Process_butterflies"
output: html_notebook
---



## Data cleaning, obtaining site by species matrices
```{r}

here::i_am("Scripts//Rmd_Scripts//Process_CSV_data.Rmd")

library(conflicted)
library(tidyverse)
library(here)

#library(foreach)
#library(doParallel)
#library(doSNOW)

library(spaa)

library(sgo)

library(sf)

library(tidyterra)

library(scales)

library(segmented)

library(tmap)

library(Hmisc)


library(iNEXT)

conflicts_prefer(snow::stopCluster)
conflicts_prefer(snow::makeCluster)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::mutate)
conflicts_prefer(dplyr::select)
#filter <- dplyr::filter


```


```{r}
#(cl = makeCluster(parallel::detectCores()-2, type = "SOCK")) # Initialize all cores except for two
#registerDoSNOW(cl)


records <- read_csv(here("./Data/CSV_Data/ukbms_Rogers_10-3-23.csv"))

#In the CSV, I  added in column headings, did a sort and added in extra columns to help correct entries in incorrect columns
#note, some sites have incomplete info, one site remains with latitude and longitude in wrong columns and no other info, such sites are filtered in this file


sites <- read_csv(here("./Data/CSV_Data/ukbms_Rogers_sites_10-3-23_to_correct.csv"))

sites.more.info <- read_csv(here("./Data/CSV_Data/ukbmsSiteLocationData1976-2019.csv"))

species <- read_csv(here("./Data/CSV_Data/ukbms_Rogers_species_10-3-23.csv"))

bounds <- readRDS(here("./Data./Input_Environmental_Data./gb_multipolygon_incl_ork_shet.rds"))

bounds.2 <- readRDS(here("./Data./Input_Environmental_Data./gb_multipolygon.rds"))

```

```{r}
head(records)
summary(records$YEAR)
```
## this shows that column names need attention

## inspecting the dataframe shows some info is in the wrong columns
```{r}
head(sites)
nrow(sites)
```

## clean and organise site data
```{r}

#rename columns
names(sites)
sites <- sites %>%
  rename(site = SITENO,
         site.name =  SITENAME,
         gridref = GRIDREF,
         longitude = LONGITUDE,
         latitude = LATITUDE) %>% 
  #here we move values that are in the wrong columns to the correct columns
  mutate(site.name = case_when(paste2cols == 1 ~ paste(site.name, gridref, sep = "_"),
                             paste3cols == 1 ~ paste(site.name, gridref, longitude, sep = "_"),
                             .default = as.character(site.name)),
         gridref = case_when(paste2cols == 1 ~ as.character(longitude),
                             paste3cols == 1 ~ as.character(latitude),
                             .default = as.character(gridref)),
         longitude = case_when(paste2cols == 1 ~ as.numeric(latitude),
                             paste3cols == 1 ~ as.numeric(extracol1),
                             .default = as.numeric(longitude)), 
         latitude = case_when(paste2cols == 1 ~ as.numeric(extracol1),
                             paste3cols == 1 ~ as.numeric(extracol2),
                             .default = as.numeric(latitude))) %>% 
  dplyr::select(-c(extracol1, extracol2, paste2cols, paste3cols))


# for inspection only, sites that have no co-ordinates or grid square reference
bad.sites <- filter(sites, is.na(longitude) == T &  is.na(gridref) ==T)

#remove irish sites, which have uneven number of characters in the gridref (they start with a single letter)
sites <- sites %>%
                mutate(str.len.gridref = str_length(gridref),# a variable showing number of characters in gridref
                       even = str.len.gridref %% 2 == 0)  #whether above variable is even


irish.sites <- filter(sites, even == F)  #for inspection only

#can be used
sites <-  filter(sites, is.na(longitude) == F |  is.na(gridref) == F,#remove 51 sites with neither a gridref nor longlat
                even == T) %>% #filter 138 Irish sites
                    dplyr::select(-c(even, str.len.gridref))

#one wonky site not picked up above
sites <- filter(sites, gridref != "Lurgan") 


         
```


```{r}
dplyr::last_dplyr_warnings()
head(species)
nrow(species)
```
#add in missing longitude and latitude for 20 sites
```{r}

#obtain longitude and latitude using sgo

#just work with rows with missing dtaa
for.longlat <- sites %>% 
  filter(is.na(longitude) == TRUE)

#get eastings and northings first
for.longlat <- sgo_ngr_bng(for.longlat, col = "gridref")

#get latitude and longitude
for.longlat <- sgo_bng_lonlat(for.longlat)

#get a dataframe of rows with missing dat to add them into
check <-sites %>%
filter(is.na(longitude) == TRUE) %>%
  rename(long = longitude, 
         lat = latitude)

#add in longitude and latitude
check$long <- for.longlat$x


check$lat <- for.longlat$y


check <- dplyr::select(check,
                site, long, lat)

#merge with the sites data
sites <- merge(sites, all = T, check, by = "site")

#put data into the correct column and remove now extraneous columns

sites <- sites %>%
  mutate(
    longitude = ifelse(is.na(longitude) == TRUE, long, longitude),
    latitude = ifelse(is.na(latitude) == TRUE, lat, latitude)
  ) %>%
  dplyr::select(-c(lat, long))

#get easting and wesing for points with latitude and longitude
pts <- sgo_points(sites, coords = c("longitude", "latitude"), epsg=4277)#this epsg for long and lat
bng.pts1 <- sgo_lonlat_bng(pts)


pts.df1 <- as.data.frame(bng.pts1)

pts.df1 <- pts.df1 %>% 
  rename(
       easting = x,
       northing = y) %>% 
  dplyr::select(easting, northing, site)
  


# put together eastings 


sites<- merge(sites, pts.df1, by = "site")
 
```




## Plot Sites
```{r}
# 
# plot.points <- st_as_sf(sites, coords=c("easting","northing"), remove = FALSE, crs = 27700)#I want to keep coords in the dataframe
# 
# #get a set of points for each unique grid cell
# 
# print("sites")
# nrow(plot.points)
# 
# basemap <-tm_shape(bounds) +
#   tm_borders()
# pointsmap <- basemap + 
# tm_shape(plot.points) +
#   tm_symbols(size = 0.05, col = "blue")
# 
# pointsmap2 <- basemap + 
# tm_shape(plot.points) +
#   tm_symbols(size = 0.5, col = "blue")
# 
# 
# print(pointsmap)
# print(pointsmap2)
```


#filter species and records to exclude unknown species and moths, as well as surveys where no butterflies were seen,  and migrant, vagrant, extinct species

```{r}

#rename columns in species and...

species <- species %>% 
  rename( species.no = SPECIES, 
         common.name = COMMON_NAME,
         sci.name = SCI_NAME,
         strategy = STRATEGY,
         habitat = HABITAT) %>% 
  filter (is.na(include) == FALSE,
          strategy == "Wider countryside sp"| strategy == "Habitat specialist") #filter out non-butterflies and "unidentified" from species list

#so we can use it for summarising data etc later
species <- species %>% 
  mutate(species.no = as.character(species.no))

#rename columns in records
records<- records %>%
    rename(site = SITE, 
        species.no = SPECIES,
        year = YEAR,
        month = MONTH, 
        day = DAY, 
        week.no = WEEKNO, 
        day.no = DAYNO, 
        count = COUNT)%>% 
   mutate(species.no = as.character(species.no))

print("rows of records")
nrow(records)

records <- records %>% 
  filter (species.no %in% species$species.no) #this filters out records that were not butterflies or were not identified
      

print("rows of records")
nrow(records)


records <- records %>% 
  filter ( site %in% sites$site)


print("rows of records")
nrow(records)

```

```{r}

#create columns to identify survey events and site-year combinations
records<- records %>%
  mutate(survey.info = paste(site, year, month, day, week.no, sep = "_"),
         site.year.month = paste(site, year, month, sep = "_"),
         site.year = paste(site, year, sep = "_"))

surveys <- records %>% 
  distinct(survey.info, .keep_all = TRUE)

#find out how many months each site was surveyed each year
survey.months <- records %>% 
  distinct(site.year.month, .keep_all = TRUE)

sum.months <- survey.months %>%
  group_by(site, year)%>%
  summarise(months.surveyed = n())

table(as.character(sum.months$months.surveyed))

to.merge <- select(sites,
                   site, easting, northing)

sum.months <- merge(sum.months, to.merge, by = "site")

plot(months.surveyed~northing, data = sum.months)

m1 <- lm(months.surveyed~northing, data = sum.months)

summary(m1)

#surveys per site per year
sum1 <-  surveys %>%
  group_by (site, year)  %>% 
summarise(n = n())
print("surveys per site per year")
summary(sum1$n)
hist(sum1$n, main = "Surveys per site per year")

sum2 <- sum1 %>%
  mutate(n = as.character(n)) %>%
  group_by(n) %>%
      summarise(freq.survey = n())
sum2

#get plot of sites surveyed per year by year
sites.per.year <- sum1 %>% 
  group_by(year)%>% 
summarise(sites = n())
print("sites per year")
summary(sites.per.year$sites)
plot(sites~year, data = sites.per.year)

#years per site summary and histogram
years.per.site <- sum1 %>% 
  group_by(site)%>% 
summarise(years.surveyed = n(),
          first.year = min(year),
          last.year = max(year))


print("years per site")
summary(years.per.site$years.surveyed)
hist(years.per.site$years.surveyed, xlim  = c(0, 50))



sites <- merge(sites, years.per.site)

```
```{r}
site.and.year <- merge(sum1, sites, by = "site")

str(site.and.year$year)
```


```{r}


#x should be the above site.and.year
#condit is a condition to filter by


#filter_() might stop working, deprecated...
get.sites.in.date.range <- function(x, condit){
  sites.out <- x %>%
  filter_(condit)%>%
   dplyr::select(site)%>%
      distinct

sites.out <- sites.out[['site']]
  return(sites.out)
}


sites.5.years <- get.sites.in.date.range(site.and.year, "year >= 2015 & year <=2019")


sites.1975 <- get.sites.in.date.range(site.and.year, "year == 1975")
sites.1980 <- get.sites.in.date.range(site.and.year, "year == 1980")
sites.1985 <- get.sites.in.date.range(site.and.year, "year == 1985")
sites.1990 <- get.sites.in.date.range(site.and.year, "year == 1990")
sites.1995 <- get.sites.in.date.range(site.and.year, "year == 1995")
sites.2000 <- get.sites.in.date.range(site.and.year, "year == 2000")
sites.2005 <- get.sites.in.date.range(site.and.year, "year == 2005")
sites.2010 <- get.sites.in.date.range(site.and.year, "year == 2010")
sites.2015 <- get.sites.in.date.range(site.and.year, "year == 2015")
sites.2016 <- get.sites.in.date.range(site.and.year, "year == 2016")
sites.2017 <- get.sites.in.date.range(site.and.year, "year == 2017")
sites.2018 <- get.sites.in.date.range(site.and.year, "year == 2018")
sites.2019 <- get.sites.in.date.range(site.and.year, "year == 2019")
sites.2022 <- get.sites.in.date.range(site.and.year, "year == 2022")


site.snapshots.to.map <- list(
  sites.1975,
  sites.1980, 
  sites.1985, 
  sites.1990, 
  sites.1995, 
  sites.2000, 
  sites.2005,
  sites.2010,
  sites.2015,
  sites.2018, 
  sites.2019, 
  sites.2022)


```

# records.site.year gives the number of records for each species in each site in each year

#records.site gives the total number of records for each species in each site over all years

```{r}



records.site.year <-  records %>%
  group_by (site, year, species.no)  %>% 
summarise(annual.records = sum(count))


#records.site.year.1 <- records.site.year

#records.site.year$site <- paste("site", records.site.year$site, sep = "_")
#records.site.year$species.no <- paste("species", records.site.year$species.no, sep = "_")


records.site <-  records %>%
  group_by (site, species.no)  %>% 
summarise(total.records = sum(count))
```
```{r}
head(records.site)
head(records.site.year)
```

# 2015-2019 data

```{r}

#to get the total records for each species in each site over  years:
records.site.5year <- records.site.year %>%
  filter(year %in% 2015:2019) %>% 
  group_by(site, species.no) %>%
  summarise(total.records = sum(annual.records))

records.site.5year$species.no <- paste("species", records.site.5year$species.no , sep = "_")

#get a site by species dataframe with counts of observations
site.by.obs.5.year.counts <- records.site.5year %>%
  pivot_wider(names_from = species.no,
              values_from = total.records) %>%
  column_to_rownames(var = "site")

# change NAs to zeros: these were cases 
site.by.obs.5.year.counts[is.na(site.by.obs.5.year.counts)] <- 0

#aggregate Thymelicus lineola and T.sylvestris records

"#due to difficulties in field identification, we aggregated Essex Skipper Thymelicus lineola and Small #Skipper Thymelicus sylvestris into one taxon) "

site.by.obs.5.year.counts <- site.by.obs.5.year.counts %>%
  mutate(species_1000 = species_119 + species_120) %>%
  dplyr::select(-c(species_119, species_120))

#check if any sites have zero observations
any(rowSums(site.by.obs.5.year.counts) == TRUE)

site.by.obs.5.year.counts <- site.by.obs.5.year.counts[rowSums(site.by.obs.5.year.counts) > 0, ]

#make a presence absence site by species matrix
site.by.obs.5.year.presabs <- site.by.obs.5.year.counts

site.by.obs.5.year.presabs[site.by.obs.5.year.presabs[, ] > 0] <- 1
```

## make a row for combined species in species data 
```{r}

str(species)
#contents for new row
new.row <- c ("1000", "Combined Skippers", "Thymelicus lineola-sylvestris", "Wider countryside sp", "Grassland", 1)

#add new row and remove two old rows
species <- rbind(species, new.row) %>%
  filter(species.no != "119" & species.no !="120")
```



#check coverage
```{r}

#Transpose sity by counts matrix for use  by iNEXT package functions
check.coverage <- t(site.by.obs.5.year.counts)


#DataInfo() performs the first part of what iNEXT() does in seconds. the whole iNEXT() function would have to be left overnight for the whole dataset
#https://cran.r-project.org/web/packages/iNEXT/vignettes/Introduction.pdf

coverage <- DataInfo(check.coverage,  datatype="abundance")

hist(coverage$SC)

hist(coverage$SC, ylim = c(0, 50))


hist(coverage$SC, xlim = c(0.95, 1), breaks = 1000)

quantile(coverage$SC, seq(from = 0, to = 1, by = 0.01))


#it seems reasonable to include sites with greater than 0.95 coverage and surveyed over the flowering period

cov.merge <- coverage %>%
  dplyr::select(Assemblage, n, S.obs, SC)

names(cov.merge) <- c("site", "total.butterflies", "richness", "coverage")

sites <- merge(sites, cov.merge, all.y = T)



```



#prepare additional site info from Rob
```{r}
sites.more.info <- sites.more.info %>%
  dplyr::select(-c("Site Name", "Gridreference", "Easting", "Northing","No. yrs surveyed", "First year surveyed", "Last year surveyed"))
 
names(sites.more.info) <- c("site", "length", "country", "no.sections",  "survey.type" )



#66 here sites  were not in site data from Rob maybe added post 2019?
sites <- merge(sites, sites.more.info, by = "site", all.x = TRUE)

sum3 <- sites %>%
  group_by(survey.type) %>%
  summarise(n = n(),
            richness = mean(richness),
            butterflies = mean(total.butterflies),
            coverage = mean(coverage)
      )
sum3
  
names(sites.more.info)
```

# obtain number of surveys in 2015 to 2019 and how many of these years had surveys
```{r}
sum4<- sum1 %>%
  filter(site %in% sites$site, 
         year %in% 2015:2019)


#sites sampled per year
sum5 <- sum4 %>% 
  mutate(site = as.character(site),
         year = as.character(year))%>%
  group_by(site) %>%
  summarise(years.sampled.15.to.19 = n(),
            total.surveys.15.to.19 = sum(n))


sites <- merge(sites, sum5, by = "site")


```



```{r}
plot(richness~coverage, data = sites)

plot(coverage~total.surveys.15.to.19, data = sites)

plot(coverage~years.sampled.15.to.19, data = sites)

```

## Plot Sites
```{r}

# plot.points <- st_as_sf(sites, coords=c("easting","northing"), remove = FALSE, crs = 27700)#I want to keep coords in the dataframe
# 
# #get a set of points for each unique grid cell
# 
# print("sites")
# nrow(plot.points)
# 
# basemap <-tm_shape(bounds) +
#   tm_borders()
# pointsmap <- basemap + 
# tm_shape(plot.points) +
#   tm_symbols(size = 0.05, col = "blue")
# 
# pointsmap2 <- basemap + 
# tm_shape(plot.points) +
#   tm_symbols(size = 0.5, col = "blue")
# 
# 
# print(pointsmap)
# print(pointsmap2)
```
```{r}
table(sites$country)


sites<- filter(sites,
               country != "Channel Isles" & country != "Isle of Man",
               site != 1791 & site != 1837)

table(sites$country)


#sites 1791 on Lundy in the Solent and 1837 on Scilly isles


```
## Plot Sites
```{r}
# 
# plot.points <- st_as_sf(sites, coords=c("easting","northing"), remove = FALSE, crs = 27700)#I want to keep coords in the dataframe
# 
# #get a set of points for each unique grid cell
# 
# print("sites")
# nrow(plot.points)
# 
# basemap <-tm_shape(bounds.2) +
#   tm_borders()
# pointsmap <- basemap + 
# tm_shape(plot.points) +
#   tm_symbols(size = 0.05, col = "blue")
# 
# pointsmap2 <- basemap + 
# tm_shape(plot.points) +
#   tm_symbols(size = 0.5, col = "blue")
# 
# 
# print(pointsmap)
# print(pointsmap2)
```
#filter to sites with sufficient coverage and effort
```{r}

sites.spatial <- filter(sites,
                coverage >= 0.9,
                total.surveys.15.to.19 >= 30,
                years.sampled.15.to.19 >= 3)
```


## Plot Sites
```{r}

plot.points <- st_as_sf(sites.spatial, coords=c("easting","northing"), remove = FALSE, crs = 27700)#I want to keep coords in the dataframe

#get a set of points for each unique grid cell

print("sites")
nrow(plot.points)

basemap <-tm_shape(bounds.2) +
  tm_borders()
pointsmap <- basemap + 
tm_shape(plot.points) +
  tm_symbols(size = 0.05, col = "blue")

pointsmap2 <- basemap + 
tm_shape(plot.points) +
  tm_symbols(size = 0.5, col = "blue")


print(pointsmap)
print(pointsmap2)
```
#there is a need to check how I get number of years, as one of the chosen sites only has 33

#there is a need to consider criteria for using a year's observations, as some years have few surveys. ? decide on a minimum number of surveys per year

#get year by species matrices for a set of sites
```{r}
#get year by species matrix for all sites with greater than 40 years of records


#get a vector of the chosen sites
use.sites <- sites %>%
  filter(no.yrs.surveyed >= 40)  %>%
    dplyr::select(site) %>%
     unlist() %>%
        as.numeric

#make a list to year by species matrices (which are actually dataframes)
year.by.species.matrices <- list()

for (i in 1:length(use.sites)){
   one.site.over.years.data <- records.site.year %>%
      filter(site == use.sites[i]) 
     
   
one.site.over.years.data$species.no <- paste("species", one.site.over.years.data$species.no, sep = "_")
   
    year.by.species.matrices[[i]] <-  one.site.over.years.data %>%
  
  pivot_wider(names_from = species.no,
              values_from = annual.records) %>%
  ungroup() %>%
  
  dplyr::select(-(site)) %>%
  
  column_to_rownames(var = "year")
        
  }

head(year.by.species.matrices[[20]])
head(year.by.species.matrices[[43]])




#name the list elements after the sites
namevec <- vector()

length(namevec)<- length(use.sites)

  for (i in 1:length(use.sites)){
namevec[i] <- paste("site",  use.sites[i], sep = "_")
  }

names(year.by.species.matrices) <- namevec

#inspect output
str(year.by.species.matrices, max.level = 1)

check1 <- year.by.species.matrices[[1]]

head(year.by.species.matrices[[1]])

#I think change to presence absence later

```


# save processed data
```{r}
#write_rds(records.site, file = here("./Data/Processed_Data/records_site_year_all_years.rds"))


write_rds(site.year.by.species, file = here("./Data/Processed_Data/site_year_by_species.rds"))
write_rds(records, file = here("./Data/Processed_Data/processed_records.rds"))
write_rds(sites, file = here("./Data/Processed_Data/processed_sites.rds"))
write_rds(species, file = here("./Data/Processed_Data/processed_species.rds"))
write_rds(site.snapshots.to.map, file = here("./Data/Processed_Data/site_snapshots_to_map.rds"))
write_rds(use.sites, file = here("./Data/Processed_Data/sites_with_at_least_40_years.rds"))
write_rds(site.by.species.2015.to.2019, file = here("./Data/Processed_Data/site_by_species_2015_to_2019.rds"))

write_rds(site.by.species.2018, file = here("./Data/Processed_Data/site_by_species_2018.rds"))
write_rds(year.by.species.matrices, file = here("./Data/Processed_Data/year_by_species_matrices.rds"))
write_rds(surveys.site.year, file = here("./Data/Processed_Data/surveys_site_year.rds"))
```




