---
title: "GAMMs"
output: html_document

params:
  dataset: "all_species"
  family: "gaussian"
  spline: "cr"  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Packages
```{r}
here::i_am("Scripts/Rmd_Scripts/GAMM_analyses.Rmd")
library(tidyverse)
library(tmap)
library(mgcv)
library(gstat)
library(knitr)
library(knitrProgressBar)
library(tictoc)
library(here)
library(conflicted)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::select)
conflicts_prefer(knitrProgressBar::progress_estimated)
# there is a same-named function in dplyr, check it out
```

#### Functions
```{r}
# From https://stackoverflow.com/questions/71252509/is-there-a-way-to-get-progress-information-whan-a-chunk-is-running-in-rmarkdown

slow_function <- function(i, .pb=NULL) {  
  update_progress(.pb)  
  Sys.sleep(0.5)  
  i  
}
# create an R6 progress object for
# the number of loops/iterations in the target chunk
```

#### File Paths
```{r}
data_path <- paste0("./Data/Processed_Data/Spatial/", params$dataset, ".rds")

out_path <-  paste0(here("Output/Spatial/GAM"), "/","GAMM", "_" , params$dataset,  "/")

if(!dir.exists(out_path)) dir.create(out_path)
```

#### Data
```{r}
data <- readRDS(here(data_path))

site.by.species <- data$site.by.species
  
site.by.env <- data$site.by.env

site.by.xy <- data$site.by.xy

sites<- data$sites


# combine data for analysis
site.by.env.xy.richness <- cbind(site.by.env, rowSums(site.by.species)) %>%
  cbind(site.by.xy) %>%
rename(species.richness = 'rowSums(site.by.species)')


#inspect 
dup_xy <- sites %>%
  mutate(xy = paste(x,y)) %>%
group_by(xy) %>% 
  filter(n() > 1)

kable(dup_xy)  
  
#remove duplicates for rows with the same x and y coordinates
site.by.env.xy.richness.distinct <- site.by.env.xy.richness %>%
  mutate(xy = paste(x,y)) %>%
  distinct(xy, .keep_all = TRUE)

dup_xy2 <- site.by.xy %>%
  mutate(xy = paste(x,y)) %>%
group_by(xy) %>% 
  filter(n() > 1)

dup_ngr <- sites %>%
  group_by(ngr.1km) %>% 
  filter(n() > 1)

```

```{r}
hist(site.by.env.xy.richness.distinct$species.richness)
```
#### Specify formula
```{r}
my_formula <- if(params$spline == "tp"){
  "species.richness ~ s(mean.ann.temp) + s(log10.mean.ann.rain) + s(topographic.wetness) + s(ph) + s(total.n) + s(tree.density) + s(log10.pesticide.risk) + s(log10.humans)"
  } else  if(params$spline == "cr") {species.richness ~ s(mean.ann.temp, bs="cr") + 
            s(log10.mean.ann.rain, bs="cr") + s(topographic.wetness, bs="cr") + 
            s(ph, bs="cr") + s(total.n, bs="cr") + s(tree.density, bs="cr") + 
            s(log10.pesticide.risk, bs="cr") + s(log10.humans, bs="cr")
  } else {
    stop("There are only formulate for cr and tp splines here")
  }
```


#### GAMMs for different correlation structures 
```{r}
tic()
corStructs <- list(corGaus(form = ~x+y, nugget = TRUE), corExp(form = ~x+y, nugget = TRUE), corLin(form = ~x+y, nugget = TRUE), corRatio(form = ~x+y, nugget = TRUE), corSpher(form = ~x+y, nugget = TRUE) )

pb <- progress_estimated(length(corStructs))

gamm_cor_struct_list <- list()

# Loop through the gamms saving output in list
# Nugget allows non-zero autocorrelation at 0 distance
for (i in 1:length(corStructs)) {
slow_function(i, .pb=pb)
my.gamm <- gamm(my_formula,  data = site.by.env.xy.richness.distinct, method = "REML", family = params$family, correlation = corStructs[[i]])

print(paste0("gamm", corStructs[i]))
print(Sys.time())

gamm_cor_struct_list[[i]] <- my.gamm

}

names(gamm_cor_struct_list) <- c("gamm_corGaus", "gamm_corExp", "gamm_corLin", "gamm_corRatio", "gamm_corSpher")

toc()
```


#### Write output
```{r}
write_rds(gamm_cor_struct_list, file = paste0(here(out_path), "/", params$dataset,"_", params$spline, "_gamm_cor_struct_compare.rds"))
```


