---
title: "GAM species richness"
output: html_document

params:
  dataset: "all_species"
---

## In this code, we look at best family and spline type in GAM, and check 
## variogram for use in GAMM

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Packages
```{r}
here::i_am("Scripts/Rmd_Scripts/GAM_analyses.Rmd")

library(tidyverse)
library(sf)
library(sp)
library(terra)
library(mgcv)
library(knitr)
library(knitrProgressBar)
library(tmap)
library(mgcViz)
library(gstat)
library(here)
library(conflicted)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::select)
conflicts_prefer(knitrProgressBar::progress_estimated)

# there is a same-named function in dplyr, check it out
```

#### Functions
```{r}
# A function for plotting gam relationships with my preferences


my.plot.gam <- function(gam_object){
plot(gam_object, residuals = TRUE, seWithMean = TRUE, shade = TRUE, shift = coef(gam_object)[1], pages = 2) 
}


# a function to make a table for checking if smooths might be zero
check_smooths <- function(gam_obj, capt){
vars <- c("mean.ann.temp", "log10.mean.ann.rain", "topographic.wetness", "ph", 
          "total.n",  "tree.density", "log10.pesticide.risk",  "log10.humans") 
  
gam_obj <- data.frame(cbind(vars, summary(gam_tp)$s.pv))
names(gam_obj) <- c("Var", "p")
gam_obj$p <- as.numeric(gam_obj$p)
gam_obj<- kable(gam_obj, digits = 3, align = "l", caption = capt)
}

# From https://stackoverflow.com/questions/71252509/is-there-a-way-to-get-progress-information-whan-a-chunk-is-running-in-rmarkdown

slow_function <- function(i, .pb=NULL) {  
  update_progress(.pb)  
  Sys.sleep(0.5)  
  i  
}

# create an R6 progress object for
# the number of loops/iterations in the target chunk
```

#### File Paths
```{r}
data_path <- paste0("./Data/Processed_Data/Spatial/", params$dataset, ".rds")

out_path <-  paste0(here("Output/Spatial/GAM"), "/","GAM", "_" , 
                    params$dataset,  "/")

if(!dir.exists(out_path)) dir.create(out_path)
```

#### Data
```{r}
data <- readRDS(here(data_path))

site.by.species <- data$site.by.species
  
site.by.env <- data$site.by.env

site.by.xy <- data$site.by.xy

# gb polygon

gb <- readRDS(here("./Data/Maps/gb_multipolygon_simplified.rds"))

str(gb, max.level = 1)

crs(gb)
```

#### Parameters for this report
```{r}
print(params)
```

#### Environmental variable, easting, northing and richness Pearson and Spearman correlations
```{r}
site.by.env.and.richness <- cbind(site.by.xy) %>%
  cbind(site.by.env, rowSums(site.by.species)) %>% 
  rename(species.richness = 'rowSums(site.by.species)')
  

t1 <- cor(site.by.env.and.richness)
t2 <- cor(site.by.env.and.richness, method = "spearman")

print("Pearson correlation")
t1
print("Spearman correlation")
t2
```

#### Visualise relationships with eachother and richness
```{r}
pairs(site.by.env.and.richness[,3:11])

pairs(site.by.env.and.richness[,c(1, 2, 11)])
pairs(site.by.env.and.richness[, c(3, 4, 5, 11)])
pairs(site.by.env.and.richness[,c(6, 7, 8, 11)])
pairs(site.by.env.and.richness[c(9, 10, 11)])
```

#### Check species richness distribution
```{r}
hist(site.by.env.and.richness$species.richness)
```
#GAMS

#### Compare GAMs with different families
```{r}
# Gaussian
gam_gaussian <- gam(species.richness ~ s(mean.ann.temp) + s(log10.mean.ann.rain) + 
                s(topographic.wetness) + s(ph) + s(total.n) + s(tree.density) + 
                s(log10.pesticide.risk) + s(log10.humans),  
                data = site.by.env.and.richness, method= "REML")

gam_poisson <- update(gam_gaussian, family = "poisson", link = "log")

gam_tweedie1 <- update(gam_poisson, family = Tweedie(p = 1.01))

gam_tweedie2 <- update(gam_poisson, family = Tweedie(p = 2))



```


# Gaussian
```{r}
par(mfrow = c(2, 2))
gam.check(gam_gaussian)
```

#### Poisson
```{r}
par(mfrow = c(2, 2))
gam.check(gam_poisson)
```

##### Tweedie = 1.01
```{r}
par(mfrow = c(2, 2))
gam.check(gam_tweedie1)
```

##### Tweedie = 2
```{r}
par(mfrow = c(2, 2))
gam.check(gam_tweedie2)
```



#### Get gam with best AIC. This is gam_tp for thin plate spline that is used with all family options
```{r}
gam_fam_list <-list (gam_gaussian, gam_poisson, gam_tweedie1, gam_tweedie2)

aic_table <- AIC(gam_gaussian, gam_poisson, gam_tweedie1, gam_tweedie2)

kable(aic_table, digits = 2, align = "l")

index_best <- which(aic_table$AIC == min(aic_table$AIC))

# Out of GAMS with different family arguments, the best is...
row.names(aic_table[index_best , ])
gam_tp <- gam_fam_list[[index_best]] 
```
```{r}
summary(gam_tp)
par(mfrow = c(2, 2))
gam.check(gam_tp)
my.plot.gam(gam_tp)
```


#### Check spline method
```{r}
# cubic regression spline
gam_cr <- update(gam_tp, formula = species.richness ~ s(mean.ann.temp, bs="cr") + 
            s(log10.mean.ann.rain, bs="cr") + s(topographic.wetness, bs="cr") + 
            s(ph, bs="cr") + s(total.n, bs="cr") + s(tree.density, bs="cr") + 
            s(log10.pesticide.risk, bs="cr") + s(log10.humans, bs="cr"))
```





#### Thin plate spline (one with the best family from previous round)
```{r}
summary(gam_tp)
par(mfrow = c(2, 2))
gam.check(gam_tp)
```

#### Cubic regression spline
```{r}
summary(gam_cr)
par(mfrow = c(2, 2))
gam.check(gam_cr)
```



#### Choose the best gam 
```{r}
gam_bs_list <-list (gam_tp,  gam_cr)
aic_table <- AIC(gam_tp,  gam_cr)

kable(aic_table, digits = 2, align = "l")
index_best <- which(aic_table$AIC == min(aic_table$AIC))

gam_best <- gam_bs_list[[index_best]] 
```





```{r}
summary(gam_best)
par(mfrow = c(2, 2))
gam.check(gam_best)
my.plot.gam(gam_best)
```



#### Residual plots 
```{r}
residuals <- resid(gam_best)
xy.res <- cbind(site.by.xy, residuals)

site.by.env.and.richness <- cbind(site.by.xy) %>%
  cbind(site.by.env, rowSums(site.by.species)) %>% 
  rename(species.richness = 'rowSums(site.by.species)')

env.and.res <- cbind(site.by.env.and.richness, residuals)
```

```{r}
pairs(env.and.res[,c(1, 2, 3, 12)])
pairs(env.and.res[, c(4, 5, 6, 12)])
pairs(env.and.res[, c(7, 8, 9, 12)])
pairs(env.and.res[, c(10, 11, 12)])
```

#### Look at geographic pattern in residuals
```{r}
coordinates(env.and.res) <- c("x","y")

crs.geo <- CRS("+init=epsg:27700")  # looks up BNG crs
proj4string(env.and.res) <- crs.geo  # define projection system of our data

bubble(env.and.res, "residuals", col = c("black","grey"),
       main = "Residuals", xlab = "X-coordinates", ylab = "Y-coordinates")

basemap <-tm_shape(gb) +
  tm_borders()

pointsmap <- basemap +
tm_shape(env.and.res) +
  tm_symbols(size = 0.25, col = "residuals", midpoint = NA)

print(pointsmap)
```


#### Concurvity tells us about relationships between smoothed terms

#full = TRUE gives overall estimates of relationship of each smoothed term with all others, 
#full = FALSE gives pairwise relationship according to three different methods.

```{r}
concurvity(gam_best, full = TRUE)
print("worst")
round(concurvity(gam_best, full = FALSE)$worst, 2)
print("observed")
round(concurvity(gam_best, full = FALSE)$observed, 2)
print("estimate")
round(concurvity(gam_best, full = FALSE)$estimate, 2)
```

# check p values that (APPROXIMATELY) test null hypothesis that smooth is actually zero
```{r}



check_tp <- check_smooths(gam_tp, "tp smooths")
check_tp

check_cr <- check_smooths(gam_cr, "cr smooths")
check_cr

```


#### if theses seem likely zero (large p), can try and additional penalty on smooths
```{r}


#Following gam.selection {mgcv}, we use automatic smoothness selection.

# The second approach leaves the original smoothing penalty unchanged, but constructs an additional penalty for each smooth, which penalizes only functions in the null space of the original penalty (the ‘completely smooth’ functions). Hence, if all the smoothing parameters for a term tend to infinity, the term will be selected out of the model. This latter approach is more expensive computationally, but has the advantage that it can be applied automatically to any smooth term. The select argument to gam turns on this method.

# thin plate spline with automatic smoothness selection
#gam_tp_select <- update(gam_tp, select = TRUE)

# cuic regression spline with automatic smoothness selection
#gam_cr_select <- update(gam_cr, select = TRUE)
```



#### Write to disc
```{r}
write_rds(gam_best, file = paste0(here(out_path), "/", params$dataset, "_best_gam.rds"))
```


#### Play with mgcVis
```{r}
# vis6 <- getViz(gam_best)
# 
# #adapted from https://cran.r-project.org/web/packages/mgcViz/vignettes/mgcviz.html
# #We added the fitted smooth effect, rugs on the x and y axes, confidence lines at 95%, partial residual points and we changed the plotting theme to ggplot2::theme_classic. Functions such as l_fitLine or l_rug are effect-specific layers. To see all the layers available for each effect plot we do:
# 
# #mul = 2 means interval +- 2 SE shown, narrower than 95% CI of course (default here)
# p1 <- plot(sm(vis6, 1))
# p1 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
#     l_ciLine(colour = "blue", linetype = 2) + 
#     l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()
# 
# p2 <- plot(sm(vis6, 2))
# p2 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
#     l_ciLine(colour = "blue", linetype = 2) + 
#     l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()
# 
# p3 <- plot(sm(vis6, 3))
# p3 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
#     l_ciLine(colour = "blue", linetype = 2) + 
#     l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()
# 
# p4 <- plot(sm(vis6, 4))
# p4 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
#     l_ciLine(colour = "blue", linetype = 2) + 
#     l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()
# 
# p5 <- plot(sm(vis6, 5))
# p5 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
#     l_ciLine(colour = "blue", linetype = 2) + 
#     l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()
# 
# p6 <- plot(sm(vis6, 6))
# p6 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
#     l_ciLine(colour = "blue", linetype = 2) + 
#     l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()
# 
# p7 <- plot(sm(vis6, 7))
# p7 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
#     l_ciLine(colour = "blue", linetype = 2) + 
#     l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()
# 
# p8 <- plot(sm(vis6, 8))
# p8 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
#     l_ciLine(colour = "blue", linetype = 2) + 
#     l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()

```

## Check Variogram
```{r}
v1 <-   variogram(residuals ~ 1, loc= ~ x+y, data = xy.res)
fit1 <- fit.variogram(v1, vgm(c("Sph", "Exp"))); 
plot(v1, fit1)
```



