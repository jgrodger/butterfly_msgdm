---
title: "R Notebook"
output: html_notebook
---

#### Setup and Packages
```{r}
#https://github.com/jennybc/here_here

here::i_am("Scripts/Rmd_Scripts/butterflies_combine_env_data.Rmd")

library(tidyverse)
library(gridExtra)
library(ggpubr)
library(conflicted)
library(terra)
library(sf)
library(tmap)
library(here)

conflicts_prefer(dplyr::filter)
```
To do: check we arereading correct processed input here
       get rid of northern Ireland and Ireland (mask)
       #mask isle of man and channell islands

#### Load data
```{r}
# load polygon to use to crop and mask as map extents a bit different

gb <- readRDS(here("./Data/Input_Environmental_Data/gb_multipolygon.rds"))

str(gb, max.level = 1)

crs(gb)

butterfly_data <- readRDS(here("./Data/Processed_Data/Spatial/spatial_ukbms_obs_sites_spp.rds"))

site.by.species <- butterfly_data$site.by.species

sites <- butterfly_data$sites

species <-  butterfly_data$species

site.by.humans <- readRDS(here("./Data/Masked_Cropped_Environmental_Data/site_by_humans.rds"))

site.by.ph <- readRDS(here("./Data/Masked_Cropped_Environmental_Data/site_by_ph.rds"))

site.by.trees <-  readRDS(here("./Data/Input_Environmental_Data/trees_1km_df.rds"))

site.by.nitrogen <- readRDS(here("./Data/Masked_Cropped_Environmental_Data/site_by_nitrogen.rds"))

site.by.pesticide.risk <- readRDS(here("./Data/Masked_Cropped_Environmental_Data/site_by_pesticide_risk.rds"))

site.by.wetness <- readRDS(here("./Data/Masked_Cropped_Environmental_Data/site_by_wetness.rds"))

site.by.temp <- readRDS(here("./Data/Masked_Cropped_Environmental_Data/site_by_temp.rds"))

site.by.prec <- readRDS(here("./Data/Masked_Cropped_Environmental_Data/site_by_prec.rds"))

surveys.site.year <- readRDS(here("./Data/Processed_Data/surveys_site_year.rds"))
```

#### Functions
```{r}
log10_plusone <- function(x)
{log10(x + 1)}

# A function to make raster and plot it
# Always does the first layer only if there are multiple layers

plot.df <- function(df, main.title){
rast1 <- rast(df, crs = "EPSG:27700") 
plot(rast1, xlab = "", ylab = "")
title(main = main.title)
}



# A function to filter the rest of the output dataset after the site by species data is filtered/subsetted

filter_dataset <- function(site.by.species, site.by.xy, site.by.env, species, sites){
  site.by.xy <- filter(site.by.xy, rownames(site.by.xy) %in% rownames(site.by.species))
  site.by.env <- filter(site.by.env, rownames(site.by.env) %in% rownames(site.by.species))
  species <- filter(species, species.no %in% names(site.by.species))
  sites <- filter(sites, rownames(sites)  %in% rownames(site.by.species))  
  
  dataset <- list(site.by.species, site.by.xy, site.by.env, species, sites)
  names(dataset) <- c("site.by.species", "site.by.xy", "site.by.env", "species", "sites")
  
  return(dataset)
}

```

## Process Data

#### Rename Environmental variables and log transform where necessary
```{r}
site.by.temp <- site.by.temp %>%
  rename(mean.ann.temp = mean)%>%
    filter(is.na(mean.ann.temp)==F)

site.by.prec <- site.by.prec %>%
  rename(mean.ann.rain = mean) %>%
    filter(is.na(mean.ann.rain)==F)

site.by.ph <- site.by.ph %>%
  rename(ph = ph_idw)%>%
    filter(is.na(ph)==F)

site.by.humans <- site.by.humans %>%
  rename(humans = gbr_pd_2017_1km)%>%
    filter(is.na(humans)==F)

site.by.trees <- site.by.trees %>%
  rename(tree.density = tree.cover.density)%>%
    filter(is.na(tree.density)==F)

site.by.nitrogen <-select(site.by.nitrogen, x, y, total.n, ngr.1km)%>%
    filter(is.na(total.n)==F)

site.by.pesticide.risk <- site.by.pesticide.risk %>%
  rename(pesticide.risk = pest)%>%
    filter(is.na(pesticide.risk)==F)

site.by.wetness <- site.by.wetness %>%
  rename(topographic.wetness = Band1) %>%
    filter(is.na(topographic.wetness)==F)

# log 10 transformations

site.by.log10.pesticide.risk <- site.by.pesticide.risk %>%
  mutate(log10.pesticide.risk = log10_plusone(pesticide.risk)) %>%
  select(x, y, log10.pesticide.risk, ngr.1km) #also gets it in correct order

site.by.log10.humans <- site.by.humans %>%
  mutate(log10.humans = log10_plusone(humans)) %>%
  select(x, y, log10.humans, ngr.1km) #also gets it in correct order

site.by.log10.mean.ann.rain <- site.by.prec %>%
  mutate(log10.mean.ann.rain = log10_plusone(mean.ann.rain)) %>%
  select(x, y, log10.mean.ann.rain, ngr.1km) #also gets it in correct order

```


#### Plot environmental variables
```{r eval = FALSE}
plot.df(df = site.by.temp, main.title ="Temperature")
plot.df(df = site.by.prec,  main.title = "Rainfall")
plot.df(site.by.log10.mean.ann.rain,  main.title = "Log Rainfall")
plot.df(df = site.by.wetness,  main.title = "Topographic Wetness")
plot.df(df = site.by.ph,  main.title = "Ph")
plot.df(df = site.by.trees,  main.title = "Tree Density")
plot.df(df = site.by.nitrogen,  main.title = "Total Nitrogen Deposition")
plot.df(site.by.pesticide.risk,  main.title = "Pesticide Risk")
plot.df(site.by.log10.pesticide.risk,  main.title = "Log Pesticide Risk")
plot.df(df = site.by.humans,  main.title = "Human Population Density")
plot.df(site.by.log10.humans,  main.title = "Log Human Population")
```

#### Save pdf
```{r eval = FALSE}
pdf(file= here("./Output/raw_maps.pdf"))
par(mfrow = c(2,4))
  plot.df(df = site.by.temp,  main.title ="Temperature")
  plot.df(df = site.by.prec,  main.title = "Rainfall")
  plot.df(df = site.by.wetness,  main.title = "Topographic Wetness")
  plot.df(df = site.by.ph,  main.title = "Ph")
  plot.df(df = site.by.trees,  main.title = "Tree Density")
  plot.df(df = site.by.nitrogen,  main.title = "Total Nitrogen Deposition")
  plot.df(site.by.pesticide.risk,  main.title = "Pesticide Risk")
dev.off() 


# raw and transformed data
pdf(file= here("./Output/transformed_maps.pdf"))
par(mfrow = c(3,2))
  plot.df(site.by.pesticide.risk,  main.title = "Pesticide Risk")
  plot.df(site.by.log10.pesticide.risk,  main.title = "log Pesticide Risk")  
  plot.df(df = site.by.humans,  main.title = "Human Population Density")  
  plot.df(site.by.log10.humans,  main.title = "Log Human Population")
  plot.df(df = site.by.prec,  main.title = "Rainfall")
  plot.df(site.by.log10.mean.ann.rain,  main.title = "Log Rainfall")
dev.off() 
```


#### Select the required rows for merging for environmental data dataframes

```{r}
#get site as a variable in the sites and site by species data frames

site.by.prec <- site.by.prec %>%
  select(-c(x,y))

site.by.ph <- site.by.ph %>%
  select(-c(x, y))

site.by.humans <- site.by.humans %>%
  select(-c(x, y))

site.by.log10.humans <- site.by.log10.humans %>%
  select(-c(x, y))

site.by.trees <- site.by.trees %>%
  select(-c(x, y))

site.by.nitrogen <- site.by.nitrogen %>%
  select(-c(x, y))

site.by.pesticide.risk <- site.by.pesticide.risk  %>%
  select(-c(x, y))

site.by.log10.pesticide.risk <- site.by.log10.pesticide.risk %>%
  select(-c(x, y)) 

site.by.log10.mean.ann.rain <- site.by.log10.mean.ann.rain %>%
  select(-c(x, y))

site.by.wetness <- site.by.wetness %>%
  select(-c(x,y))
```

#### Merge environmental data to obtain dataframe of sites with data for all environmental variables

```{r}
# Note, there is sometimes more than one site per gridref
# Merge is used to keep sites that have data for all variables
site.by.env <- sites %>%
  mutate(site.no = site,
         site = paste("site", site.no, sep = "_"))%>%
  select(site.no, site, ngr.1km)
print("Sites with species data")
nrow(sites)

site.by.temp <- site.by.temp %>% #rearrange columns
  select(c(ngr.1km, x, y, mean.ann.temp))

site.by.env <- site.by.env %>%
  merge(site.by.temp, by = "ngr.1km")
print("Sites also with temperature")
nrow(site.by.env)

site.by.env <- merge(site.by.env, site.by.prec, by = "ngr.1km")
site.by.env <- merge(site.by.env, site.by.log10.mean.ann.rain, by = "ngr.1km")
print("Sites also with rainfall")
nrow(site.by.env)

site.by.env <- merge(site.by.env, site.by.wetness, by = "ngr.1km")
print("Sites also with topographic wetness")
nrow(site.by.env)

site.by.env <- merge(site.by.env,site.by.ph,  by = "ngr.1km")
print("Sites also with pH")
nrow(site.by.env)

site.by.env <- merge(site.by.env, site.by.nitrogen, by = "ngr.1km")
print("Sites also with nitrogen")
nrow(site.by.env)

site.by.env <- merge(site.by.env, site.by.humans, by = "ngr.1km") 
print("Sites also with human population density")

site.by.env <- merge(site.by.env, site.by.log10.humans, by = "ngr.1km") 
nrow(site.by.env)

site.by.env <- merge(site.by.env, site.by.pesticide.risk, by = "ngr.1km")
site.by.env <- merge(site.by.env, site.by.log10.pesticide.risk, by = "ngr.1km")
print("Sites also with pesticide risk")
nrow(site.by.env)

site.by.env <- merge(site.by.env, site.by.trees, by = "ngr.1km")
print("Sites also with tree density")
nrow(site.by.env)


#order by site.number
site.by.env <- site.by.env[base::order(site.by.env$site.no), ]

#remove site.number
site.by.env <- select(site.by.env, -site.no)

```

#### Plot  Sites
```{r}
plot.points <- st_as_sf(site.by.env, coords=c("x","y"), remove = FALSE, crs = 27700) #I want to keep coords in the dataframe

#get a set of points for each unique grid cell

print("sites")
nrow(plot.points)

basemap <-tm_shape(gb) +
  tm_borders()
pointsmap <- basemap + 
tm_shape(plot.points) +
  tm_symbols(size = 0.05, col = "blue")

pointsmap2 <- basemap + 
tm_shape(plot.points) +
  tm_symbols(size = 0.5, col = "blue")

print(pointsmap)
print(pointsmap2)

```

#### Save as pdf
```{r}
pdf(file= here("./Output/1406_sites_maps.pdf"))
par(mfrow = c(1,2))
print(pointsmap)
print(pointsmap2)
#turn off PDF plotting
dev.off()
```

## Eyeball environmental data for sampling bias

#### Histograms for environmental data for all grid squares
```{r}

(p1<- ggplot(site.by.temp, aes(x=mean.ann.temp)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Temperature"))

(p2 <- ggplot(site.by.prec, aes(x=mean.ann.rain)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Rainfall"))

(p3 <- ggplot(site.by.log10.mean.ann.rain, aes(x=log10.mean.ann.rain)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Log Rainfall"))

(p4 <- ggplot(site.by.wetness, aes(x=topographic.wetness)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Topographic Wetness"))

(p5 <- ggplot(site.by.ph, aes(x=ph)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "pH"))


(p6 <- ggplot(site.by.trees, aes(x=tree.density)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Tree Density"))


(p7 <- ggplot(site.by.nitrogen, aes(x=total.n)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Total Nitrogen Deposition"))


(p8 <- ggplot(site.by.pesticide.risk, aes(x=pesticide.risk)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Pesticide Risk"))

(p9 <- ggplot(site.by.log10.pesticide.risk, aes(x=log10.pesticide.risk)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Log Pesticide Risk"))


(p10 <- ggplot(site.by.humans, aes(x=humans)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Human Population Density"))


(p11 <- ggplot(site.by.log10.humans, aes(x=log10.humans)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Log Human Population Density"))

```

#### Histograms for environmental data for sites in dataset
```{r}
(p12 <- ggplot(site.by.env, aes(x=mean.ann.temp)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Temperature"))

(p13 <- ggplot(site.by.env, aes(x=mean.ann.rain)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Rainfall"))

(p14 <- ggplot(site.by.env, aes(x=log10.mean.ann.rain)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Log Rainfall"))

(p15 <- ggplot(site.by.env, aes(x=topographic.wetness)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Topographic Wetness"))

(p16 <- ggplot(site.by.env, aes(x=ph)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "pH"))

(p17 <- ggplot(site.by.env, aes(x=tree.density)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Tree Density"))

(p18 <- ggplot(site.by.env, aes(x=total.n)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Total Nitrogen Deposition"))


(p19 <- ggplot(site.by.env, aes(x=pesticide.risk)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Pesticide Risk"))
 
(p20 <- ggplot(site.by.env, aes(x=log10.pesticide.risk)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Log Pesticide Risk"))

(p21 <-ggplot(site.by.env, aes(x=humans)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Human Population Density"))

(p22 <- ggplot(site.by.env, aes(x=log10.humans)) +
  geom_histogram(aes(y=..count../sum(..count..)), bins = 20)+
  labs(y = "Probability", title = "Log Human Population Density"))
```

#### Save pdfs of histograms
```{r}
pdf(file= here("./Output/env_var_histograms_1.pdf"))
figure <- grid.arrange(p1, p2, p3, p4, p12, p13, p14, p15 + rremove("x.text"), 
             ncol = 4, nrow = 2)
dev.off()

pdf(file= here("./Output/env_var_histograms_2.pdf"))
figure <- grid.arrange(p5, p6, p7, p16, p17, p18 + rremove("x.text"), 
             ncol = 3, nrow = 2)
dev.off()


pdf(file= here("./Output/env_var_histograms_3.pdf"))
figure <- grid.arrange(p8, p9, p10, p11, p19, p20, p21, p22 + rremove("x.text"), 
             ncol = 4, nrow = 2)
dev.off()

```

#### Remove untransformed versions of log-transformed variables from environmetal data
```{r}
site.by.env <- site.by.env %>%
  select(-c(mean.ann.rain, pesticide.risk, humans))
```

#### Check correlation between environmental variables

```{r}
cor(site.by.env[, 5:12], method = "pearson")
```


```{r}
cor(site.by.env[, 5:12], method = "spearman")
```
## Obtain versions of dataset for analysis (e.g. all species, 
## wider countryside species, habitat specialists)
```{r}

rownames(site.by.env) <- site.by.env$site

site.by.xy <- select(site.by.env, x, y)

site.by.env <- select(site.by.env, -c(ngr.1km, site, x, y))

rownames(site.by.species) <- paste("site", rownames(site.by.species), sep = "_")
site.by.species <- filter(site.by.species,
                          rownames(site.by.species) %in% rownames(site.by.env))

rownames(sites) <- paste("site", sites$site, sep = "_")

print("Number of sites matching butterfly sampling criteria")
nrow(sites)
sites <- sites %>%
  filter(rownames(sites) %in% rownames(site.by.env))
print("Number of sites also with all environmental variables")
nrow(sites)

head(site.by.species)

head(site.by.env)

head(site.by.xy)
```
#### Obtain datasets for wider countryside and habitat specialists
#### With and without rows that have no species
```{r}
species$species.no <- paste("species", species$species.no, sep = "_")

# Obtain vectors of species.no for habitat specialists and wider countryside species
habitat.specialists <- species[species$strategy == "Habitat specialist",]$species.no
wider.countryside.spp <- species[species$strategy == "Wider countryside sp",]$species.no

# Subset site by species by species for habitat specialists and wider countrysides
site.by.species.hs <- site.by.species %>%
  select(all_of(habitat.specialists))

site.by.species.wc <- site.by.species %>%
  select(all_of(wider.countryside.spp))

print("number of sites with no habitat specialists")
nrow(site.by.species.hs[rowSums(site.by.species.hs)==0, ])

print("number of sites with no wider countryside species")
nrow(site.by.species.wc[rowSums(site.by.species.wc)==0, ])

# filter site by species for wc and hs to remove rows with no species
site.by.species.hs.no.zeros <- site.by.species.hs[rowSums(site.by.species.hs) > 0, ]
print("number of sites with habitat specialists")
nrow(site.by.species.hs.no.zeros)

site.by.species.wc.no.zeros <- site.by.species.wc[rowSums(site.by.species.wc) > 0, ]
print("number of sites with  wider countryside species")
nrow(site.by.species.wc.no.zeros)

wc <- filter_dataset(site.by.species.wc, site.by.xy, site.by.env, species, sites)
hs <- filter_dataset(site.by.species.hs, site.by.xy, site.by.env, species, sites)

wc.no.zeros <- filter_dataset(site.by.species.wc.no.zeros, site.by.xy, site.by.env, species, sites)
hs.no.zeros <- filter_dataset(site.by.species.hs.no.zeros, site.by.xy, site.by.env, species, sites)
```

#### Save data
```{r}
all_species <- list(site.by.species, site.by.xy, site.by.env, species, sites)
names(all_species) <- c("site.by.species", "site.by.xy", "site.by.env", "species", "sites") 
write_rds(all_species, file = here("./Data/Processed_Data/Spatial/all_species.rds"))

write_rds(wc, file = here("./Data/Processed_Data/Spatial/wc.rds"))
write_rds(wc.no.zeros, file = here("./Data/Processed_Data/Spatial/wc_no_zeros.rds"))

write_rds(hs, file = here("./Data/Processed_Data/Spatial/hs.rds"))
write_rds(hs.no.zeros, file = here("./Data/Processed_Data/Spatial/hs_no_zeros.rds"))
```
