---
title: "R Notebook"
output: html_notebook
---

Previous version of code in filter_timeseries.Rmd

This is abbreviated 

so far I have only used this to choose three sites for Cang to play with

#### Load packages.
```{r}
here::i_am("Scripts//Rmd_Scripts//process_temporal_data.Rmd")

library(conflicted)

library(tidyverse)

library(here)

library(iNEXT)

library(tictoc)

conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::mutate)
conflicts_prefer(dplyr::select)
```


#### Functions
```{r}
source(here("Scripts/R_scripts/butterfly_richness_turnover_functions.R"))

```

#### File Paths
```{r}
# Path to data used for tje msgdm analysis (which is already done)
data_path <- paste0("./Data/Processed_Data/Temporal/for_temporal_ukbms.rds")


# Path to folder to save output of this script
out_path <- here(paste0("./Data/Processed_Data/Temporal/"))

#if(!dir.exists(out_path)) dir.create(out_path, recursive = TRUE)
```

#### Load Data
```{r}
my_data <- read_rds(here(data_path))

records <- my_data$records

species <- my_data$species

sites <- my_data$sites

records$site.year = paste0("site_", records$site.year)
```

#### Make a table to summarise remaining data and check data filtering at each step
```{r}
# Make a table
prisma <- tibble(
"Step" = "Loaded Data",
"Records" = nrow(records),
"Sites in records" = length(unique(records$site)),
"Species in records" = length(unique(records$species.no)),
"Sites in sites" = nrow(sites),
"Species in species" = nrow(species)
)

prisma
```
#### Combine records for small and essex skipper (species.nos 119 and 120), including those where observer recorded it as either of the two (species.no 200). These species cannot be reliably distinguished on the wing.
```{r}
# Make a new row in species dataset for the combined species
new.row <- c ("1000", "Combined Skippers", "Thymelicus lineola-sylvestris", "Wider countryside sp", "Grassland", 1)

species <- species  %>%
  rbind(new.row)    %>%
  filter(species.no!= 119,
         species.no!= 120, 
         species.no!= 200)# in the original dataset, when it was identified as one
# of the two species, it was coded as 200. These are no longer present 
# after filtering above, so this is redundant 

# Recode species.no in records for the two skipper species in the records dataframe 
# to 1000 to match species dataframe.
records <- records %>% 
 mutate(species.no = case_match(species.no, c("119", "120", "200") ~ "1000", .default = species.no))

prisma <- add_prisma(step_name = "Combined 2 skippers")
prisma
```




# filter by by time, exclude covid 
```{r}
records <- records %>%
  filter(year <= 2019 & year >= 1976)


filtered_data <- filter_ukbms("records")
# This updates the objects in the global environment with filtered versions
list2env(filtered_data, envir = .GlobalEnv)



prisma <- add_prisma(step_name = "Filtered to records before covid")
prisma
```



#### define sampling periods over year
```{r}


table(records$sampling.period)

```

#### Filter to site-year combinations sampled in all four sampling periods
```{r}
# Get a dataframe with the number of surveys per period in each site in each year
surveys.by.period <- records %>%
  distinct(survey.info, .keep_all = TRUE) %>%
  group_by(site, year, sampling.period) %>%
  summarise(surveys.per.period = n()) %>%
  pivot_wider(names_from = sampling.period,
    values_from = surveys.per.period,
    values_fill = 0) %>%
  mutate(site.year = paste("site", site, year, sep = "_"), 
         #criterion for inclusion, being sampled in all 4 periods
         all.4 = per1 > 0 & per2 > 0 & per3 > 0 & per4 > 0,
         total.surveys = sum(per1, per2, per3, per4)) %>% 
  ungroup()
```

```{r}
# Get number of years for each site that there were surveys in all four periods
sites.years.with.8plus.surveys  <- surveys.by.period %>% 
  filter(total.surveys >= 8) 

# this merge adds info on number of years with all four periods and filters
# to only include years with two or more sites
records <- records %>%
  filter(site.year %in% sites.years.with.8plus.surveys$site.year)

print("filter to site.years with at least 8 surveys")
filtered_data <- filter_ukbms("sites")
list2env(filtered_data, envir = .GlobalEnv)

prisma <- add_prisma(step_name = "Filtered to site.years with at least 8 surveys")
tail(prisma)
```


```{r}
# Get number of years for each site that there were surveys in all four periods
sites.years.with.all.four  <- surveys.by.period %>% 
  filter(all.4 == TRUE) 

# this merge adds info on number of years with all four periods and filters
# to only include years with two or more sites
records <- records %>%
  filter(site.year %in% sites.years.with.all.four$site.year)

print("filter to site.years sampled in all four periods")
filtered_data <- filter_ukbms("sites")
list2env(filtered_data, envir = .GlobalEnv)

prisma <- add_prisma(step_name = "Filtered all 4 periods")
tail(prisma)
```



#### get surveys for each site in each year in each of sampling periods that I define
```{r}
#surveys per site per year
surveys.site.year <-   records %>% 
  distinct(survey.info, .keep_all = TRUE) %>%
  group_by (site, year, sampling.period)  %>% 
  summarise(n = n())  %>% 
  ungroup() %>%
  mutate(site.year = paste(site, year, sep = "_")) %>%
  pivot_wider(
    names_from = sampling.period,
    values_from = n,
    values_fill = 0) %>%
  mutate(surveys.per.year = (per1 + per2 + per3 + per4))

#inspect frequency distribution of surveys per site per year
print("surveys per site per year")
summary(surveys.site.year$surveys.per.year)
hist(surveys.site.year$surveys.per.year, main = "Surveys per site per year")



```


#### Obtain dataframe with number of years per site, and minimum surveys for each site per year and  in each sampling period in each year
```{r}



#years per site summary and histogram
years.per.site <- surveys.site.year %>% 
  group_by(site)%>% 
summarise(years.surveyed = n(),
          first.year = min(year),
          last.year = max(year),
          minimum.surveys.per.per1 = min(per1),
          minimum.surveys.per.per2 = min(per2),
          minimum.surveys.per.per3 = min(per3),
          minimum.surveys.per.per4 = min(per4),
          minimum.surveys.per.year = min(surveys.per.year))


#inspect frequency distribution of years
print("years per site")
summary(years.per.site$years.surveyed)
hist(years.per.site$years.surveyed, main = "Years per site")
```




```{r}
aggregated.records <- records %>%
  group_by(site, year, species.no)%>%
    summarise(annual.records = sum(count))
```


#### Get site by species matrix
```{r}

  

#get a site.year by species dataframe with counts of observations
site.year.counts <- aggregated.records %>%
  pivot_wider(names_from = species.no,
              values_from = annual.records,
              values_fill = 0) %>% # for cases when there wasn't a zero count record for a species that wasn't recorded in a survey, should still be zero
  mutate (site.year = paste("site", site, year, sep = "_")) %>% 
    column_to_rownames(var = "site.year")%>%
      dplyr::select(-c(site, year))

names(site.year.counts) <- paste("species", names(site.year.counts), sep = "_")




```



#### Check all sites and species have occurrence data
```{r}
print("are there any species with no records")
any(colSums(site.year.counts) == 0)

print("are there any sites with no records")
any(rowSums(site.year.counts) == 0)
```



#### Inspect coverage
```{r}
coverage.multi <- DataInfo(t(site.year.counts),  datatype="abundance")
coverage.multi <- coverage.multi %>%
  mutate(site = str_split_i(Assemblage, "_", 2),
         site = paste0("site_", site),
         year = str_split_i(Assemblage, "_", -1),
         .before = Assemblage) %>% 
  rename(site.year = Assemblage)


hist(coverage.multi$SC)

hist(coverage.multi$SC, ylim = c(0, 800))


hist(coverage.multi$SC, xlim = c(0.98, 1), breaks = 200)

hist(coverage.multi$SC, xlim = c(0.88, 0.99), ylim = c(0, 1000), breaks = 150)

quantile(coverage.multi$SC, seq(from = 0, to = 1, by = 0.01), na.rm = TRUE)


summary(coverage.multi$SC)
```




```{r}
site.year.cov <- coverage.multi[, 1:6]

split_data <- site.year.cov

split_data <- split_data %>%
  mutate(year = as.integer(year), 
         site = as.factor(site)) %>%
  split(., split_data$site)

get_diff <- function(df){
  diff_vec <- diff(df$year)
  df$diff <- c(0, diff_vec)
  return(df)
}

split_data <- lapply(split_data, get_diff)

site.year.cov  <- bind_rows(split_data)

site.sum <- site.year.cov %>%
  group_by(site) %>% 
  summarise(
    total.years = n(),
    max.gap = max(diff) - 1,
    missing.years = sum(diff) - total.years +1
  )


site.year.cov.filtered <- site.year.cov %>%
  filter(SC >= 0.99)


```

# filter to site years with at least 0.99 coverage
```{r}

records <- filter(records, site.year %in% site.year.cov.filtered$site.year)

filtered_data <- filter_ukbms("records")
# This updates the objects in the global environment with filtered versions
list2env(filtered_data, envir = .GlobalEnv)

prisma <- add_prisma(step_name = "Filtered to site.years with at least 0.99 coverage")
prisma

head(records)
```


#Filter to sites with >= 20 years data to start with
```{r}
enough.years <- filter(years.per.site, years.surveyed >= 20)

records <- filter(records, site %in% enough.years$site)

filtered_data <- filter_ukbms("records")
# This updates the objects in the global environment with filtered versions
list2env(filtered_data, envir = .GlobalEnv)

prisma <- add_prisma(step_name = "Filtered to sites with >= 20 years")
prisma
```


#recalculated aggregated records and site by species matrix

```{r}
aggregated.records <- records %>%
  group_by(site, year, species.no)%>%
    summarise(annual.records = sum(count))
```

#### Get site by species matrix
```{r}
#get a site.year by species dataframe with counts of observations
site.year.counts <- aggregated.records %>%
  pivot_wider(names_from = species.no,
              values_from = annual.records,
              values_fill = 0) %>% # for cases when there wasn't a zero count record for a species that wasn't recorded in a survey, should still be zero
  mutate (site.year = paste("site", site, year, sep = "_")) %>% 
    column_to_rownames(var = "site.year")%>%
      dplyr::select(-c(site, year))

names(site.year.counts) <- paste("species", names(site.year.counts), sep = "_")

#make a presence absence site by species matrix
site.year.presabs <- site.year.counts
site.year.presabs[site.year.presabs[, ] > 0] <- 1

```

#### Check all sites and species have occurrence data
```{r}
print("are there any species with no records")
any(colSums(site.year.presabs) ==0)

print("are there any sites with no records")
any(rowSums(site.year.presabs) ==0)

print("sites and species in matrix")
dim(site.year.presabs)
```
# redo coverage matrix

```{r}
coverage.multi <- DataInfo(t(site.year.counts),  datatype="abundance")
coverage.multi <- coverage.multi %>%
  mutate(site = str_split_i(Assemblage, "_", 2),
         site = paste0("site_", site),
         year = str_split_i(Assemblage, "_", -1),
         .before = Assemblage) %>% 
  rename(site.year = Assemblage)

site.year.cov <- coverage.multi[, 1:6]

split_data <- site.year.cov

split_data <- split_data %>%
  mutate(year = as.integer(year), 
         site = as.factor(site)) %>%
  split(., split_data$site)

get_diff <- function(df){
  diff_vec <- diff(df$year)
  df$diff <- c(0, diff_vec)
  return(df)
}

split_data <- lapply(split_data, get_diff)

site.year.cov  <- bind_rows(split_data)

site.sum <- site.year.cov %>%
  group_by(site) %>% 
  summarise(
    total.years = n(),
    max.gap = max(diff) - 1,
    missing.years = sum(diff) - total.years +1
  )

cov_mat <- site.year.cov %>%
  select(site, year, SC) %>%
  pivot_wider(values_from = SC, names_from = site) %>%
  column_to_rownames(var = "year")


dt2 <- cov_mat[, 1:50]
dt2 <- as.matrix  (dt2)


heatmap(dt2, Rowv= NA, Colv = NA)


```


```{r}
write_csv(site.year.presabs,
          col_names = TRUE,
          file = paste0(out_path, "/", "presabs.csv"))
```




<!-- #### Filter to include three sites as requested by Cang -->
<!-- ```{r} -->
<!-- records <- records %>% -->
<!--   filter(site %in% c(1, 4, 86)) -->

<!-- three_series <- filter_ukbms("records") -->

<!-- ``` -->


<!-- #### Check all sites and species have occurrence data -->
<!-- ```{r} -->
<!-- print("are there any species with no records") -->
<!-- any(colSums(site.year.counts)==0) -->

<!-- print("are there any sites with no records") -->
<!-- any(rowSums(site.year.counts)==0) -->

<!-- print("sites and species in matrix") -->
<!-- dim(site.year.counts) -->
<!-- ``` -->
<!-- #### move info out of column and row names into the dataframe to save as csv -->

<!-- ```{r} -->
<!-- site.year.counts <- site.year.counts %>% -->
<!--   rownames_to_column(var = "site_year") %>% -->
<!--   mutate(site = str_sub(site_year, end = -6), -->
<!--          year = str_sub(site_year, -4)) %>% -->
<!--   relocate(site, year, .after = site_year) -->
<!-- ``` -->



<!-- #### write csv to processed data file -->

<!-- ```{r} -->
<!-- write_csv(site.year.counts, -->
<!--           col_names = TRUE, -->
<!--           file = paste0(out_path, "/", "three_sites_site_year_counts.csv")) -->
<!-- ``` -->











