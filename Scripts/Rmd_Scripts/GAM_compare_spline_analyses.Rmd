---
title: "Gam compare splines"
output: html_document
date: "2024-05-13"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


#### Get gam with best AIC. This is gam_tp for thin plate spline that is used with all family options
```{r}
gam_fam_list <-list (gam_gaussian, gam_poisson, gam_tweedie1, gam_tweedie2)

aic_table <- AIC(gam_gaussian, gam_poisson, gam_tweedie1, gam_tweedie2)

kable(aic_table, digits = 2, align = "l")

index_best <- which(aic_table$AIC == min(aic_table$AIC))

# Out of GAMS with different family arguments, the best is...
row.names(aic_table[index_best , ])
gam_tp <- gam_fam_list[[index_best]] 
```
```{r}
summary(gam_tp)
par(mfrow = c(2, 2))
gam.check(gam_tp)
my.plot.gam(gam_tp)
```


#### Check spline method
```{r}
# cubic regression spline
gam_cr <- update(gam_tp, formula = species.richness ~ s(mean.ann.temp, bs="cr") + 
            s(log10.mean.ann.rain, bs="cr") + s(topographic.wetness, bs="cr") + 
            s(ph, bs="cr") + s(total.n, bs="cr") + s(tree.density, bs="cr") + 
            s(log10.pesticide.risk, bs="cr") + s(log10.humans, bs="cr"))
```





#### Thin plate spline (one with the best family from previous round)
```{r}
summary(gam_tp)
par(mfrow = c(2, 2))
gam.check(gam_tp)
```

#### Cubic regression spline
```{r}
summary(gam_cr)
par(mfrow = c(2, 2))
gam.check(gam_cr)
```



#### Choose the best gam 
```{r}
gam_bs_list <-list (gam_tp,  gam_cr)
aic_table <- AIC(gam_tp,  gam_cr)

kable(aic_table, digits = 2, align = "l")
index_best <- which(aic_table$AIC == min(aic_table$AIC))

gam_best <- gam_bs_list[[index_best]] 
```





```{r}
summary(gam_best)
par(mfrow = c(2, 2))
gam.check(gam_best)
my.plot.gam(gam_best)
```



#### Residual plots 
```{r}
residuals <- resid(gam_best)
xy.res <- cbind(site.by.xy, residuals)

site.by.env.and.richness <- cbind(site.by.xy) %>%
  cbind(site.by.env, rowSums(site.by.species)) %>% 
  rename(species.richness = 'rowSums(site.by.species)')

env.and.res <- cbind(site.by.env.and.richness, residuals)
```

```{r}
pairs(env.and.res[,c(1, 2, 3, 12)])
pairs(env.and.res[, c(4, 5, 6, 12)])
pairs(env.and.res[, c(7, 8, 9, 12)])
pairs(env.and.res[, c(10, 11, 12)])
```

#### Look at geographic pattern in residuals
```{r}
coordinates(env.and.res) <- c("x","y")

crs.geo <- CRS("+init=epsg:27700")  # looks up BNG crs
proj4string(env.and.res) <- crs.geo  # define projection system of our data

bubble(env.and.res, "residuals", col = c("black","grey"),
       main = "Residuals", xlab = "X-coordinates", ylab = "Y-coordinates")

basemap <-tm_shape(gb) +
  tm_borders()

pointsmap <- basemap +
tm_shape(env.and.res) +
  tm_symbols(size = 0.25, col = "residuals", midpoint = NA)

print(pointsmap)
```


#### Concurvity tells us about relationships between smoothed terms

#full = TRUE gives overall estimates of relationship of each smoothed term with all others, 
#full = FALSE gives pairwise relationship according to three different methods.

```{r}
concurvity(gam_best, full = TRUE)
print("worst")
round(concurvity(gam_best, full = FALSE)$worst, 2)
print("observed")
round(concurvity(gam_best, full = FALSE)$observed, 2)
print("estimate")
round(concurvity(gam_best, full = FALSE)$estimate, 2)
```

# check p values that (APPROXIMATELY) test null hypothesis that smooth is actually zero
```{r}



check_tp <- check_smooths(gam_tp, "tp smooths")
check_tp

check_cr <- check_smooths(gam_cr, "cr smooths")
check_cr

```


#### if theses seem likely zero (large p), can try and additional penalty on smooths
```{r}


#Following gam.selection {mgcv}, we use automatic smoothness selection.

# The second approach leaves the original smoothing penalty unchanged, but constructs an additional penalty for each smooth, which penalizes only functions in the null space of the original penalty (the ‘completely smooth’ functions). Hence, if all the smoothing parameters for a term tend to infinity, the term will be selected out of the model. This latter approach is more expensive computationally, but has the advantage that it can be applied automatically to any smooth term. The select argument to gam turns on this method.

# thin plate spline with automatic smoothness selection
#gam_tp_select <- update(gam_tp, select = TRUE)

# cuic regression spline with automatic smoothness selection
#gam_cr_select <- update(gam_cr, select = TRUE)
```



#### Write to disc
```{r}
write_rds(gam_best, file = paste0(here(out_path), "/", params$dataset, "_best_gam.rds"))
```


#### Play with mgcVis
```{r}
# vis6 <- getViz(gam_best)
# 
# #adapted from https://cran.r-project.org/web/packages/mgcViz/vignettes/mgcviz.html
# #We added the fitted smooth effect, rugs on the x and y axes, confidence lines at 95%, partial residual points and we changed the plotting theme to ggplot2::theme_classic. Functions such as l_fitLine or l_rug are effect-specific layers. To see all the layers available for each effect plot we do:
# 
# #mul = 2 means interval +- 2 SE shown, narrower than 95% CI of course (default here)
# p1 <- plot(sm(vis6, 1))
# p1 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
#     l_ciLine(colour = "blue", linetype = 2) + 
#     l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()
# 
# p2 <- plot(sm(vis6, 2))
# p2 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
#     l_ciLine(colour = "blue", linetype = 2) + 
#     l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()
# 
# p3 <- plot(sm(vis6, 3))
# p3 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
#     l_ciLine(colour = "blue", linetype = 2) + 
#     l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()
# 
# p4 <- plot(sm(vis6, 4))
# p4 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
#     l_ciLine(colour = "blue", linetype = 2) + 
#     l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()
# 
# p5 <- plot(sm(vis6, 5))
# p5 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
#     l_ciLine(colour = "blue", linetype = 2) + 
#     l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()
# 
# p6 <- plot(sm(vis6, 6))
# p6 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
#     l_ciLine(colour = "blue", linetype = 2) + 
#     l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()
# 
# p7 <- plot(sm(vis6, 7))
# p7 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
#     l_ciLine(colour = "blue", linetype = 2) + 
#     l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()
# 
# p8 <- plot(sm(vis6, 8))
# p8 + l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
#     l_ciLine(colour = "blue", linetype = 2) + 
#     l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic()

```

## Check Variogram
```{r}
v1 <-   variogram(residuals ~ 1, loc= ~ x+y, data = xy.res)
fit1 <- fit.variogram(v1, vgm(c("Sph", "Exp"))); 
plot(v1, fit1)
```



