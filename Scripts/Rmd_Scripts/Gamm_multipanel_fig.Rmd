---
title: "R Notebook"
output: html_notebook
---
`
# This makes figure 3

#geom_rug not working so well, can check the other functions and see how the handle overplotting

```{r}
here::i_am("Scripts/Rmd_Scripts/Gamm_multipanel_fig.Rmd")
library(tidyverse)
library(ggpubr)
library(mgcv)
library(mgcViz)
library(here)
library(conflicted)

conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::select)
```

# load gamm objects
```{r}
# they are in this order: ("gamm_corGaus", "gamm_corExp", "gamm_corLin",
#"gamm_corRatio", "gamm_corSpher")

as_mods <- readRDS(here("./Output/Spatial/GAM/GAMM_all_species/gamm_model_select_as.rds/"))
as_gamm <- as_mods[[3]]

wc_mods <- readRDS(here("./Output/Spatial/GAM/GAMM_wc/gamm_model_select_wc.rds/"))
wc_gamm <- wc_mods[[3]]

hs_mods <- readRDS(here("./Output/Spatial/GAM/GAMM_hs/gamm_model_select_hs.rds/"))
hs_gamm <- hs_mods[[3]]
```


```{r}

# a function to prepare data from plot.gam() and prepare for further plotting
# the plot_data is a list with length being the number of predictors in the GAM

prepare.clfit <- function(shift, plot_data){

  outlist <- list()
 
for (i in 1:length(plot_data)){
  input <- plot_data[[i]]
  output <-  data.frame(cbind(
  input$x, 
  input$fit + shift, 
  input$se)) #note, se already multiplied by 1.96
  names(output) <- c("x", "fit", "se.fit")
  output <- output %>%
  mutate(hi.cl = fit + se.fit, lo.cl = fit - se.fit)
  outlist[[i]] <- output
  } 
return(outlist)  
}

# a function to plot fit and ci from plot.gam
plot.clfit <- function(df){
df %>%
ggplot(aes(x)) +
geom_line(aes(y = fit), colour = "red", linetype = 1) +
geom_line(aes(y = hi.cl), colour = "blue", linetype = 2) +
geom_line(aes(y = lo.cl), colour = "blue", linetype = 2)  + 
geom_rug(sides="b")  + 
  theme_classic()  
}

```


```{r}
out_path <-  here("Output/Spatial/GAM/GAMM_fig//")
if(!dir.exists(out_path)) dir.create(out_path)
```

# get predicted values and sE for smooths from gam.plot
```{r}

as_plot_data <- plot(as_gamm$gam, shift = coef(as_gamm$gam)[1], pages = 1, seWithMean = FALSE, se = 1.96) # in the output se is already multiplied by 1.96

wc_plot_data <- plot(wc_gamm$gam, shift = coef(wc_gamm$gam)[1], pages = 1, seWithMean = FALSE, se = 1.96) # in the output se is already multiplied by 1.96

hs_plot_data <- plot(hs_gamm$gam, shift = coef(hs_gamm$gam)[1], pages = 1, seWithMean = FALSE, se = 1.96) # in the output se is already multiplied by 1.96

```

# prepare data from gam.plot to make a custom plot with geom_line()
```{r}
as_plot_data2 <- prepare.clfit(coef(as_gamm$gam)[1], as_plot_data)
wc_plot_data2 <- prepare.clfit(coef(wc_gamm$gam)[1], wc_plot_data)
hs_plot_data2 <- prepare.clfit(coef(hs_gamm$gam)[1], hs_plot_data)
```

#make custom plots of predicted values and CI from gam.plot
```{r}
# create 
p1a <- plot.clfit(as_plot_data2[[1]])
p4a <- plot.clfit(as_plot_data2[[2]])
p7a <- plot.clfit(as_plot_data2[[3]])
p10a <- plot.clfit(as_plot_data2[[4]])
p13a <- plot.clfit(as_plot_data2[[5]])
p16a <- plot.clfit(as_plot_data2[[6]])

p2a <- plot.clfit(wc_plot_data2[[1]])
p5a <- plot.clfit(wc_plot_data2[[2]])
p8a <- plot.clfit(wc_plot_data2[[3]])
p11a <- plot.clfit(wc_plot_data2[[4]])
p14a <- plot.clfit(wc_plot_data2[[5]])
p17a <- plot.clfit(wc_plot_data2[[6]])

p3a <- plot.clfit(hs_plot_data2[[1]])
p6a <- plot.clfit(hs_plot_data2[[2]])
p9a <- plot.clfit(hs_plot_data2[[3]])
p12a <- plot.clfit(hs_plot_data2[[4]])
p15a <- plot.clfit(hs_plot_data2[[5]])
p18a <- plot.clfit(hs_plot_data2[[6]])

#inspect
 gridPrint(p1a, p2a, p3a, 
          p4a, p5a, p6a,
          p7a, p8a, p9a,
          p10a, p11a, p12a,
          p13a, p14a, p15a,
          p16a, p17a, p18a,
          respect=TRUE,
          ncol = 3)

```

# add annotation and set y axis limits as well as text size
```{r}
# Could use labs(tag = "A"), etc and include "All Species" etc below as separate elements

p1 <- p1a +
  ylab("") +
  xlab("") +
  labs(title = "All Species") +
  theme(axis.title = element_text(size = 5),
        axis.text = element_text(size = 4)) +
  annotation_custom(grid::textGrob("A", 0.2, 0.95, gp = grid::gpar(fontsize = 6))) +
  coord_cartesian(ylim = c(14, 23)) +
  theme(plot.title = element_text(size = 5.5))

p2 <- p2a +
  ylab("") +
  xlab("Mean Annual Temperature") +
  labs(title = "Habitat Generalists") +
  theme(axis.title = element_text(size = 5),
        axis.text = element_text(size = 4)) +
  annotation_custom(grid::textGrob("B", 0.2, 0.95, gp = grid::gpar(fontsize = 6))) +
  coord_cartesian(ylim = c(10, 18)) +
  theme(plot.title = element_text(size = 5.5))

p3 <- p3a +
  ylab("") +
  xlab("") +
  labs(title = "Habitat Specialists") +
 theme(axis.title = element_text(size = 5),
        axis.text = element_text(size = 4)) +
  annotation_custom(grid::textGrob("C", 0.2, 0.95, gp = grid::gpar(fontsize = 6))) +
  coord_cartesian(ylim = c(-0.55, 1.75)) +
  theme(plot.title = element_text(size = 5.5))


p4 <- p4a +
  ylab("") +
  xlab("") +
  theme(axis.title = element_text(size = 5),
        axis.text = element_text(size = 4)) +
  annotation_custom(grid::textGrob("D", 0.2, 0.95, gp = grid::gpar(fontsize = 6))) +
  coord_cartesian(ylim = c(14, 23))

p5 <- p5a +
  ylab("") +
  xlab("Mean Annual Precipitation") +
 theme(axis.title = element_text(size = 5),
        axis.text = element_text(size = 4)) +
  annotation_custom(grid::textGrob("E", 0.2, 0.95, gp = grid::gpar(fontsize = 6))) +
  coord_cartesian(ylim = c(10, 18))

p6 <- p6a +
  ylab("") +
  xlab("") +
  theme(axis.title = element_text(size = 5),
        axis.text = element_text(size = 4)) +
  annotation_custom(grid::textGrob("F", 0.2, 0.95, gp = grid::gpar(fontsize = 6))) +
  coord_cartesian(ylim = c(-0.55, 1.75))


p7 <- p7a +
  ylab("Species Richness") +
  xlab("") +
  theme(axis.title = element_text(size = 5),
        axis.text = element_text(size = 4)) +
  annotation_custom(grid::textGrob("G", 0.2, 0.95, gp = grid::gpar(fontsize = 6))) +
  coord_cartesian(ylim = c(14, 23))

p8 <- p8a +
  ylab("") +
  xlab("Topographical Wetness") +
  theme(axis.title = element_text(size = 5),
        axis.text = element_text(size = 4)) +
  annotation_custom(grid::textGrob("H", 0.2, 0.95, gp = grid::gpar(fontsize = 6))) +
  coord_cartesian(ylim = c(10, 18))

p9 <- p9a +
  ylab("") +
  xlab("") +
  theme(axis.title = element_text(size = 5),
        axis.text = element_text(size = 4)) +
  annotation_custom(grid::textGrob("I", 0.2, 0.95, gp = grid::gpar(fontsize = 6))) +
  coord_cartesian(ylim = c(-0.55, 1.75))


p10 <- p10a +
  ylab("") +
  xlab("") +
  theme(axis.title = element_text(size = 5),
        axis.text = element_text(size = 4)) +
  annotation_custom(grid::textGrob("J", 0.2, 0.95, gp = grid::gpar(fontsize = 6))) +
  coord_cartesian(ylim = c(14, 23))

p11 <- p11a +
  ylab("") +
  xlab("pH") +
  theme(axis.title = element_text(size = 5),
        axis.text = element_text(size = 4)) +
  annotation_custom(grid::textGrob("K", 0.2, 0.95, gp = grid::gpar(fontsize = 6))) +
  coord_cartesian(ylim = c(10, 18))

p12 <- p12a +
  ylab("") +
  xlab("") +
 theme(axis.title = element_text(size = 5),
        axis.text = element_text(size = 4)) +
  annotation_custom(grid::textGrob("L", 0.2, 0.95, gp = grid::gpar(fontsize = 6))) +
  coord_cartesian(ylim = c(-0.55, 1.75))


p13 <- p13a +
  ylab("") +
  xlab("") +
  theme(axis.title = element_text(size = 5),
        axis.text = element_text(size = 4)) +
  annotation_custom(grid::textGrob("M", 0.2, 0.95, gp = grid::gpar(fontsize = 6))) +
  coord_cartesian(ylim = c(14, 23))

p14 <- p14a +
  ylab("") +
  xlab("Total Nitrogen Deposition") +
 theme(axis.title = element_text(size = 5),
        axis.text = element_text(size = 4)) +
  annotation_custom(grid::textGrob("N", 0.2, 0.95, gp = grid::gpar(fontsize = 6))) +
  coord_cartesian(ylim = c(10, 18))

p15 <- p15a +
  ylab("") +
  xlab("") +
  theme(axis.title = element_text(size = 5),
        axis.text = element_text(size = 4)) +
  annotation_custom(grid::textGrob("O", 0.2, 0.95, gp = grid::gpar(fontsize = 6))) +
  coord_cartesian(ylim = c(-0.55, 1.75))


p16 <- p16a +
  ylab("") +
  xlab("") +
  theme(axis.title = element_text(size = 5),
        axis.text = element_text(size = 4)) +
  annotation_custom(grid::textGrob("P", 0.2, 0.95, gp = grid::gpar(fontsize = 6))) +
  coord_cartesian(ylim = c(14, 23))

p17 <- p17a +
  ylab("") +
  xlab("Log Human Density") +
 theme(axis.title = element_text(size = 5),
        axis.text = element_text(size = 4)) +
  annotation_custom(grid::textGrob("Q", 0.2, 0.95, gp = grid::gpar(fontsize = 6))) +
  coord_cartesian(ylim = c(10, 18))

p18 <- p18a +
  ylab("") +
  xlab("") +
  theme(axis.title = element_text(size = 5),
        axis.text = element_text(size = 4)) +
  annotation_custom(grid::textGrob("R", 0.2, 0.95, gp = grid::gpar(fontsize = 6))) +
  coord_cartesian(ylim = c(-0.55, 1.75))



```

# print the multipanel plot

```{r}
# this is a function from mgcViz
gridPrint(p1, p2, p3, 
          p4, p5, p6,
          p7, p8, p9,
          p10, p11, p12,
          p13, p14, p15,
          p16, p17, p18,
          respect=TRUE,
          ncol = 3)

png(file = paste0(out_path, "gam_multiplot.png"), pointsize=10, width=960, height=1400, res=300)
 
gridPrint(p1, p2, p3, 
          p4, p5, p6,
          p7, p8, p9,
          p10, p11, p12,
          p13, p14, p15,
          p16, p17, p18,
          respect=TRUE,
          ncol = 3)

 dev.off() 
```






