---
title: "GAM species richness"
output: html_document

params:
  dataset: "all_species"
---

## Here we run GAMs for different distributions of response variable (family argument)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Parameters for this report
```{r}
print(params)
```

#### Packages
```{r}
here::i_am("Scripts/Rmd_Scripts/GAM_compare_family_analyses.Rmd")

library(tidyverse)
library(mgcv)
library(moranfast)
library(knitr)
library(knitrProgressBar)
library(here)
library(conflicted)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::select)
conflicts_prefer(knitrProgressBar::progress_estimated)

# there is a same-named function in dplyr, check it out
```

#### Functions
```{r}
# A function for plotting gam relationships with my preferences
# IE shading for CI;partial residuals included; results on original scale

my.plot.gam <- function(gam_object){
plot(gam_object, residuals = TRUE, seWithMean = FALSE, shade = TRUE, 
     shift = coef(gam_object)[1], pages = 2) 
}

# a function to make a table for checking if smooths might be zero
check_smooths <- function(gam_obj, capt){
vars <- c("mean.ann.temp", "log10.mean.ann.rain", "topographic.wetness", "ph", 
          "total.n",  "tree.density", "log10.pesticide.risk",  "log10.humans") 
  
gam_obj <- data.frame(cbind(vars, summary(gam_tp)$s.pv))
names(gam_obj) <- c("Var", "p")
gam_obj$p <- as.numeric(gam_obj$p)
gam_obj<- kable(gam_obj, digits = 3, align = "l", caption = capt)
}

# From https://stackoverflow.com/questions/71252509/is-there-a-way-to-get-progress-information-whan-a-chunk-is-running-in-rmarkdown

slow_function <- function(i, .pb=NULL) {  
  update_progress(.pb)  
  Sys.sleep(0.5)  
  i  
}

# create an R6 progress object for
# the number of loops/iterations in the target chunk
```

#### File Paths
```{r}
data_path <- paste0("./Data/Processed_Data/Spatial/", params$dataset, ".rds")

out_path <-  paste0(here("Output/Spatial/GAM"), "/","GAM", "_" , 
                    params$dataset,  "/")

if(!dir.exists(out_path)) dir.create(out_path)
```

#### Data
```{r}
data <- readRDS(here(data_path))

site.by.species <- data$site.by.species
  
site.by.env <- data$site.by.env

site.by.xy <- data$site.by.xy
```

## GAMS

### Run GAMs with different distributions for the response variable
```{r}
# Gaussian
gam_gaussian <- gam(species.richness ~ s(mean.ann.temp) + s(log10.mean.ann.rain) + 
                s(topographic.wetness) + s(ph) + s(total.n) + s(tree.density) + 
                s(log10.pesticide.risk) + s(log10.humans),  
                data = site.by.env.and.richness, method= "ML")

gam_poisson <- update(gam_gaussian, family = "poisson", link = "log")

gam_nb <- update(gam_gaussian, family = nb(link = "log"))

#"When = = 0, the Tweedie distribution degenerates to the normal distribution; when p = 1, it becomes a Poisson distribution; when p = 2, it becomes a gamma distribution; when p = 3, it is an inverse Gaussian distribution. "
#https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.4/statug/statug_genmod_details28.htm

gam_tweedie <- update(gam_poisson, family = tw())# tweedie distribution with p parameter estimated

gam_ziP <- update(gam_poisson, family = ziP, link = "log") #ziP for zero inflated Poisson data, when the zero inflation rate depends simply on the Poisson mean.

gam_list <- list(gam_gaussian, gam_poisson, gam_nb, gam_tweedie, gam_ziP)
names(gam_list) <- c("gam_gaussian", "gam_poisson", "gam_nb", "gam_tweedie", "gam_ziP")

```

### Compare residual plots and perform basis dimension checking
```{r}
for (i in 1:length(gam_list)){
  print(names(gam_list[i]))  
  gam_i <- gam_list[[i]]
  par(mfrow = c(2, 2))
  gam.check(gam_gaussian)
}
```
### Compare GAM summaries
```{r}
for (i in 1:length(gam_list)){
  print(names(gam_list[i]))  
  gam_i <- gam_list[[i]]
  summary(gam_i)
}
```

### Compare GAM smooth plots
```{r}
for (i in 1:length(gam_list)){
  print(names(gam_list[i]))  
  gam_i <- gam_list[[i]]
  par(mfrow = c(2, 2))
  my.plot.gam(gam_i)
}
```

### Compare Moran's tests
```{r}
for (i in 1:length(gam_list)){
  print(names(gam_list[i]))  
  gam_i <- gam_list[[i]]
  print("Moran's test  with I value")
  print(moranfast(residuals(gam_i, type = "deviance"), 
          site.by.env.and.richness$x, site.by.env.and.richness$y))
}
```

### Compare GAMs in terms of AIC
```{r}
aic_table <- AIC(gam_gaussian, gam_poisson, gam_nb, gam_tweedie, gam_ziP) %>%
  arrange(AIC) %>% #order rows by AIC
  mutate(delta_AIC = AIC - min(AIC)) %>%
  rownames_to_column(var = "Family")

write_csv(aic_table, file = paste0(out_path, "/", "family_aic_table.csv"))

kable(aic_table, digits = 2, align = "l")
```
