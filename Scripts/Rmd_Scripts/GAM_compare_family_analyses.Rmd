---
title: "GAM species richness"
output: html_document

params:
  dataset: "all_species"
---

## In this code, we explore relationships between environmental variables and richness, and compare GAMS for different distributions (family argument) 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Packages
```{r}
here::i_am("Scripts/Rmd_Scripts/GAM_compare_family_analyses.Rmd")

library(tidyverse)
library(sf)
library(sp)
library(terra)
library(mgcv)
library(knitr)
library(knitrProgressBar)
library(tmap)
library(mgcViz)
library(gstat)
library(here)
library(conflicted)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::select)
conflicts_prefer(knitrProgressBar::progress_estimated)

# there is a same-named function in dplyr, check it out
```

#### Functions
```{r}
# A function for plotting gam relationships with my preferences


my.plot.gam <- function(gam_object){
plot(gam_object, residuals = TRUE, seWithMean = TRUE, shade = TRUE, shift = coef(gam_object)[1], pages = 2) 
}


# a function to make a table for checking if smooths might be zero
check_smooths <- function(gam_obj, capt){
vars <- c("mean.ann.temp", "log10.mean.ann.rain", "topographic.wetness", "ph", 
          "total.n",  "tree.density", "log10.pesticide.risk",  "log10.humans") 
  
gam_obj <- data.frame(cbind(vars, summary(gam_tp)$s.pv))
names(gam_obj) <- c("Var", "p")
gam_obj$p <- as.numeric(gam_obj$p)
gam_obj<- kable(gam_obj, digits = 3, align = "l", caption = capt)
}

# From https://stackoverflow.com/questions/71252509/is-there-a-way-to-get-progress-information-whan-a-chunk-is-running-in-rmarkdown

slow_function <- function(i, .pb=NULL) {  
  update_progress(.pb)  
  Sys.sleep(0.5)  
  i  
}

# create an R6 progress object for
# the number of loops/iterations in the target chunk
```

#### File Paths
```{r}
data_path <- paste0("./Data/Processed_Data/Spatial/", params$dataset, ".rds")

out_path <-  paste0(here("Output/Spatial/GAM"), "/","GAM", "_" , 
                    params$dataset,  "/")

if(!dir.exists(out_path)) dir.create(out_path)
```

#### Data
```{r}
data <- readRDS(here(data_path))

site.by.species <- data$site.by.species
  
site.by.env <- data$site.by.env

site.by.xy <- data$site.by.xy

# gb polygon

gb <- readRDS(here("./Data/Maps/gb_multipolygon_simplified.rds"))

str(gb, max.level = 1)

crs(gb)
```

#### Parameters for this report
```{r}
print(params)
```

#### Environmental variable, easting, northing and richness Pearson and Spearman correlations
```{r}
site.by.env.and.richness <- cbind(site.by.xy) %>%
  cbind(site.by.env, rowSums(site.by.species)) %>% 
  rename(species.richness = 'rowSums(site.by.species)')
  

t1 <- cor(site.by.env.and.richness)
t2 <- cor(site.by.env.and.richness, method = "spearman")

print("Pearson correlation")
t1
print("Spearman correlation")
t2
```

#### Visualise relationships with eachother and richness
```{r}
pairs(site.by.env.and.richness[,3:11])

pairs(site.by.env.and.richness[,c(1, 2, 11)])
pairs(site.by.env.and.richness[, c(3, 4, 5, 11)])
pairs(site.by.env.and.richness[,c(6, 7, 8, 11)])
pairs(site.by.env.and.richness[c(9, 10, 11)])
```

#### Check species richness distribution
```{r}
hist(site.by.env.and.richness$species.richness)
```
#GAMS

#### Compare GAMs with different families
```{r}
# Gaussian
gam_gaussian <- gam(species.richness ~ s(mean.ann.temp) + s(log10.mean.ann.rain) + 
                s(topographic.wetness) + s(ph) + s(total.n) + s(tree.density) + 
                s(log10.pesticide.risk) + s(log10.humans),  
                data = site.by.env.and.richness, method= "ML")

gam_poisson <- update(gam_gaussian, family = "poisson", link = "log")

gam_nb <- update(gam_gaussian, family = nb(), link = "log")

#"When = = 0, the Tweedie distribution degenerates to the normal distribution; when p = 1, it becomes a Poisson distribution; when p = 2, it becomes a gamma distribution; when p = 3, it is an inverse Gaussian distribution. "
#https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.4/statug/statug_genmod_details28.htm

gam_tweedie <- update(gam_poisson, family = tw())# tweedie distribution with p parameter estimated


```


# Gaussian
```{r}
par(mfrow = c(2, 2))
gam.check(gam_gaussian)
my.plot.gam(gam_gaussian)
```

#### Poisson
```{r}
par(mfrow = c(2, 2))
gam.check(gam_poisson)
my.plot.gam(gam_poisson)
```

##### Negative Binomial
```{r}
par(mfrow = c(2, 2))
gam.check(gam_nb)
my.plot.gam(gam_nb)
```

##### Tweedie 
```{r}
par(mfrow = c(2, 2))
gam.check(gam_tweedie)
my.plot.gam(gam_tweedie)
```



#### Compare GAMs in terms of AIC
```{r}
gam_fam_list <-list (gam_gaussian, gam_poisson, gam_nb, gam_tweedie)

aic_table <- AIC(gam_gaussian, gam_poisson, gam_nb, gam_tweedie) %>%
  arrange(AIC) %>%
  mutate(delta_AIC = AIC - min(AIC)) %>%
  rownames_to_column(var = "Family")

write_csv(aic_table, file = paste0(out_path, "/", "family_aic_table.csv"))

kable(aic_table, digits = 2, align = "l")

# index_best <- which(aic_table$AIC == min(aic_table$AIC))
# 
# # Out of GAMS with different family arguments, the best is...
# row.names(aic_table[index_best , ])
# gam_tp <- gam_fam_list[[index_best]] 
```

